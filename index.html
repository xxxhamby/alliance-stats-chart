<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Stat Comparison Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            /* Prevent body scroll */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }

        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }

        .table-header th {
            padding: 8px 12px;
            position: sticky;
            top: 0;
            background-color: #1f2937;
        }

        .table-row td {
            padding: 8px 12px;
            white-space: nowrap;
        }

        .btn {
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .input-field {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            padding: 6px 10px;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e40af;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 50;
        }

        .modal-content {
            z-index: 100;
        }
    </style>
</head>

<body class="flex flex-col h-screen p-4 md:p-6 space-y-4">

    <!-- Header -->
    <header class="text-center flex-shrink-0">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Alliance Stat Comparison</h1>
        <p id="db-status" class="text-sm text-gray-400 mt-2">Connecting to database...</p>
    </header>

    <!-- Instructions -->
    <div class="card p-3 rounded-lg shadow-md flex-shrink-0">
        <h3 class="text-md font-semibold text-center text-yellow-400 mb-2">Instructions for Stat Submission</h3>
        <ul class="text-xs text-gray-300 grid grid-cols-2 md:grid-cols-4 gap-x-4 text-center">
            <li><i class="fas fa-shield-alt mr-1 text-red-500"></i> **Rule 1:** NO BUFFS active.</li>
            <li><i class="fas fa-crosshairs mr-1 text-blue-500"></i> **Rule 2:** Test rally an alt with NO troops.</li>
            <li><i class="fas fa-user-friends mr-1 text-green-500"></i> **Rule 3:** Use 4 Chenkos w/ lvl 5 Stand of Arms.</li>
            <li><i class="fas fa-calendar-check mr-1 text-indigo-500"></i> **Rule 4:** Update at least once a week.</li>
        </ul>
    </div>

    <!-- Data Entry -->
    <div id="manual-entry" class="card p-4 rounded-lg shadow-lg flex-shrink-0">
        <form onsubmit="event.preventDefault(); handleSaveOrUpdate();">
            <div class="flex justify-between items-center mb-3">
                 <h2 class="text-lg font-semibold text-white">Manual Data Entry</h2>
                 <p class="text-xs text-gray-400 italic">Tip: Use the 'Tab' key to move through inputs in the correct order.</p>
            </div>
            <div class="flex gap-4 items-end mb-3">
                <div class="flex-grow">
                    <label for="playerName" class="block text-sm font-medium text-gray-300 mb-1">Player Name</label>
                    <input type="text" id="playerName" placeholder="Enter player name" required class="w-full rounded-md input-field">
                </div>
                <div class="flex items-end space-x-2 flex-shrink-0">
                    <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md btn">
                        <i class="fas fa-save mr-2"></i>Save Stats
                    </button>
                    <button type="button" id="cancel-edit-btn" onclick="cancelEdit()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md btn hidden">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6">
                <!-- Infantry -->
                <div class="space-y-2">
                    <h3 class="font-bold text-md text-center text-blue-400">Infantry (%)</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.01" id="infAttack" placeholder="Att" required class="w-full rounded-md input-field text-center" title="Infantry Attack">
                        <input type="number" step="0.01" id="infDefense" placeholder="Def" required class="w-full rounded-md input-field text-center" title="Infantry Defense">
                        <input type="number" step="0.01" id="infLethality" placeholder="Let" required class="w-full rounded-md input-field text-center" title="Infantry Lethality">
                        <input type="number" step="0.01" id="infHp" placeholder="HP" required class="w-full rounded-md input-field text-center" title="Infantry Health">
                    </div>
                </div>
                <!-- Cavalry -->
                <div class="space-y-2">
                    <h3 class="font-bold text-md text-center text-green-400">Cavalry (%)</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.01" id="cavAttack" placeholder="Att" required class="w-full rounded-md input-field text-center" title="Cavalry Attack">
                        <input type="number" step="0.01" id="cavDefense" placeholder="Def" required class="w-full rounded-md input-field text-center" title="Cavalry Defense">
                        <input type="number" step="0.01" id="cavLethality" placeholder="Let" required class="w-full rounded-md input-field text-center" title="Cavalry Lethality">
                        <input type="number" step="0.01" id="cavHp" placeholder="HP" required class="w-full rounded-md input-field text-center" title="Cavalry Health">
                    </div>
                </div>
                <!-- Archer -->
                <div class="space-y-2">
                    <h3 class="font-bold text-md text-center text-red-400">Archer (%)</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.01" id="arcAttack" placeholder="Att" required class="w-full rounded-md input-field text-center" title="Archer Attack">
                        <input type="number" step="0.01" id="arcDefense" placeholder="Def" required class="w-full rounded-md input-field text-center" title="Archer Defense">
                        <input type="number" step="0.01" id="arcLethality" placeholder="Let" required class="w-full rounded-md input-field text-center" title="Archer Lethality">
                        <input type="number" step="0.01" id="arcHp" placeholder="HP" required class="w-full rounded-md input-field text-center" title="Archer Health">
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Chart -->
    <div class="card p-4 rounded-lg shadow-lg flex-grow flex flex-col overflow-hidden">
        <div class="flex justify-between items-center mb-3 flex-shrink-0">
            <h2 class="text-xl font-semibold text-white">Alliance Comparison Chart</h2>
            <div class="flex items-center space-x-2">
                <button onclick="refreshChart()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-md btn text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
                <button onclick="cleanDuplicateData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md btn text-sm">
                    <i class="fas fa-broom mr-1"></i>Clean Duplicates
                </button>
            </div>
        </div>
        <div class="overflow-y-auto flex-grow">
            <table class="w-full text-left text-sm">
                <thead class="table-header text-xs text-gray-300 uppercase">
                    <tr>
                        <th class="cursor-pointer" onclick="sortStats('rank')">Rank</th>
                        <th class="cursor-pointer" onclick="sortStats('playerName')">Player</th>
                        <th class="cursor-pointer bg-blue-900/50" onclick="sortStats('infAttack')">Inf Att</th>
                        <th class="cursor-pointer bg-blue-900/50" onclick="sortStats('infDefense')">Inf Def</th>
                        <th class="cursor-pointer bg-blue-900/50" onclick="sortStats('infLethality')">Inf Let</th>
                        <th class="cursor-pointer bg-blue-900/50" onclick="sortStats('infHp')">Inf HP</th>
                        <th class="cursor-pointer bg-green-900/50" onclick="sortStats('cavAttack')">Cav Att</th>
                        <th class="cursor-pointer bg-green-900/50" onclick="sortStats('cavDefense')">Cav Def</th>
                        <th class="cursor-pointer bg-green-900/50" onclick="sortStats('cavLethality')">Cav Let</th>
                        <th class="cursor-pointer bg-green-900/50" onclick="sortStats('cavHp')">Cav HP</th>
                        <th class="cursor-pointer bg-red-900/50" onclick="sortStats('arcAttack')">Arc Att</th>
                        <th class="cursor-pointer bg-red-900/50" onclick="sortStats('arcDefense')">Arc Def</th>
                        <th class="cursor-pointer bg-red-900/50" onclick="sortStats('arcLethality')">Arc Let</th>
                        <th class="cursor-pointer bg-red-900/50" onclick="sortStats('arcHp')">Arc HP</th>
                        <th class="cursor-pointer" onclick="sortStats('totalScore')">Score ▼</th>
                        <th class="cursor-pointer" onclick="sortStats('date')">Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stats-table-body">
                    <!-- Rows will be injected by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>


    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md border border-gray-700">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-4">Confirm Action</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-md text-white font-semibold btn">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-white font-semibold btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- 🔑 PRODUCTION CONFIGURATION 🔑 ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.appspot.com",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b541ea0"
        };
        
        // --- GLOBAL VARIABLES & STATE ---
        let db;
        let auth;
        let userId = null;
        let appId = null;
        let currentStats = []; // Local cache of all stats from the database
        let currentSort = { column: 'totalScore', direction: 'desc' };
        let currentEditId = null; // Holds the doc ID of the stat being edited
        
        const dbStatus = document.getElementById('db-status');
        const playerNameInput = document.getElementById('playerName');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const modal = document.getElementById('custom-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        // --- INITIALIZATION ---
        const initFirebase = async () => {
            const firebaseConfig = USER_FIREBASE_CONFIG;
            appId = firebaseConfig.projectId;
            
            if (!firebaseConfig || !firebaseConfig.projectId) {
                dbStatus.textContent = '❌ Firebase configuration missing. Cannot connect.';
                dbStatus.className = 'text-sm text-red-400 mt-2';
                return; 
            }

            if (!getApps().length) {
                initializeApp(firebaseConfig);
            }

            db = getFirestore();
            auth = getAuth();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    dbStatus.textContent = `✅ Connected`; // SIMPLIFIED MESSAGE
                    dbStatus.className = 'text-sm text-green-400 mt-2';
                    setupRealtimeListener();
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        dbStatus.textContent = `❌ Anonymous sign-in failed. Check Firebase Auth settings.`;
                        dbStatus.className = 'text-sm text-red-400 mt-2';
                    });
                }
            });
        };
        
        // --- DATA MANAGEMENT ---
        const setupRealtimeListener = () => {
            if (!db || !appId) return;
            const collectionPath = `artifacts/${appId}/public/data/game_stats`;
            
            const q = collection(db, collectionPath);
            onSnapshot(q, (querySnapshot) => {
                currentStats = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const statEntry = {
                        id: doc.id,
                        playerName: data.playerName,
                        infAttack: data.infAttack, infDefense: data.infDefense, infLethality: data.infLethality, infHp: data.infHp,
                        cavAttack: data.cavAttack, cavDefense: data.cavDefense, cavLethality: data.cavLethality, cavHp: data.cavHp,
                        arcAttack: data.arcAttack, arcDefense: data.arcDefense, arcLethality: data.arcLethality, arcHp: data.arcHp,
                        date: data.date ? data.date.toDate() : new Date(),
                    };
                    statEntry.totalScore = calculateTotalScore(statEntry);
                    currentStats.push(statEntry);
                });
                sortAndRender();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                dbStatus.textContent = `❌ Error loading shared data: ${error.message}. Check Firestore Rules.`;
                dbStatus.className = 'text-sm text-red-400 mt-2';
            });
        };

        const getFormData = () => ({
            playerName: playerNameInput.value.trim(),
            infAttack: parseFloat(document.getElementById('infAttack').value) || 0,
            infDefense: parseFloat(document.getElementById('infDefense').value) || 0,
            infLethality: parseFloat(document.getElementById('infLethality').value) || 0,
            infHp: parseFloat(document.getElementById('infHp').value) || 0,
            cavAttack: parseFloat(document.getElementById('cavAttack').value) || 0,
            cavDefense: parseFloat(document.getElementById('cavDefense').value) || 0,
            cavLethality: parseFloat(document.getElementById('cavLethality').value) || 0,
            cavHp: parseFloat(document.getElementById('cavHp').value) || 0,
            arcAttack: parseFloat(document.getElementById('arcAttack').value) || 0,
            arcDefense: parseFloat(document.getElementById('arcDefense').value) || 0,
            arcLethality: parseFloat(document.getElementById('arcLethality').value) || 0,
            arcHp: parseFloat(document.getElementById('arcHp').value) || 0,
        });
        
        const resetForm = () => {
            document.querySelector('form').reset();
            currentEditId = null;
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Stats';
            cancelEditBtn.classList.add('hidden');
        };

        const saveNewStat = async (statData) => {
            if (!db) return;
            statData.date = serverTimestamp();
            const collectionPath = `artifacts/${appId}/public/data/game_stats`;
            await addDoc(collection(db, collectionPath), statData);
        };
        
        const updateStat = async (docId, statData) => {
            if (!db) return;
            statData.date = serverTimestamp();
            const collectionPath = `artifacts/${appId}/public/data/game_stats`;
            const docRef = doc(db, collectionPath, docId);
            await setDoc(docRef, statData);
        };

        // --- UI & INTERACTION ---
        
        const renderTable = () => {
            const tableBody = document.getElementById('stats-table-body');
            if (!tableBody) return;
            
            const rankedStats = currentStats.map((stat, index) => ({ ...stat, rank: index + 1 }));

            tableBody.innerHTML = rankedStats.map(stat => {
                const formattedDate = stat.date.toLocaleString([], { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '');
                return `
                    <tr class="table-row odd:bg-[#2d3748] even:bg-[#1f2937] hover:bg-gray-700">
                        <td>${stat.rank}</td>
                        <td class="font-semibold text-white">${stat.playerName}</td>
                        <td>${stat.infAttack}%</td>
                        <td>${stat.infDefense}%</td>
                        <td>${stat.infLethality}%</td>
                        <td>${stat.infHp}%</td>
                        <td>${stat.cavAttack}%</td>
                        <td>${stat.cavDefense}%</td>
                        <td>${stat.cavLethality}%</td>
                        <td>${stat.cavHp}%</td>
                        <td>${stat.arcAttack}%</td>
                        <td>${stat.arcDefense}%</td>
                        <td>${stat.arcLethality}%</td>
                        <td>${stat.arcHp}%</td>
                        <td class="font-bold text-yellow-400">${stat.totalScore.toLocaleString()}</td>
                        <td class="text-xs text-gray-400">${formattedDate}</td>
                        <td>
                             <button onclick="enterEditMode('${stat.id}')" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fas fa-pencil-alt"></i></button>
                             <button onclick="deleteStat('${stat.id}', '${stat.playerName}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        };
        
        const sortAndRender = () => {
             currentStats.sort((a, b) => {
                const valA = a[currentSort.column];
                const valB = b[currentSort.column];
                let comparison = 0;
                if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB);
                } else {
                    comparison = valA - valB;
                }
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
            renderTable();
        };

        const calculateTotalScore = (stats) => {
            const weights = {
                lethality: 1.2,
                hp: 1.1,
                attack: 1.0,
                defense: 1.0,
            };
            let total = 0;
            total += (stats.infAttack + stats.cavAttack + stats.arcAttack) * weights.attack;
            total += (stats.infDefense + stats.cavDefense + stats.arcDefense) * weights.defense;
            total += (stats.infLethality + stats.cavLethality + stats.arcLethality) * weights.lethality;
            total += (stats.infHp + stats.cavHp + stats.arcHp) * weights.hp;
            return Math.round(total);
        };
        
        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            return new Promise((resolve) => {
                modalConfirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                modalCancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };
            });
        };

        // --- EVENT HANDLER FUNCTIONS (ATTACHED TO WINDOW) ---
        window.handleSaveOrUpdate = async () => {
            const statData = getFormData();
            if (!statData.playerName) return;

            try {
                if (currentEditId) {
                    await updateStat(currentEditId, statData);
                } else {
                    await saveNewStat(statData);
                }
                resetForm();
            } catch (error) {
                console.error("Error saving data:", error);
                showModal('Error', `Failed to save data: ${error.message}`);
            }
        };

        window.enterEditMode = (docId) => {
            const statToEdit = currentStats.find(s => s.id === docId);
            if (!statToEdit) {
                console.error("Could not find stat with ID:", docId);
                return;
            }

            currentEditId = docId;
            playerNameInput.value = statToEdit.playerName;
            document.getElementById('infAttack').value = statToEdit.infAttack;
            document.getElementById('infDefense').value = statToEdit.infDefense;
            document.getElementById('infLethality').value = statToEdit.infLethality;
            document.getElementById('infHp').value = statToEdit.infHp;
            document.getElementById('cavAttack').value = statToEdit.cavAttack;
            document.getElementById('cavDefense').value = statToEdit.cavDefense;
            document.getElementById('cavLethality').value = statToEdit.cavLethality;
            document.getElementById('cavHp').value = statToEdit.cavHp;
            document.getElementById('arcAttack').value = statToEdit.arcAttack;
            document.getElementById('arcDefense').value = statToEdit.arcDefense;
            document.getElementById('arcLethality').value = statToEdit.arcLethality;
            document.getElementById('arcHp').value = statToEdit.arcHp;
            
            submitBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Update Stats';
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo(0, 0);
        };

        window.cancelEdit = () => {
            resetForm();
        };

        window.deleteStat = async (docId, playerName) => {
            const confirmed = await showModal('Confirm Deletion', `Are you sure you want to delete the entry for ${playerName}?`);
            if (confirmed) {
                try {
                    const collectionPath = `artifacts/${appId}/public/data/game_stats`;
                    await deleteDoc(doc(db, collectionPath, docId));
                } catch (error) {
                     console.error(`Error deleting doc ${docId}:`, error);
                     showModal('Error', `Failed to delete data: ${error.message}`);
                }
            }
        };

        window.cleanDuplicateData = async () => {
            const confirmed = await showModal('Confirm Cleanup', 'This will find all entries for the same player, keep only the newest one, and delete all older duplicates. Are you sure?');
            if (!confirmed) return;

            const playerStats = {};
            currentStats.forEach(stat => {
                if (!playerStats[stat.playerName]) {
                    playerStats[stat.playerName] = [];
                }
                playerStats[stat.playerName].push(stat);
            });

            const docsToDelete = [];
            for (const playerName in playerStats) {
                if (playerStats[playerName].length > 1) {
                    playerStats[playerName].sort((a, b) => b.date - a.date); // Sort newest first
                    const toDelete = playerStats[playerName].slice(1); // All except the newest
                    toDelete.forEach(stat => docsToDelete.push(stat.id));
                }
            }

            if (docsToDelete.length === 0) {
                showModal('Cleanup Complete', 'No duplicate entries were found.');
                return;
            }

            let deletedCount = 0;
            for (const docId of docsToDelete) {
                try {
                    const collectionPath = `artifacts/${appId}/public/data/game_stats`;
                    await deleteDoc(doc(db, collectionPath, docId));
                    deletedCount++;
                } catch (error) {
                    console.error(`Error deleting doc ${docId}:`, error);
                }
            }
            showModal('Cleanup Complete', `Successfully removed ${deletedCount} old/duplicate entries.`);
        };
        
        window.refreshChart = () => {
            sortAndRender();
        };
        
        window.sortStats = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = (column === 'playerName' || column === 'rank') ? 'asc' : 'desc';
            }
            sortAndRender();
        };

        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>

