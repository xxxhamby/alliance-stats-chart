<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 0.3rem; width: 100%; font-size: 0.875rem; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; outline: none; }
        .tier-card { cursor: pointer; background: #1e293b; border: 1px solid #334155; padding: 4px; text-align: center; border-radius: 4px; font-size: 10px; font-weight: bold; transition: all 0.1s; user-select: none; }
        .tier-card:hover { border-color: #64748b; }
        .tier-card.selected-tier { background: #1e3a8a; border-color: #60a5fa; color: white; }
        .tier-card.selected-tg { background: #422006; border-color: #eab308; color: #facc15; }
        .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: bold; font-size: 0.875rem; transition: all 0.2s; cursor: pointer; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { border-color: #eab308; color: #eab308; }
        .nav-link { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; color: #94a3b8; transition: all 0.2s; }
        .nav-link:hover { color: white; background: #1e293b; }
        .nav-link.active { color: white; background: #3b82f6; }
        .stat-delta { font-size: 0.65rem; margin-left: 2px; font-weight: bold; }
        .stat-table th { white-space: nowrap; padding: 8px; background: #1e293b; position: sticky; top: 0; z-index: 10; cursor: pointer; user-select: none; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #334155; }
        .stat-table td { white-space: nowrap; padding: 6px 8px; border-bottom: 1px solid #1e293b; font-size: 0.75rem; text-align: center; }
        .stat-table tr:hover { background-color: #1e293b; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="app-root" class="min-h-screen flex flex-col"></div>
    <div id="modal-root" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit, where, startAt, endAt, getCountFromServer, addDoc, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.firebasestorage.app",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b_541ea0"
        };

        const State = {
            user: null, dbUser: null,
            profile: null, alliance: null,
            data: { global: [], alliance: [], roster: [], freelancers: [], history: [], invites: [], logs: [] },
            stats: { totalProfiles: 0 },
            selection: new Set(),
            current: 'loading',
            lastView: null,
            previousView: null,
            viewMode: 'global',
            managerTab: 'main', 
            filters: { ign: '', kingdom: '' },
            sort: { field: 'trueScore', dir: 'desc' }, 
            config: { lockdown: false, accessCode: '' },
            listeners: { security: null, invites: null },
            editorTarget: null,
            form: {
                ign: '', kingdom: '', pid: '',
                privacy: { hideName: false, hideStats: false },
                troops: { inf: { tier: 10, tg: 0 }, cav: { tier: 10, tg: 0 }, arc: { tier: 10, tg: 0 } },
                stats: { inf: { att:0,def:0,let:0,hp:0 }, cav: { att:0,def:0,let:0,hp:0 }, arc: { att:0,def:0,let:0,hp:0 } }
            }
        };

        const App = {
            db: null, auth: null, chartInstance: null,

            init: () => {
                const app = initializeApp(CONFIG);
                App.db = getFirestore(app);
                App.auth = getAuth(app);
                onAuthStateChanged(App.auth, App.handleAuth);
            },

            handleAuth: async (user) => {
                State.user = user;
                if (!user) {
                    State.current = localStorage.getItem('acc_gate_token') ? 'login' : 'gate';
                } else {
                    try {
                        const userSnap = await getDoc(doc(App.db, 'users', user.uid));
                        if (userSnap.exists()) State.dbUser = userSnap.data();
                        else await setDoc(doc(App.db, 'users', user.uid), { email: user.email, role: 'member', createdAt: serverTimestamp() });

                        const profileSnap = await getDoc(doc(App.db, 'profiles', user.uid));
                        
                        if (!State.listeners.security) {
                            State.listeners.security = onSnapshot(doc(App.db, 'metadata', 'security'), (snap) => {
                                if(snap.exists()) { State.config = snap.data(); App.render(); }
                            });
                        }
                        if (!State.listeners.invites) {
                            State.listeners.invites = onSnapshot(collection(doc(App.db, 'profiles', user.uid), 'invites'), (snap) => {
                                State.data.invites = snap.docs.map(d => ({id: d.id, ...d.data()}));
                                App.render();
                            });
                        }

                        if (!profileSnap.exists()) {
                            State.current = 'register';
                            State.form = { ign: '', kingdom: '', pid: '', privacy: {hideName: false, hideStats: false}, troops: { inf: {tier:10, tg:0}, cav: {tier:10, tg:0}, arc: {tier:10, tg:0} }, stats: { inf: { att:0,def:0,let:0,hp:0 }, cav: { att:0,def:0,let:0,hp:0 }, arc: { att:0,def:0,let:0,hp:0 } } };
                        } else {
                            State.profile = profileSnap.data();
                            if (State.profile.allianceID) {
                                const allySnap = await getDoc(doc(App.db, 'alliances', State.profile.allianceID));
                                if (allySnap.exists()) State.alliance = { id: allySnap.id, ...allySnap.data() };
                            }
                            
                            if (State.profile.allianceID) {
                                State.current = 'view_alliance';
                                State.viewMode = 'alliance';
                                State.previousView = 'view_alliance';
                                await App.actions.loadRoster();
                            } else {
                                State.current = 'view_global';
                                State.viewMode = 'global';
                                State.previousView = 'view_global';
                                await App.actions.loadLeaderboard();
                            }
                            App.actions.loadPersonalHistory();
                        }
                    } catch (e) { console.error("Boot Error", e); }
                }
                App.render();
            },

            render: () => {
                if (State.current === State.lastView && !['view_global', 'view_alliance'].includes(State.current)) return;

                const allianceBtnText = State.profile?.allianceID ? 'My Alliance' : 'Join Alliance';
                const inviteBadge = State.data.invites.length > 0 ? `<span class="bg-red-500 text-white text-[10px] px-1.5 rounded-full ml-2 animate-pulse">${State.data.invites.length}</span>` : '';
                
                const lockdownBanner = State.config.lockdown 
                    ? `<div class="bg-red-600 text-white text-center text-xs font-bold py-1 tracking-widest"><i class="fas fa-lock mr-2"></i>GLOBAL LOCKDOWN ACTIVE - EDITS DISABLED</div>` 
                    : '';

                const footer = `
                    <footer class="p-4 text-center text-xs text-slate-500 mt-auto border-t border-slate-800">
                        <a href="https://ko-fi.com/logoutgg" target="_blank" class="hover:text-yellow-400 transition flex items-center justify-center gap-2">
                            <i class="fas fa-coffee"></i> Support the project on Ko-fi
                        </a>
                    </footer>`;

                const navBar = `
                    ${lockdownBanner}
                    <nav class="bg-slate-800 border-b border-slate-700 p-3 sticky top-0 z-20 shadow-md">
                        <div class="max-w-7xl mx-auto flex justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="window.navTo('view_global')" class="nav-link ${State.current === 'view_global' ? 'active' : ''}"><i class="fas fa-globe mr-2"></i>Global</button>
                                <button onclick="window.navTo('view_alliance')" class="nav-link ${State.current === 'view_alliance' ? 'active' : ''}"><i class="fas fa-users mr-2"></i>${allianceBtnText} ${inviteBadge}</button>
                            </div>
                            <div class="flex gap-3 items-center">
                                ${State.dbUser?.role === 'owner' ? `<button onclick="window.openOwner()" class="text-red-500 hover:text-white" title="God Mode"><i class="fas fa-shield-alt"></i></button>` : ''}
                                <button onclick="window.showHelp()" class="text-yellow-400 hover:text-white" title="Help"><i class="fas fa-question-circle"></i></button>
                                <div class="flex items-center gap-2 border-l border-slate-600 pl-3">
                                    <img src="${State.user?.photoURL || ''}" class="w-6 h-6 rounded-full border border-slate-500">
                                    <span class="text-sm font-bold text-white hidden md:block">${State.profile?.ign}</span>
                                </div>
                                <button onclick="window.openEditor()" class="text-blue-400 hover:text-white" title="Edit Profile"><i class="fas fa-cog"></i></button>
                                <button onclick="window.triggerLogout()" class="text-red-500 hover:text-white ml-2" title="Logout"><i class="fas fa-power-off"></i></button>
                            </div>
                        </div>
                    </nav>`;

                const growthChart = `
                    <div class="bg-slate-900 rounded border border-slate-700 mt-6 p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-white text-sm"><i class="fas fa-chart-line text-green-500 mr-2"></i>Growth History</h3>
                            <button type="button" onclick="window.openHistory()" class="text-xs text-slate-400 hover:text-white">Full Log</button>
                        </div>
                        <div class="h-40">
                            <canvas id="growth-chart"></canvas>
                        </div>
                    </div>
                `;

                const views = {
                    loading: `<div class="flex flex-col items-center justify-center h-screen bg-slate-900 text-white"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i><h2 class="font-bold tracking-widest">LOADING...</h2></div>`,
                    
                    gate: `<div class="flex flex-col items-center justify-center h-screen bg-slate-900 p-6"><div class="bg-slate-800 p-8 rounded-lg border-t-4 border-red-500 max-w-md w-full text-center shadow-2xl"><i class="fas fa-dungeon text-5xl text-red-500 mb-4"></i><h1 class="text-2xl font-bold text-white mb-2">Restricted Access</h1><p class="text-slate-400 text-xs mb-4">This system is protected. Enter the global access code.</p><form onsubmit="event.preventDefault(); window.submitGate()"><input type="password" id="gate-input" class="input-field text-center text-xl tracking-[0.5em] font-mono mb-4" placeholder="•••••"><button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow-lg">AUTHORIZE</button></form></div></div>`,
                    
                    login: `<div class="flex flex-col items-center justify-center h-screen bg-slate-900 p-4"><div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-sm w-full text-center border-t-4 border-blue-500"><h1 class="text-2xl font-bold text-white mb-2">Alliance Command</h1><button onclick="window.triggerLogin()" class="w-full bg-white hover:bg-gray-100 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-2 mt-6"><i class="fab fa-google text-red-500"></i> Sign in</button></div></div>`,
                    
                    register: `<div class="min-h-screen bg-slate-900 p-4 flex justify-center"><div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-lg w-full h-fit border-t-4 border-yellow-500"><h2 class="text-xl font-bold text-white mb-4">Initial Setup</h2>${App.ui.editorForm('Register')}</div></div>`,
                    
                    editor: `
                        <div class="min-h-screen bg-slate-900 p-4 flex justify-center">
                            <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-lg w-full h-fit border-t-4 border-blue-500">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-white">${State.editorTarget ? 'Admin Edit: ' + State.form.ign : 'Update Profile'}</h2>
                                    <button onclick="window.cancelEdit()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
                                </div>
                                ${App.ui.editorForm('Save Changes')}
                                ${!State.editorTarget ? `
                                <div class="mt-4 border-t border-slate-700 pt-4">
                                    ${growthChart}
                                </div>` : ''}
                            </div>
                        </div>`,
                    
                    owner: `<div class="min-h-screen bg-slate-900 p-6"><header class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold text-red-500 uppercase tracking-widest"><i class="fas fa-crown mr-3"></i>God Mode</h1><button onclick="window.cancelEdit()" class="text-slate-400 hover:text-white">Exit</button></header><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-slate-800 p-6 rounded border-l-4 border-red-500"><h3 class="text-xl font-bold text-white mb-4">Security Override</h3><div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Current Gate Code</label><div id="owner-global-code" class="text-3xl font-mono text-yellow-400 tracking-widest mt-1">${State.config.accessCode || '...'}</div></div><button onclick="window.ownerRotateCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded mb-6"><i class="fas fa-random mr-2"></i>Generate Random Code</button><div class="border-t border-slate-700 pt-4"><label class="text-xs text-slate-400 uppercase font-bold mb-2 block">Emergency Protocol</label><button onclick="window.ownerToggleLockdown()" class="w-full py-3 rounded font-bold transition ${State.config.lockdown ? 'bg-red-600 animate-pulse text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">${State.config.lockdown ? '⚠️ LOCKDOWN ACTIVE (UNLOCK)' : 'ACTIVATE LOCKDOWN'}</button></div></div><div class="bg-slate-800 p-6 rounded border-l-4 border-blue-500"><h3 class="text-xl font-bold text-white mb-4">Database Intelligence</h3><div class="text-4xl font-bold text-white" id="stat-count">${State.stats.totalProfiles}</div><div class="text-sm text-slate-400 mb-4">Active Profiles</div></div></div></div>`,
                    
                    allianceManager: `<div class="min-h-screen bg-slate-900 p-6"><header class="flex justify-between items-center mb-6"><div><h1 class="text-2xl font-bold text-yellow-500 uppercase tracking-widest"><i class="fas fa-users-cog mr-3"></i>Alliance Manager</h1><p class="text-sm text-slate-400">Managing: <span class="text-white font-bold">[${State.alliance?.tag || '...'}] ${State.alliance?.name || 'Loading...'}</span></p></div><div class="flex gap-2">${State.dbUser?.role === 'owner' ? `<button onclick="window.openOwner()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded font-bold text-sm shadow-lg animate-pulse" title="Admin Panel"><i class="fas fa-user-shield"></i></button>` : ''}<button onclick="window.cancelEdit()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button></div></header><div class="flex border-b border-slate-700 mb-6"><button onclick="window.switchManagerTab('main')" class="tab-btn ${State.managerTab === 'main' ? 'active' : ''}">Command</button><button onclick="window.switchManagerTab('audit')" class="tab-btn ${State.managerTab === 'audit' ? 'active' : ''}">Audit Log</button></div><div id="manager-content">${State.managerTab === 'main' ? App.ui.managerMain() : App.ui.managerAudit()}</div></div>`,

                    view_global: `
                        <div class="min-h-screen bg-slate-900 text-slate-200">
                            ${navBar}
                            <div class="p-4 max-w-7xl mx-auto">
                                <div class="bg-slate-800 rounded shadow border border-slate-700">
                                    <div class="p-4 border-b border-slate-700 bg-slate-900 flex flex-col md:flex-row gap-4 items-center">
                                        <div class="text-white font-bold text-lg"><i class="fas fa-globe-americas text-blue-500 mr-2"></i>Global Rankings</div>
                                        <div class="flex-grow w-full md:w-auto relative"><i class="fas fa-search absolute left-3 top-3 text-slate-500"></i><input type="text" name="search-ign" oninput="window.handleSearch(this.value)" placeholder="Search Commander..." class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full pl-10 p-2.5 outline-none focus:border-blue-500"></div>
                                        <div class="flex gap-2 w-full md:w-auto"><div class="relative w-24"><input type="text" name="search-kingdom" id="filter-kingdom" oninput="window.handleKingdom(this.value)" placeholder="K#" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5 outline-none focus:border-blue-500 text-center"><button onclick="window.clearKingdom()" class="absolute right-2 top-2 text-slate-500 hover:text-white">&times;</button></div><button onclick="window.refreshData()" class="text-blue-400 hover:text-white px-3"><i class="fas fa-sync"></i></button></div>
                                        <button onclick="window.compareSelected()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-chart-bar mr-1"></i> Compare (<span id="compare-count">0</span>)</button>
                                    </div>
                                    <div class="overflow-x-auto"><table class="w-full stat-table"><thead class="bg-slate-900 text-slate-400"><tr><th class="pl-2 w-8"><input type="checkbox" onchange="window.toggleSelectAll(this)"></th><th onclick="window.setSort('ign')" class="text-left pl-3">Commander</th><th onclick="window.setSort('kingdom')">K#</th><th onclick="window.setSort('allianceID')">Alli</th><th class="text-blue-400" onclick="window.setSort('stats.inf.att')">I.Att</th><th class="text-blue-400" onclick="window.setSort('stats.inf.def')">I.Def</th><th class="text-blue-400" onclick="window.setSort('stats.inf.let')">I.Let</th><th class="text-blue-400" onclick="window.setSort('stats.inf.hp')">I.HP</th><th class="text-green-400" onclick="window.setSort('stats.cav.att')">C.Att</th><th class="text-green-400" onclick="window.setSort('stats.cav.def')">C.Def</th><th class="text-green-400" onclick="window.setSort('stats.cav.let')">C.Let</th><th class="text-green-400" onclick="window.setSort('stats.cav.hp')">C.HP</th><th class="text-red-400" onclick="window.setSort('stats.arc.att')">A.Att</th><th class="text-red-400" onclick="window.setSort('stats.arc.def')">A.Def</th><th class="text-red-400" onclick="window.setSort('stats.arc.let')">A.Let</th><th class="text-red-400" onclick="window.setSort('stats.arc.hp')">A.HP</th><th class="text-yellow-400" onclick="window.setSort('trueScore')">Score ▼</th><th>Updated</th></tr></thead><tbody id="global-body" class="divide-y divide-slate-800">${App.ui.renderRows(State.data.global)}</tbody></table></div>
                                </div>
                            </div>
                            ${footer}
                        </div>`,

                    view_alliance: `
                        <div class="min-h-screen bg-slate-900 text-slate-200">
                            ${navBar}
                            <div class="p-4 max-w-7xl mx-auto">
                                ${App.ui.allianceCard()}
                                ${State.profile?.allianceID ? `
                                <div class="bg-slate-800 rounded shadow border border-slate-700 mt-6">
                                    <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-center">
                                        <div class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-users text-yellow-500"></i>Alliance Roster</div>
                                        <div class="flex gap-2">
                                            <button onclick="window.openAllianceAnalytics()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded text-xs font-bold"><i class="fas fa-chart-pie mr-1"></i> Analytics</button>
                                            <button onclick="window.compareSelected()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-chart-bar mr-1"></i> Compare (<span id="compare-count">0</span>)</button>
                                            <button onclick="window.refreshData()" class="text-blue-400 hover:text-white px-3"><i class="fas fa-sync"></i></button>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto"><table class="w-full stat-table"><thead class="bg-slate-900 text-slate-400"><tr><th class="pl-2 w-8"><input type="checkbox" onchange="window.toggleSelectAll(this)"></th><th onclick="window.setSort('ign')" class="text-left pl-3">Commander</th><th onclick="window.setSort('kingdom')">K#</th><th class="text-blue-400" onclick="window.setSort('stats.inf.att')">I.Att</th><th class="text-blue-400" onclick="window.setSort('stats.inf.def')">I.Def</th><th class="text-blue-400" onclick="window.setSort('stats.inf.let')">I.Let</th><th class="text-blue-400" onclick="window.setSort('stats.inf.hp')">I.HP</th><th class="text-green-400" onclick="window.setSort('stats.cav.att')">C.Att</th><th class="text-green-400" onclick="window.setSort('stats.cav.def')">C.Def</th><th class="text-green-400" onclick="window.setSort('stats.cav.let')">C.Let</th><th class="text-green-400" onclick="window.setSort('stats.cav.hp')">C.HP</th><th class="text-red-400" onclick="window.setSort('stats.arc.att')">A.Att</th><th class="text-red-400" onclick="window.setSort('stats.arc.def')">A.Def</th><th class="text-red-400" onclick="window.setSort('stats.arc.let')">A.Let</th><th class="text-red-400" onclick="window.setSort('stats.arc.hp')">A.HP</th><th class="text-yellow-400" onclick="window.setSort('trueScore')">Score ▼</th><th>Updated</th></tr></thead><tbody id="alliance-body" class="divide-y divide-slate-800">${App.ui.renderRows(State.data.roster)}</tbody></table></div>
                                </div>` : ''}
                            </div>
                            ${footer}
                        </div>`
                };

                if (!State.alliance && State.current === 'allianceManager') {
                    document.getElementById('app-root').innerHTML = views['loading'];
                } else {
                    document.getElementById('app-root').innerHTML = views[State.current];
                }
                
                State.lastView = State.current;

                if (State.current === 'register' || State.current === 'editor') App.ui.initEditor();
                if (State.current === 'editor' && !State.editorTarget) App.ui.renderGrowthChart();
                if (State.current === 'owner') App.actions.initOwnerView();
                if (State.current === 'allianceManager') {
                    App.actions.loadRoster(); // Unified Load
                    App.actions.loadAuditLogs();
                }
            },

            renderTableOnly: () => {
                if (State.current === 'view_global') {
                    const tbody = document.getElementById('global-body');
                    if(tbody) tbody.innerHTML = App.ui.renderRows(State.data.global);
                } else if (State.current === 'view_alliance') {
                    const tbody = document.getElementById('alliance-body');
                    if(tbody) tbody.innerHTML = App.ui.renderRows(State.data.roster);
                } else if (State.current === 'allianceManager') {
                    if (State.managerTab === 'main') {
                        const tbody = document.getElementById('roster-body');
                        if(tbody) tbody.innerHTML = App.ui.generateManagerRosterRows(State.data.roster);
                    } else if (State.managerTab === 'audit') {
                        const tbody = document.getElementById('audit-body');
                        if(tbody) tbody.innerHTML = App.ui.generateAuditRows(State.data.logs);
                    }
                }
            },

            ui: {
                toast: (msg, type = 'info') => {
                    const el = document.createElement('div');
                    el.className = `bg-slate-800 text-white py-2 px-4 rounded shadow-lg border-l-4 ${type === 'error' ? 'border-red-500' : 'border-green-500'} animate-fade-in`;
                    el.innerText = msg;
                    document.getElementById('toast-container').appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                },

                generateManagerRosterRows: (rosterData) => {
                    return rosterData.map(m => {
                        const isLeader = m.id === State.user.uid;
                        const role = State.dbUser?.role;
                        const isManager = role === 'manager' || role === 'owner' || role === 'leader';
                        const escapedIgn = m.ign.replace(/'/g, "\\'");
                        
                        // NEW LOGIC FOR PROMOTE/DEMOTE
                        let actionBtn = '';
                        // Identify role of target based on data or default to member
                        // NOTE: In a real app we'd fetch target user roles, here we rely on context or assume member
                        // For simplicity in this structure: 
                        // If I am Leader, I can Kick anyone (except myself) and Promote/Demote
                        // Ideally we need the target's role. Since we don't have it in 'profiles', we assume 'member' for now unless we fetch 'users'.
                        // IMPROVEMENT: Fetching roles is expensive. 
                        // COMPROMISE: Show both buttons for Leader.
                        
                        if (isLeader) actionBtn = '<span class="text-xs text-green-500 font-bold">LEADER</span>';
                        else if (isManager) {
                            actionBtn = `
                                <button onclick="event.stopPropagation(); window.kickMember('${m.id}', '${escapedIgn}')" class="text-red-400 hover:text-red-300 text-xs font-bold border border-red-900 bg-red-900/20 px-2 py-1 rounded">KICK</button>
                                ${role === 'leader' || role === 'owner' ? `
                                <button onclick="event.stopPropagation(); window.promoteMember('${m.id}', 'manager')" class="text-blue-400 hover:text-blue-300 text-xs font-bold border border-blue-900 bg-blue-900/20 px-2 py-1 rounded ml-1">PROMOTE</button>
                                <button onclick="event.stopPropagation(); window.demoteMember('${m.id}')" class="text-yellow-400 hover:text-yellow-300 text-xs font-bold border border-yellow-900 bg-yellow-900/20 px-2 py-1 rounded ml-1">DEMOTE</button>
                                ` : ''}
                            `;
                        }
                        
                        return `
                        <tr class="hover:bg-slate-700 cursor-pointer" onclick="window.viewProfile('${m.id}')">
                            <td class="p-3 font-bold text-white">${m.ign} <span class="text-slate-500 text-xs font-mono">#${m.pid}</span></td>
                            <td class="p-3 text-slate-300">${m.kingdom}</td>
                            <td class="p-3 text-yellow-400 font-bold">${Math.round(m.trueScore||0).toLocaleString()}</td>
                            <td class="p-3 text-right">${actionBtn}</td>
                        </tr>`;
                    }).join('');
                },

                generateAuditRows: (logsData) => {
                    if (!logsData || logsData.length === 0) return '<tr><td colspan="4" class="p-4 text-center text-slate-500">No logs found.</td></tr>';
                    return logsData.map(l => `
                        <tr class="border-b border-slate-700 hover:bg-slate-800">
                            <td class="p-3 text-slate-400 text-xs">${l.timestamp ? new Date(l.timestamp.toDate()).toLocaleString() : '-'}</td>
                            <td class="p-3 text-white font-bold text-sm">${l.action}</td>
                            <td class="p-3 text-slate-300 text-xs">${l.details}</td>
                        </tr>`).join('');
                },

                managerMain: () => {
                    return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="space-y-6">
                            <div class="bg-slate-800 p-6 rounded border-l-4 border-yellow-500">
                                <h3 class="font-bold text-white mb-4">Settings</h3>
                                <div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Alliance Name</label><input type="text" name="alliance-name" id="set-name" class="input-field" value="${State.alliance?.name}"></div>
                                <div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Description</label><textarea name="alliance-desc" id="set-desc" class="input-field h-24" placeholder="MOTD...">${State.alliance?.description || ''}</textarea></div>
                                <button onclick="window.updateAlliance()" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded w-full">Save Changes</button>
                            </div>
                            <div class="bg-slate-800 p-6 rounded border-l-4 border-blue-500">
                                <h3 class="font-bold text-white mb-2">Access Control</h3>
                                <div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Invite Code</label><div class="text-2xl font-mono text-white bg-slate-900 p-2 rounded text-center tracking-widest">${State.alliance?.accessCode}</div></div>
                                <button onclick="window.rotateAllianceCode()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 rounded text-sm"><i class="fas fa-sync-alt mr-2"></i>Rotate Code</button>
                            </div>
                            <div class="bg-slate-800 p-6 rounded border-l-4 border-red-600">
                                <h3 class="font-bold text-red-500 mb-2">Danger Zone</h3>
                                <button onclick="window.deleteAlliance()" class="w-full bg-red-900/50 border border-red-600 hover:bg-red-600 text-red-100 font-bold py-2 rounded text-sm">Delete Alliance</button>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-2 bg-slate-800 rounded shadow overflow-hidden h-fit">
                            <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-center">
                                <h3 class="font-bold text-white">Roster (${State.data.roster.length})</h3>
                                <div class="flex gap-2">
                                    <span class="text-xs text-slate-500 mt-1">Limit: 100</span>
                                    <button onclick="window.exportRosterCSV()" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1 rounded"><i class="fas fa-file-csv mr-1"></i> Export CSV</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto h-[600px] overflow-y-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900 text-slate-400 uppercase text-[10px] sticky top-0">
                                        <tr><th class="p-3">Commander</th><th class="p-3">Kingdom</th><th class="p-3">True Score</th><th class="p-3 text-right">Actions</th></tr>
                                    </thead>
                                    <tbody id="roster-body" class="divide-y divide-slate-700">
                                        ${App.ui.generateManagerRosterRows(State.data.roster)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                },

                managerAudit: () => {
                    return `
                    <div class="bg-slate-800 rounded shadow overflow-hidden">
                        <div class="p-4 border-b border-slate-700 bg-slate-900">
                            <h3 class="font-bold text-white">Audit Log</h3>
                            <p class="text-xs text-slate-400">History of alliance actions.</p>
                        </div>
                        <div class="overflow-x-auto h-96 overflow-y-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900 text-slate-400 uppercase text-[10px] sticky top-0">
                                    <tr>
                                        <th class="p-3">Time</th>
                                        <th class="p-3">Action</th>
                                        <th class="p-3">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-body" class="divide-y divide-slate-700">
                                    ${App.ui.generateAuditRows(State.data.logs)}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                },

                editorForm: (btnText) => {
                    return `
                    <form onsubmit="event.preventDefault(); window.saveProfile()">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="col-span-2"><label class="text-[10px] text-slate-400 uppercase font-bold">In-Game Name</label><input type="text" id="frm-ign" name="ign" class="input-field" required value="${State.form.ign}"></div>
                            <div><label class="text-[10px] text-slate-400 uppercase font-bold">Kingdom #</label><input type="number" id="frm-kingdom" name="kingdom" class="input-field" required value="${State.form.kingdom}"></div>
                            <div><label class="text-[10px] text-slate-400 uppercase font-bold">Player ID (Max 9)</label><input type="number" id="frm-pid" name="pid" class="input-field" required value="${State.form.pid}"></div>
                        </div>
                        <div class="bg-slate-900 p-3 rounded border border-slate-700 mb-4 flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="frm-hideName" name="hideName" class="form-checkbox text-blue-600 rounded bg-slate-700 border-slate-600" ${State.form.privacy?.hideName ? 'checked' : ''}><span class="text-xs text-slate-300">Hide Name</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="frm-hideStats" name="hideStats" class="form-checkbox text-blue-600 rounded bg-slate-700 border-slate-600" ${State.form.privacy?.hideStats ? 'checked' : ''}><span class="text-xs text-slate-300">Hide Stats</span></label>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            ${App.ui.statRow('inf', 'Infantry', 'text-blue-400')}
                            ${App.ui.statRow('cav', 'Cavalry', 'text-green-400')}
                            ${App.ui.statRow('arc', 'Archer', 'text-red-400')}
                        </div>

                        <div class="space-y-3 mb-6">
                            ${App.ui.troopRow('inf', 'Infantry', 'text-blue-400')}
                            ${App.ui.troopRow('cav', 'Cavalry', 'text-green-400')}
                            ${App.ui.troopRow('arc', 'Archer', 'text-red-400')}
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded transition">${btnText}</button>
                    </form>`;
                },

                statRow: (type, label, color) => {
                    return `
                    <div class="bg-slate-900 p-2 rounded border border-slate-700">
                        <div class="grid grid-cols-5 gap-2 items-center">
                            <div class="text-[10px] font-bold ${color} uppercase text-right pr-2">${label}</div>
                            <input type="number" id="${type}_att" name="${type}_att" step="0.1" min="0" onkeydown="window.handleEnter(event)" onchange="window.handleStatChange('${type}','att',this)" placeholder="ATT" class="input-field text-center" value="${State.form.stats[type].att||''}">
                            <input type="number" id="${type}_def" name="${type}_def" step="0.1" min="0" onkeydown="window.handleEnter(event)" onchange="window.handleStatChange('${type}','def',this)" placeholder="DEF" class="input-field text-center" value="${State.form.stats[type].def||''}">
                            <input type="number" id="${type}_let" name="${type}_let" step="0.1" min="0" onkeydown="window.handleEnter(event)" onchange="window.handleStatChange('${type}','let',this)" placeholder="LET" class="input-field text-center" value="${State.form.stats[type].let||''}">
                            <input type="number" id="${type}_hp" name="${type}_hp" step="0.1" min="0" onkeydown="${type==='arc'?'':'window.handleEnter(event)'}" onchange="window.handleStatChange('${type}','hp',this)" placeholder="HP" class="input-field text-center" value="${State.form.stats[type].hp||''}">
                        </div>
                    </div>`;
                },

                troopRow: (type, label, colorClass) => {
                    return `
                    <div class="bg-slate-900 p-2 rounded border border-slate-700">
                        <div class="text-[9px] uppercase font-bold ${colorClass} mb-1 flex justify-between"><span>${label} Tier</span><span id="display-${type}" class="text-white">T10</span></div>
                        <div class="grid grid-cols-4 gap-1 mb-1">${[8,9,10,11].map(t => `<div class="tier-card" data-group="${type}-tier" data-val="${t}" onclick="window.setTroop('${type}','tier',${t})">T${t}</div>`).join('')}</div>
                        <div class="grid grid-cols-6 gap-1">${[0,1,2,3,4,5].map(g => `<div class="tier-card" data-group="${type}-tg" data-val="${g}" onclick="window.setTroop('${type}','tg',${g})">${g===0?'--':'TG'+g}</div>`).join('')}</div>
                    </div>`;
                },
                
                initEditor: () => { ['inf', 'cav', 'arc'].forEach(t => { window.setTroop(t, 'tier', State.form.troops[t].tier, false); window.setTroop(t, 'tg', State.form.troops[t].tg, false); }); },

                renderGrowthChart: () => {
                    const ctx = document.getElementById('growth-chart');
                    if (!ctx || !State.data.history || State.data.history.length === 0) return;
                    
                    const data = [...State.data.history].reverse();
                    if(App.chartInstance) App.chartInstance.destroy();

                    App.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(h => new Date(h.date.toDate()).toLocaleDateString()),
                            datasets: [{
                                label: 'True Score',
                                data: data.map(h => h.trueScore),
                                borderColor: '#eab308',
                                backgroundColor: 'rgba(234, 179, 8, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: '#94a3b8', maxTicksLimit: 5 }, grid: { display: false } },
                                y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                            }
                        }
                    });
                },
                
                renderRows: (dataset) => {
                    if (!dataset || dataset.length === 0) return `<tr><td colspan="17" class="p-4 text-center text-slate-500">No Commanders Found</td></tr>`;
                    
                    const sorted = [...dataset].sort((a,b) => {
                        const valA = getValue(a, State.sort.field) || 0;
                        const valB = getValue(b, State.sort.field) || 0;
                        return State.sort.dir === 'asc' ? valA - valB : valB - valA;
                    });

                    function getValue(obj, path) {
                        return path.split('.').reduce((o, i) => o?.[i], obj);
                    }

                    const getDelta = (val, old) => {
                        if (old === undefined || old === null) return '';
                        const diff = (val - old).toFixed(1);
                        if (diff == 0) return '';
                        const color = diff > 0 ? 'text-green-400' : 'text-red-400';
                        return `<sup class="${color} stat-delta">${diff > 0 ? '+' : ''}${diff}</sup>`;
                    };

                    return sorted.map(p => {
                        const isMe = State.user.uid === p.id;
                        const sameAlliance = State.alliance && p.allianceID === State.alliance.id;
                        const isAdmin = State.dbUser?.role === 'owner';
                        const isHidden = (p.privacy?.hideName || p.privacy?.hideStats) && !isMe && !sameAlliance && !isAdmin;
                        
                        const displayName = (p.privacy?.hideName && !isMe && !sameAlliance && !isAdmin) ? `<span class="italic text-slate-500">Classified</span>` : p.ign;
                        const s = p.stats || {inf:{att:0,def:0,let:0,hp:0},cav:{att:0,def:0,let:0,hp:0},arc:{att:0,def:0,let:0,hp:0}};
                        const prev = p.previousStats || {};
                        const dateStr = p.updatedAt ? new Date(p.updatedAt.toDate()).toLocaleDateString() : '-';
                        
                        const isSelected = State.selection.has(p.id) ? 'checked' : '';
                        
                        const cell = (path, val) => {
                            if(isHidden) return '<td class="text-slate-500">?</td>';
                            const oldVal = getValue(prev, path);
                            return `<td class="text-slate-300">${val}${getDelta(val, oldVal)}</td>`;
                        };
                        
                        const hasEditAuth = isMe || isAdmin || (State.dbUser?.role === 'manager' && sameAlliance);
                        const editBtn = hasEditAuth ? `<button onclick="event.stopPropagation(); window.editPlayer('${p.id}')" class="text-blue-500 hover:text-white ml-2" title="Edit"><i class="fas fa-pencil-alt text-xs"></i></button>` : '';

                        const allianceCol = State.current === 'view_global' 
                            ? `<td class="text-slate-300">${p.allianceID ? 'Yes' : '-'}</td>` 
                            : '';

                        return `
                        <tr class="hover:bg-slate-800 transition cursor-pointer border-b border-slate-800" onclick="window.viewProfile('${p.id}')">
                            <td onclick="event.stopPropagation()" class="pl-2"><input type="checkbox" class="ml-2 accent-blue-500" ${isSelected} onchange="window.toggleSelection('${p.id}')"></td>
                            <td class="text-white font-bold text-left pl-3 py-2 text-xs flex items-center">${displayName} ${editBtn}</td>
                            <td class="text-slate-300">${p.kingdom}</td>
                            ${allianceCol}
                            ${cell('inf.att', s.inf.att)} ${cell('inf.def', s.inf.def)} ${cell('inf.let', s.inf.let)} ${cell('inf.hp', s.inf.hp)}
                            ${cell('cav.att', s.cav.att)} ${cell('cav.def', s.cav.def)} ${cell('cav.let', s.cav.let)} ${cell('cav.hp', s.cav.hp)}
                            ${cell('arc.att', s.arc.att)} ${cell('arc.def', s.arc.def)} ${cell('arc.let', s.arc.let)} ${cell('arc.hp', s.arc.hp)}
                            <td class="text-yellow-400 font-bold font-mono">${Math.round(p.trueScore||0).toLocaleString()}</td>
                            <td class="text-xs text-slate-500">${dateStr}</td>
                        </tr>`;
                    }).join('');
                },
                
                showProfile: (data) => {
                    const modal = document.getElementById('modal-root');
                    const isMe = State.user.uid === data.id;
                    const sameAlliance = State.alliance && data.allianceID === State.alliance.id;
                    const canInvite = State.user.uid === State.alliance?.leader || State.dbUser?.role === 'owner';
                    const isRecruitable = !data.allianceID && data.kingdom == State.profile.kingdom;

                    const hideStats = data.privacy?.hideStats && !isMe && !sameAlliance;
                    const hideName = data.privacy?.hideName && !isMe && !sameAlliance;

                    const t = data.troops || {inf:{tier:10,tg:0},cav:{tier:10,tg:0},arc:{tier:10,tg:0}};
                    const s = data.stats || {inf:{att:0,def:0,let:0,hp:0},cav:{att:0,def:0,let:0,hp:0},arc:{att:0,def:0,let:0,hp:0}};
                    const displayName = hideName ? "Classified" : data.ign;

                    const renderStatRow = (label, obj, color) => {
                        if (hideStats) return `<div class="bg-slate-900 p-3 rounded text-center text-slate-500 italic">Stats Classified</div>`;
                        return `
                        <div class="bg-slate-900 p-2 rounded mb-2">
                            <div class="flex justify-between items-center mb-1"><span class="text-xs font-bold ${color} uppercase">${label}</span><span class="text-xs text-white">T${t[label.toLowerCase().substr(0,3)].tier}</span></div>
                            <div class="grid grid-cols-4 gap-2 text-center text-[10px] text-slate-300">
                                <div><div class="font-bold text-white">${obj.att}%</div><div>ATT</div></div>
                                <div><div class="font-bold text-white">${obj.def}%</div><div>DEF</div></div>
                                <div><div class="font-bold text-white">${obj.let}%</div><div>LET</div></div>
                                <div><div class="font-bold text-white">${obj.hp}%</div><div>HP</div></div>
                            </div>
                        </div>`;
                    };

                    modal.innerHTML = `<div class="bg-slate-800 p-6 rounded-lg shadow-2xl max-w-sm w-full border-2 border-slate-600 modal-enter max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-start mb-4"><div><h2 class="text-2xl font-bold text-white">${displayName}</h2><p class="text-slate-400 text-sm">Kingdom ${data.kingdom} • Score: <span class="text-yellow-400 font-bold">${Math.round(data.trueScore||0).toLocaleString()}</span></p></div><button onclick="document.getElementById('modal-root').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div><div class="space-y-1 mb-6">${renderStatRow('Infantry', s.inf, 'text-blue-400')}${renderStatRow('Cavalry', s.cav, 'text-green-400')}${renderStatRow('Archer', s.arc, 'text-red-400')}</div><button onclick="window.compareVsAverage('${data.id}')" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded text-sm mb-2"><i class="fas fa-chart-bar mr-2"></i>COMPARE VS AVG</button>${isRecruitable && canInvite ? `<button onclick="window.sendInvite('${data.id}')" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-sm"><i class="fas fa-envelope mr-2"></i>INVITE</button>` : ''}</div>`;
                    modal.classList.remove('hidden');
                },

                showAnalytics: () => {
                    const modal = document.getElementById('modal-root');
                    
                    const filterSameKingdom = State.data.roster.filter(p => p.kingdom === State.alliance.kingdom);
                    
                    let improvedHtml = '<div class="text-slate-500 text-xs italic">Not enough historical data.</div>';
                    if (filterSameKingdom.length > 0) {
                        const improved = filterSameKingdom
                            .filter(p => p.previousStats)
                            .map(p => {
                                const ps = p.previousStats;
                                const pScore = (parseFloat(ps.inf?.att||0) + parseFloat(ps.inf?.def||0) + (parseFloat(ps.inf?.let||0)*1.2) + (parseFloat(ps.inf?.hp||0)*1.1)) + 
                                               (parseFloat(ps.cav?.att||0) + parseFloat(ps.cav?.def||0) + (parseFloat(ps.cav?.let||0)*1.2) + (parseFloat(ps.cav?.hp||0)*1.1)) + 
                                               (parseFloat(ps.arc?.att||0) + parseFloat(ps.arc?.def||0) + (parseFloat(ps.arc?.let||0)*1.2) + (parseFloat(ps.arc?.hp||0)*1.1));
                                return { ign: p.ign, delta: p.trueScore - pScore };
                            })
                            .sort((a,b) => b.delta - a.delta)
                            .slice(0, 5);
                        
                        if(improved.length > 0) {
                            improvedHtml = improved.map((p, i) => `<div class="flex justify-between text-sm py-1 border-b border-slate-700 last:border-0"><span class="text-white">${i+1}. ${p.ign}</span><span class="text-green-400 font-bold">+${Math.round(p.delta).toLocaleString()}</span></div>`).join('');
                        }
                    }

                    const recent = [...State.data.roster]
                        .sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0))
                        .slice(0, 5)
                        .map(p => `<div class="flex justify-between text-sm py-1 border-b border-slate-700 last:border-0"><span class="text-white">${p.ign}</span><span class="text-slate-400 text-xs">${p.updatedAt ? new Date(p.updatedAt.toDate()).toLocaleDateString() : '-'}</span></div>`)
                        .join('');

                    modal.innerHTML = `
                        <div class="bg-slate-800 p-6 rounded-lg shadow-2xl max-w-5xl w-full border-2 border-slate-600 modal-enter h-[85vh] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white"><i class="fas fa-chart-pie text-yellow-500 mr-2"></i>Alliance Analytics</h2>
                                <button onclick="document.getElementById('modal-root').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 overflow-y-auto">
                                <div class="bg-slate-900 p-4 rounded border border-slate-700">
                                    <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase">Troop Tech Breakdown</h3>
                                    <div class="h-48"><canvas id="chart-tech"></canvas></div>
                                </div>
                                <div class="bg-slate-900 p-4 rounded border border-slate-700">
                                    <h3 class="text-xs font-bold text-green-400 mb-2 uppercase">Top 5 Most Improved</h3>
                                    <div>${improvedHtml}</div>
                                </div>
                                <div class="bg-slate-900 p-4 rounded border border-slate-700">
                                    <h3 class="text-xs font-bold text-purple-400 mb-2 uppercase">Recently Updated</h3>
                                    <div>${recent}</div>
                                </div>
                            </div>
                        </div>`;
                    modal.classList.remove('hidden');
                    
                    const techCounts = {};
                    filterSameKingdom.forEach(m => {
                        const t = m.troops || {inf:{tier:10,tg:0}, cav:{tier:10,tg:0}, arc:{tier:10,tg:0}};
                        ['inf','cav','arc'].forEach(type => {
                            const key = `T${t[type].tier}${t[type].tg > 0 ? '+TG'+t[type].tg : ''}`;
                            techCounts[key] = (techCounts[key] || 0) + 1;
                        });
                    });
                    
                    new Chart(document.getElementById('chart-tech'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(techCounts),
                            datasets: [{ label: 'Count', data: Object.values(techCounts), backgroundColor: '#3b82f6' }]
                        },
                        options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'white' } }, y: { ticks: { color: 'white' } } } }
                    });
                },

                showHistory: (history) => {
                    const modal = document.getElementById('modal-root');
                    modal.innerHTML = `
                        <div class="bg-slate-800 p-6 rounded-lg shadow-2xl max-w-2xl w-full border-2 border-slate-600 modal-enter h-[80vh] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white"><i class="fas fa-history text-blue-400 mr-2"></i>Update History</h2>
                                <button onclick="document.getElementById('modal-root').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="flex-grow overflow-y-auto space-y-2">
                                ${history.length === 0 ? '<div class="text-slate-500 text-center">No history found.</div>' : history.map(h => `
                                    <div class="bg-slate-900 p-3 rounded flex justify-between items-center border border-slate-700">
                                        <div>
                                            <div class="text-white font-bold">${new Date(h.date?.toDate()).toLocaleString()}</div>
                                            <div class="text-xs text-slate-400">Score: ${Math.round(h.trueScore)}</div>
                                        </div>
                                        <button onclick="window.revertHistory('${h.id}')" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded">Revert</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    modal.classList.remove('hidden');
                },

                allianceCard: () => {
                    if (State.alliance) {
                        const isLeader = State.alliance.leader === State.user.uid;
                        
                        // NEW: Show pending invites for leaders
                        let inviteSection = '';
                        if (isLeader && State.data.invites.length > 0) {
                            inviteSection = `<div class="mt-4 border-t border-slate-700 pt-2"><div class="text-xs text-slate-400 uppercase mb-2">Pending Requests</div>${State.data.invites.map(i => `<div class="flex justify-between items-center bg-slate-900 p-2 rounded mb-1"><span class="text-sm text-white">${i.ign}</span><div><button onclick="window.acceptInvite('${i.id}', '${i.uid}')" class="text-green-400 text-xs font-bold mr-2">ACCEPT</button><button onclick="window.declineInvite('${i.id}')" class="text-red-400 text-xs font-bold">DECLINE</button></div></div>`).join('')}</div>`;
                        }

                        return `
                        <div class="bg-slate-800 p-4 rounded border-l-4 border-yellow-500 flex justify-between items-center mb-6">
                            <div class="w-full">
                                <div class="flex justify-between items-start">
                                    <div><div class="text-xs text-slate-400 uppercase">Current Alliance</div><div class="text-2xl font-bold text-white">[${State.alliance.tag}] ${State.alliance.name}</div><div class="text-xs text-slate-500">Kingdom ${State.alliance.kingdom}</div></div>
                                    <div class="text-right flex flex-col gap-2 items-end">
                                        ${isLeader ? `<button onclick="window.openAllianceManager()" class="bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold px-3 py-2 rounded"><i class="fas fa-users-cog mr-1"></i> MANAGE</button>` : `<button onclick="window.leaveAlliance()" class="bg-red-900/50 hover:bg-red-800 text-red-300 border border-red-800 text-xs font-bold px-3 py-2 rounded">LEAVE</button>`}
                                    </div>
                                </div>
                                ${State.alliance.description ? `<div class="mt-3 p-2 bg-slate-900/50 rounded text-xs text-slate-300 italic border border-slate-700">"${State.alliance.description}"</div>` : ''}
                                ${inviteSection}
                            </div>
                        </div>`;
                    }
                    
                    // FREELANCER VIEW: Show Pending Invites
                    let pendingInvitesHtml = '';
                    if (State.data.invites.length > 0) {
                        pendingInvitesHtml = `
                        <div class="bg-slate-800 p-4 rounded border-l-4 border-purple-500 mb-4">
                            <h3 class="font-bold text-white mb-2">Pending Invitations</h3>
                            <div class="space-y-2">
                                ${State.data.invites.map(i => `
                                    <div class="flex justify-between items-center bg-slate-900 p-2 rounded">
                                        <div><span class="text-white font-bold">${i.name}</span> <span class="text-xs text-slate-400">invited you</span></div>
                                        <div class="flex gap-2">
                                            <button onclick="window.acceptInvite('${i.id}', '${i.allianceID}')" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1 rounded">ACCEPT</button>
                                            <button onclick="window.declineInvite('${i.id}')" class="bg-red-600 hover:bg-red-500 text-white text-xs font-bold px-3 py-1 rounded">DECLINE</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }

                    return `
                        ${pendingInvitesHtml}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-slate-800 p-4 rounded border-l-4 border-blue-500">
                                <h3 class="font-bold text-white mb-2">Join Alliance</h3>
                                <div class="flex gap-2"><input type="text" id="join-tag" placeholder="Alliance Tag" class="input-field py-1"><input type="text" id="join-code" placeholder="Code" class="input-field py-1"><button onclick="window.joinAlliance()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 rounded text-sm">Join</button></div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded border-l-4 border-green-500">
                                <h3 class="font-bold text-white mb-2">Create Alliance</h3>
                                <div class="flex gap-2"><input type="text" id="create-tag" placeholder="TAG" class="input-field py-1 w-20"><input type="text" id="create-name" placeholder="Full Name" class="input-field py-1 flex-grow"><button onclick="window.createAlliance()" class="bg-green-600 hover:bg-green-500 text-white font-bold px-4 rounded text-sm">Create</button></div>
                            </div>
                        </div>`;
                },
                
                showHelp: () => {
                    const modal = document.getElementById('modal-root');
                    modal.innerHTML = `
                        <div class="bg-slate-800 p-6 rounded-lg shadow-2xl max-w-2xl w-full border-2 border-slate-600 modal-enter h-[80vh] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white"><i class="fas fa-question-circle text-yellow-400 mr-2"></i>Help Center</h2>
                                <button onclick="document.getElementById('modal-root').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="space-y-4 text-slate-300 text-sm overflow-y-auto">
                                <div class="bg-slate-900 p-3 rounded">
                                    <h3 class="font-bold text-white mb-1"><i class="fas fa-user-edit text-blue-400 mr-2"></i>Profile & Stats</h3>
                                    <p>Click <strong>Edit Profile</strong> to update your Kingdom, Name, and Troops. Your <strong>True Score</strong> is automatically calculated from your stats. View your <strong>Growth History</strong> chart at the bottom of the editor.</p>
                                </div>
                                <div class="bg-slate-900 p-3 rounded">
                                    <h3 class="font-bold text-white mb-1"><i class="fas fa-users text-green-400 mr-2"></i>Alliances</h3>
                                    <p>Join an alliance using a code from your leader, or create your own. Leaders can kick members, rotate invite codes, and set a public description.</p>
                                </div>
                                <div class="bg-slate-900 p-3 rounded">
                                    <h3 class="font-bold text-white mb-1"><i class="fas fa-chart-bar text-purple-400 mr-2"></i>Analytics</h3>
                                    <p>Use checkboxes to select players and click <strong>Compare</strong> to see a bar chart. Click <strong>Analytics</strong> in your alliance view to see troop distribution and growth trends.</p>
                                </div>
                            </div>
                        </div>`;
                    modal.classList.remove('hidden');
                }
            },

            // --- ACTIONS ---
            actions: {
                // FIXED: Export Function added to actions
                exportRosterCSV: () => {
                    if (State.data.roster.length === 0) return App.ui.toast("No data to export", "error");
                    
                    const headers = ["IGN", "PID", "Kingdom", "True Score", "Inf Tier", "Cav Tier", "Arc Tier"];
                    const rows = State.data.roster.map(p => {
                        const t = p.troops || {inf:{tier:10},cav:{tier:10},arc:{tier:10}};
                        return [
                            `"${p.ign}"`, p.pid, p.kingdom, p.trueScore,
                            `T${t.inf.tier}${t.inf.tg ? '+TG'+t.inf.tg : ''}`,
                            `T${t.cav.tier}${t.cav.tg ? '+TG'+t.cav.tg : ''}`,
                            `T${t.arc.tier}${t.arc.tg ? '+TG'+t.arc.tg : ''}`
                        ].join(",");
                    });
                    
                    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `alliance_roster_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                loadAuditLogs: async () => {
                    if (!State.alliance) return;
                    try {
                        const q = query(collection(App.db, 'alliances', State.alliance.id, 'logs'), orderBy('timestamp', 'desc'), limit(50));
                        const snap = await getDocs(q);
                        State.data.logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        App.renderTableOnly();
                    } catch(e) { console.error(e); }
                },

                loadPersonalHistory: async () => {
                    try {
                        const q = query(collection(doc(App.db, 'profiles', State.user.uid), 'history'), orderBy('date', 'desc'), limit(10));
                        const snap = await getDocs(q);
                        State.data.history = snap.docs.map(d => d.data());
                    } catch(e) { console.error("History Error", e); }
                },

                loadLeaderboard: async () => {
                    try {
                        let q = collection(App.db, 'profiles');
                        if (State.viewMode === 'alliance' && State.profile?.allianceID) {
                            q = query(q, where('allianceID', '==', State.profile.allianceID), orderBy('trueScore', 'desc'), limit(100)); 
                        } else {
                            // GLOBAL LOAD
                            if (State.filters.ign) {
                                q = query(q, orderBy('ign'), startAt(State.filters.ign), endAt(State.filters.ign + '\uf8ff'), limit(50));
                            } else if (State.filters.kingdom) {
                                // Fallback sort by updated to show everyone including 0 scores
                                q = query(q, where('kingdom', '==', State.filters.kingdom), orderBy('updatedAt', 'desc'), limit(50));
                            } else {
                                q = query(q, orderBy('updatedAt', 'desc'), limit(500)); // Increased limit
                            }
                        }
                        const snap = await getDocs(q);
                        State.data.global = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        App.renderTableOnly();
                    } catch (e) { console.error("Load Error", e); }
                },

                submitGate: async () => {
                    const code = document.getElementById('gate-input').value.trim();
                    try {
                        const snap = await getDoc(doc(App.db, 'metadata', 'security'));
                        if (snap.exists() && snap.data().accessCode === code) {
                            localStorage.setItem('acc_gate_token', 'valid');
                            App.handleAuth(State.user);
                        } else { App.ui.toast("Access Denied", "error"); }
                    } catch(e) { App.ui.toast("Error checking code", "error"); }
                },

                createAlliance: async () => {
                    const tag = document.getElementById('create-tag').value.trim().toUpperCase();
                    const name = document.getElementById('create-name').value.trim();
                    if(!tag || !name) return App.ui.toast("Tag/Name Required", "error");
                    const code = Math.floor(10000 + Math.random() * 90000).toString();
                    try {
                        const q = query(collection(App.db, 'alliances'), where('tag', '==', tag));
                        const snap = await getDocs(q);
                        if(!snap.empty) return App.ui.toast("Tag taken!", "error");
                        const allyRef = await addDoc(collection(App.db, 'alliances'), { tag, name, kingdom: State.profile.kingdom, accessCode: code, leader: State.user.uid, createdAt: serverTimestamp(), description: '' });
                        await updateDoc(doc(App.db, 'profiles', State.user.uid), { allianceID: allyRef.id });
                        if (State.dbUser.role !== 'owner') await updateDoc(doc(App.db, 'users', State.user.uid), { role: 'leader' });
                        window.location.reload();
                    } catch(e) { App.ui.toast("Error: " + e.message, "error"); }
                },

                joinAlliance: async () => {
                    const tag = document.getElementById('join-tag').value.trim().toUpperCase();
                    const code = document.getElementById('join-code').value.trim();
                    try {
                        const q = query(collection(App.db, 'alliances'), where('tag', '==', tag));
                        const snap = await getDocs(q);
                        if(snap.empty) return App.ui.toast("Alliance not found", "error");
                        const allyDoc = snap.docs[0];
                        if (allyDoc.data().accessCode !== code) return App.ui.toast("Wrong Access Code", "error");
                        await updateDoc(doc(App.db, 'profiles', State.user.uid), { allianceID: allyDoc.id });
                        
                        // LOG JOIN
                        await addDoc(collection(App.db, 'alliances', allyDoc.id, 'logs'), {
                            action: 'MEMBER_JOIN',
                            details: `${State.profile.ign} joined via code.`,
                            timestamp: serverTimestamp()
                        });

                        window.location.reload();
                    } catch(e) { App.ui.toast("Error: " + e.message, "error"); }
                },

                leaveAlliance: async () => {
                    if (!confirm("Are you sure you want to leave your alliance?")) return;
                    try {
                        // LOG LEAVE BEFORE WIPING ID
                        if (State.profile.allianceID) {
                            await addDoc(collection(App.db, 'alliances', State.profile.allianceID, 'logs'), {
                                action: 'MEMBER_LEAVE',
                                details: `${State.profile.ign} left the alliance.`,
                                timestamp: serverTimestamp()
                            });
                        }
                        await updateDoc(doc(App.db, 'profiles', State.user.uid), { allianceID: null });
                        window.location.reload();
                    } catch(e) { App.ui.toast("Error leaving alliance", "error"); }
                },

                loadRoster: async () => {
                    if (!State.alliance) return;
                    try {
                        const q = query(collection(App.db, 'profiles'), where('allianceID', '==', State.alliance.id), limit(100));
                        const snap = await getDocs(q);
                        State.data.roster = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        App.renderTableOnly();
                    } catch(e) { console.error(e); }
                },

                loadFreelancers: async () => {
                    try {
                        const q = query(collection(App.db, 'profiles'), where('kingdom', '==', State.alliance.kingdom), where('allianceID', '==', null), limit(50));
                        const snap = await getDocs(q);
                        State.data.freelancers = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        App.renderTableOnly();
                    } catch(e) { console.error(e); }
                },

                updateAlliance: async () => {
                    const name = document.getElementById('set-name').value.trim();
                    const desc = document.getElementById('set-desc').value.trim();
                    if (!name) return App.ui.toast("Name required", "error");
                    try {
                        await updateDoc(doc(App.db, 'alliances', State.alliance.id), { name, description: desc });
                        
                        // AUDIT LOG
                        await addDoc(collection(App.db, 'alliances', State.alliance.id, 'logs'), {
                            action: 'SETTINGS_UPDATE',
                            details: `Updated name/desc by ${State.profile.ign}`,
                            timestamp: serverTimestamp()
                        });

                        State.alliance.name = name;
                        State.alliance.description = desc;
                        App.ui.toast("Settings Saved");
                    } catch(e) { App.ui.toast("Update failed", "error"); }
                },

                deleteAlliance: async () => {
                    if(!confirm("ARE YOU SURE? This will remove all members from the alliance.")) return;
                    try {
                        const q = query(collection(App.db, 'profiles'), where('allianceID', '==', State.alliance.id));
                        const snap = await getDocs(q);
                        const batch = writeBatch(App.db);
                        snap.docs.forEach(d => { batch.update(doc(App.db, 'profiles', d.id), { allianceID: null }); });
                        batch.delete(doc(App.db, 'alliances', State.alliance.id));
                        if (State.dbUser.role !== 'owner') batch.update(doc(App.db, 'users', State.user.uid), { role: 'member' });
                        await batch.commit();
                        window.location.reload();
                    } catch(e) { console.error(e); App.ui.toast("Delete failed", "error"); }
                },

                rotateAllianceCode: async () => {
                    if (!State.alliance) return;
                    const newCode = Math.floor(Math.random() * 90000 + 10000).toString();
                    await updateDoc(doc(App.db, 'alliances', State.alliance.id), { accessCode: newCode });
                    
                    // AUDIT LOG
                    await addDoc(collection(App.db, 'alliances', State.alliance.id, 'logs'), {
                        action: 'CODE_ROTATE',
                        details: `Code rotated by ${State.profile.ign}`,
                        timestamp: serverTimestamp()
                    });

                    State.alliance.accessCode = newCode;
                    App.render();
                    App.ui.toast("Invite Code Updated");
                },

                kickMember: async (uid, name) => {
                    if (!confirm(`Kick ${name} from alliance?`)) return;
                    try {
                        await updateDoc(doc(App.db, 'profiles', uid), { allianceID: null });
                        
                        // AUDIT LOG
                        await addDoc(collection(App.db, 'alliances', State.alliance.id, 'logs'), {
                            action: 'MEMBER_KICK',
                            details: `${name} kicked by ${State.profile.ign}`,
                            timestamp: serverTimestamp()
                        });

                        State.data.roster = State.data.roster.filter(m => m.id !== uid);
                        App.renderTableOnly();
                        App.ui.toast(`${name} removed`);
                    } catch(e) { App.ui.toast("Error kicking member", "error"); }
                },

                promoteMember: async (uid, role) => {
                    if (!confirm(`Change role to ${role}?`)) return;
                    try {
                        await updateDoc(doc(App.db, 'users', uid), { role: role });
                        
                        // AUDIT LOG
                        const target = State.data.roster.find(m => m.id === uid);
                        await addDoc(collection(App.db, 'alliances', State.alliance.id, 'logs'), {
                            action: 'ROLE_CHANGE',
                            details: `${target ? target.ign : uid} promoted to ${role} by ${State.profile.ign}`,
                            timestamp: serverTimestamp()
                        });

                        App.ui.toast("Role Updated");
                        App.actions.loadRoster();
                    } catch(e) { App.ui.toast("Error updating role", "error"); }
                },

                // NEW: Demote Action
                demoteMember: async (uid) => {
                    if (!confirm(`Demote member to regular status?`)) return;
                    try {
                        await updateDoc(doc(App.db, 'users', uid), { role: 'member' });
                        
                        // AUDIT LOG
                        const target = State.data.roster.find(m => m.id === uid);
                        await addDoc(collection(App.db, 'alliances', State.alliance.id, 'logs'), {
                            action: 'ROLE_CHANGE',
                            details: `${target ? target.ign : uid} demoted to member by ${State.profile.ign}`,
                            timestamp: serverTimestamp()
                        });

                        App.ui.toast("Role Updated");
                        App.actions.loadRoster();
                    } catch(e) { App.ui.toast("Error demoting member", "error"); }
                },

                openHistory: async () => {
                    try {
                        const q = query(collection(doc(App.db, 'profiles', State.user.uid), 'history'), orderBy('date', 'desc'), limit(10));
                        const snap = await getDocs(q);
                        const history = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        App.ui.showHistory(history);
                    } catch(e) { console.error(e); App.ui.toast("Failed to load history", "error"); }
                },

                revertHistory: async (hid) => {
                    if(!confirm("Revert to this entry? Current stats will be saved to history first.")) return;
                    try {
                        const hSnap = await getDoc(doc(App.db, `profiles/${State.user.uid}/history/${hid}`));
                        if(!hSnap.exists()) return;
                        
                        const oldData = hSnap.data();
                        
                        State.form.stats = oldData;
                        await App.actions.saveProfile();
                        document.getElementById('modal-root').classList.add('hidden');
                        App.ui.toast("Stats Reverted");
                    } catch(e) { App.ui.toast("Revert Failed", "error"); }
                },

                compareSelected: () => {
                    const selectedIds = Array.from(State.selection);
                    if(selectedIds.length < 2) return App.ui.toast("Select at least 2 players", "error");
                    
                    const players = (State.currentTab === 'global' ? State.data.global : State.data.roster).filter(p => selectedIds.includes(p.id));
                    
                    const modal = document.getElementById('modal-root');
                    modal.innerHTML = `
                        <div class="bg-slate-800 p-6 rounded-lg shadow-2xl max-w-4xl w-full border-2 border-slate-600 modal-enter h-[80vh] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white"><i class="fas fa-chart-bar text-purple-500 mr-2"></i>Comparison</h2>
                                <button onclick="document.getElementById('modal-root').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="flex-grow relative">
                                <canvas id="chart-compare"></canvas>
                            </div>
                        </div>`;
                    modal.classList.remove('hidden');

                    new Chart(document.getElementById('chart-compare'), {
                        type: 'bar',
                        data: {
                            labels: ['INF Att', 'INF HP', 'CAV Att', 'CAV HP', 'ARC Att', 'ARC HP'],
                            datasets: players.map((p, i) => {
                                const s = p.stats || { inf:{att:0,hp:0}, cav:{att:0,hp:0}, arc:{att:0,hp:0} };
                                return {
                                    label: p.ign,
                                    data: [s.inf.att, s.inf.hp, s.cav.att, s.cav.hp, s.arc.att, s.arc.hp],
                                    backgroundColor: `hsl(${i * 60}, 70%, 50%)`
                                };
                            })
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                },
                
                compareVsAverage: (targetId) => {
                    const target = State.data.global.find(p => p.id === targetId) || State.data.roster.find(p => p.id === targetId);
                    if(!target) return;

                    // PRIVACY CHECK
                    const isMe = State.user.uid === target.id;
                    const sameAlliance = State.alliance && target.allianceID === State.alliance.id;
                    const canView = isMe || sameAlliance || State.dbUser?.role === 'owner';
                    
                    if(target.privacy?.hideStats && !canView) {
                        return App.ui.toast("Commander has hidden their stats.", "error");
                    }

                    const dataset = State.viewMode === 'alliance' ? State.data.roster : State.data.global;
                    const avg = {inf:{att:0,hp:0},cav:{att:0,hp:0},arc:{att:0,hp:0}};
                    let count = 0;

                    dataset.forEach(p => {
                        if(p.stats) {
                            avg.inf.att += parseFloat(p.stats.inf.att||0); avg.inf.hp += parseFloat(p.stats.inf.hp||0);
                            avg.cav.att += parseFloat(p.stats.cav.att||0); avg.cav.hp += parseFloat(p.stats.cav.hp||0);
                            avg.arc.att += parseFloat(p.stats.arc.att||0); avg.arc.hp += parseFloat(p.stats.arc.hp||0);
                            count++;
                        }
                    });

                    if(count > 0) {
                        ['inf','cav','arc'].forEach(t => { avg[t].att /= count; avg[t].hp /= count; });
                    }

                    const modal = document.getElementById('modal-root');
                    modal.innerHTML = `
                        <div class="bg-slate-800 p-6 rounded-lg shadow-2xl max-w-4xl w-full border-2 border-slate-600 modal-enter h-[80vh] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white"><i class="fas fa-chart-bar text-purple-500 mr-2"></i>Vs Average</h2>
                                <button onclick="document.getElementById('modal-root').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="flex-grow relative">
                                <canvas id="chart-compare-avg"></canvas>
                            </div>
                        </div>`;
                    modal.classList.remove('hidden');

                    const s = target.stats || { inf:{att:0,hp:0}, cav:{att:0,hp:0}, arc:{att:0,hp:0} };
                    new Chart(document.getElementById('chart-compare-avg'), {
                        type: 'bar',
                        data: {
                            labels: ['INF Att', 'INF HP', 'CAV Att', 'CAV HP', 'ARC Att', 'ARC HP'],
                            datasets: [
                                { label: target.ign, data: [s.inf.att, s.inf.hp, s.cav.att, s.cav.hp, s.arc.att, s.arc.hp], backgroundColor: '#3b82f6' },
                                { label: 'Average', data: [avg.inf.att, avg.inf.hp, avg.cav.att, avg.cav.hp, avg.arc.att, avg.arc.hp], backgroundColor: '#64748b' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                },

                saveProfile: async () => {
                    const ign = document.getElementById('frm-ign').value.trim();
                    const kingdom = document.getElementById('frm-kingdom').value.trim();
                    const pid = document.getElementById('frm-pid').value.trim();
                    const hideName = document.getElementById('frm-hideName').checked;
                    const hideStats = document.getElementById('frm-hideStats').checked;
                    
                    if(!ign || !kingdom || !pid) return App.ui.toast("Missing Fields", "error");
                    
                    const s = State.form.stats;
                    const sum = (p) => parseFloat(s.inf[p]||0) + parseFloat(s.cav[p]||0) + parseFloat(s.arc[p]||0);
                    const trueScore = (sum('att') + sum('def')) * 1.0 + sum('let') * 1.2 + sum('hp') * 1.1;

                    // DELTA LOGIC
                    const currentProfile = State.profile || {};
                    const previousStats = currentProfile.stats || {}; 

                    const profileData = { 
                        ign, kingdom, pid, 
                        privacy: { hideName, hideStats }, 
                        troops: State.form.troops, 
                        stats: State.form.stats,
                        previousStats: previousStats, 
                        trueScore: Math.round(trueScore),
                        updatedAt: serverTimestamp() 
                    };
                    
                    try {
                        const batch = writeBatch(App.db);
                        const pRef = doc(App.db, 'profiles', State.user.uid);
                        const hRef = doc(collection(pRef, 'history'));

                        batch.set(pRef, profileData, { merge: true });
                        batch.set(hRef, { 
                            ...State.form.stats, 
                            date: serverTimestamp(), 
                            trueScore: Math.round(trueScore) 
                        });

                        await batch.commit();
                        
                        // FIX: MERGE STATE SO ALLIANCE ID IS NOT LOST
                        State.profile = { ...State.profile, ...profileData };
                        await App.actions.loadLeaderboard();
                        // Reload history for chart
                        await App.actions.loadPersonalHistory();
                        
                        // FIX: RESTORE PREVIOUS VIEW
                        State.current = State.previousView || 'view_global';
                        App.render();
                        
                        App.ui.toast("Profile Updated");
                    } catch (e) { App.ui.toast("Save Failed: " + e.message, "error"); }
                },

                // ... [Owner/Admin Init] ...
                initOwnerView: async () => {
                    if (State.listeners.security) return;
                    const unsub = onSnapshot(doc(App.db, 'metadata', 'security'), (snap) => {
                        if(snap.exists() && document.getElementById('owner-global-code')) {
                            document.getElementById('owner-global-code').innerText = snap.data().accessCode;
                        }
                    });
                    State.listeners.security = unsub;
                    try {
                        const coll = collection(App.db, "profiles");
                        const snapshot = await getCountFromServer(coll);
                        State.stats.totalProfiles = snapshot.data().count;
                        // FIX: MANUALLY UPDATE DOM
                        if(document.getElementById('stat-count')) {
                             document.getElementById('stat-count').innerText = State.stats.totalProfiles;
                        }
                    } catch(e) { console.error(e); }
                },
                rotateCode: async () => {
                    const newCode = Math.floor(Math.random() * 90000 + 10000).toString();
                    await setDoc(doc(App.db, 'metadata', 'security'), { accessCode: newCode }, { merge: true });
                    App.ui.toast("Gate Code Generated");
                },
                toggleLockdown: async () => {
                    const newState = !State.config.lockdown;
                    await setDoc(doc(App.db, 'metadata', 'security'), { lockdown: newState }, { merge: true });
                    App.ui.toast(newState ? "GLOBAL LOCKDOWN ACTIVE" : "System Unlocked");
                },
                viewProfile: (uid) => {
                    const p = State.data.global.find(x => x.id === uid) || State.data.alliance.find(x => x.id === uid) || State.data.roster.find(x => x.id === uid) || State.data.freelancers.find(x => x.id === uid);
                    if(p) App.ui.showProfile(p);
                },
                sendInvite: async (uid) => {
                    try {
                        await addDoc(collection(doc(App.db, 'profiles', uid), 'invites'), {
                            allianceID: State.alliance.id,
                            name: State.alliance.name,
                            timestamp: serverTimestamp()
                        });
                        App.ui.toast("Invite Sent");
                        document.getElementById('modal-root').classList.add('hidden');
                    } catch(e) { App.ui.toast("Invite Failed", "error"); }
                },
                acceptInvite: async (inviteID, allianceID) => {
                    try {
                        // 1. Update Profile
                        await updateDoc(doc(App.db, 'profiles', State.user.uid), { allianceID: allianceID });
                        // 2. Delete Invite
                        await deleteDoc(doc(App.db, `profiles/${State.user.uid}/invites/${inviteID}`));
                        // 3. Log Action
                        if (allianceID) { // Log Join
                             const profile = State.data.global.find(p => p.id === State.user.uid) || State.profile;
                             await addDoc(collection(App.db, 'alliances', allianceID, 'logs'), {
                                action: 'MEMBER_JOIN',
                                details: `${profile.ign} [${profile.pid}] joined the alliance.`,
                                timestamp: serverTimestamp()
                            });
                        }
                        // 4. Reload
                        window.location.reload();
                    } catch(e) { App.ui.toast("Error accepting invite", "error"); }
                },
                declineInvite: async (inviteID) => {
                    try {
                        await deleteDoc(doc(App.db, `profiles/${State.user.uid}/invites/${inviteID}`));
                        App.ui.toast("Invite Declined");
                    } catch(e) { App.ui.toast("Error declining invite", "error"); }
                },
                exportRosterCSV: () => {
                    if (State.data.roster.length === 0) return App.ui.toast("No data to export", "error");
                    
                    const headers = ["IGN", "PID", "Kingdom", "True Score", "Inf Tier", "Cav Tier", "Arc Tier"];
                    const rows = State.data.roster.map(p => {
                        const t = p.troops || {inf:{tier:10},cav:{tier:10},arc:{tier:10}};
                        return [
                            `"${p.ign}"`, p.pid, p.kingdom, p.trueScore,
                            `T${t.inf.tier}${t.inf.tg ? '+TG'+t.inf.tg : ''}`,
                            `T${t.cav.tier}${t.cav.tg ? '+TG'+t.cav.tg : ''}`,
                            `T${t.arc.tier}${t.arc.tg ? '+TG'+t.arc.tg : ''}`
                        ].join(",");
                    });
                    
                    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `alliance_roster_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        };

        // GLOBAL EXPORTS
        window.triggerLogin = () => signInWithPopup(App.auth, new GoogleAuthProvider());
        window.triggerLogout = () => signOut(App.auth).then(() => window.location.reload());
        window.openEditor = () => {
            // FIX: SAVE CURRENT VIEW TO RETURN TO IT
            State.previousView = State.current;
            State.editorTarget = null; // Clear target (edit self)
            const raw = JSON.parse(JSON.stringify(State.profile));
            const blankStats = { att:0, def:0, let:0, hp:0 };
            const s = raw.stats || { inf: {...blankStats}, cav: {...blankStats}, arc: {...blankStats} };
            const normalize = (val) => (typeof val === 'object' && val !== null) ? val : { tier: 10, tg: 0 };
            State.form = { ign: raw.ign, kingdom: raw.kingdom, pid: raw.pid, privacy: raw.privacy || {hideName: false, hideStats: false}, troops: { inf: normalize(raw.troops?.inf), cav: normalize(raw.troops?.cav), arc: normalize(raw.troops?.arc) }, stats: s };
            State.current = 'editor';
            App.render();
        };

        window.navTo = (view) => { 
            State.current = view; 
            // FIX: Sync ViewMode
            if (view === 'view_global') State.viewMode = 'global';
            if (view === 'view_alliance') State.viewMode = 'alliance';
            
            App.render(); 
            if(view === 'view_global') App.actions.loadLeaderboard(); 
            if(view === 'view_alliance') App.actions.loadRoster(); 
        };
        window.openOwner = () => { State.current = 'owner'; App.render(); };
        window.openAllianceManager = () => { State.current = 'allianceManager'; State.managerTab = 'main'; document.getElementById('app-root').innerHTML = ''; App.render(); App.actions.loadRoster(); };
        window.cancelEdit = () => { State.current = State.previousView || 'view_global'; App.render(); };
        window.switchManagerTab = (tab) => { 
            State.managerTab = tab; 
            document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.toggle('active', btn.innerText.toLowerCase() === tab); }); 
            const container = document.getElementById('manager-content');
            if (tab === 'main') {
                container.innerHTML = App.ui.managerMain();
                App.actions.loadRoster();
            } else if (tab === 'audit') {
                container.innerHTML = App.ui.managerAudit();
                App.actions.loadAuditLogs();
            }
        };
        window.refreshData = () => { if(State.current === 'view_global') App.actions.loadLeaderboard(); if(State.current === 'view_alliance') App.actions.loadRoster(); };
        window.ownerRotateCode = () => App.actions.rotateCode();
        window.ownerToggleLockdown = () => App.actions.toggleLockdown();
        window.saveProfile = () => App.actions.saveProfile();
        window.triggerRegister = () => App.actions.saveProfile();
        
        window.createAlliance = () => App.actions.createAlliance();
        window.joinAlliance = () => App.actions.joinAlliance();
        window.rotateAllianceCode = () => App.actions.rotateAllianceCode();
        window.kickMember = (uid, name) => App.actions.kickMember(uid, name);
        window.promoteMember = (uid, role) => App.actions.promoteMember(uid, role);
        window.demoteMember = (uid) => App.actions.demoteMember(uid);
        window.updateAlliance = () => App.actions.updateAlliance();
        window.deleteAlliance = () => App.actions.deleteAlliance();
        window.leaveAlliance = () => App.actions.leaveAlliance();
        window.submitGate = () => App.actions.submitGate();
        
        window.clearKingdom = () => { document.getElementById('filter-kingdom').value = ''; window.handleKingdom(''); };
        window.viewProfile = (uid) => App.actions.viewProfile(uid);
        window.editPlayer = (uid) => App.actions.editPlayer(uid);
        window.sendInvite = (uid) => App.actions.sendInvite(uid);
        window.acceptInvite = (id, aid) => App.actions.acceptInvite(id, aid);
        window.declineInvite = (id) => App.actions.declineInvite(id);
        window.exportRosterCSV = () => App.actions.exportRosterCSV();
        
        window.openHistory = () => App.actions.openHistory();
        window.revertHistory = (hid) => App.actions.revertHistory(hid);
        window.compareSelected = () => App.actions.compareSelected();
        window.compareVsAverage = (uid) => App.actions.compareVsAverage(uid);
        window.toggleSelection = (uid) => { 
            if(State.selection.has(uid)) State.selection.delete(uid); 
            else State.selection.add(uid);
            const count = document.getElementById('compare-count');
            if(count) count.innerText = State.selection.size;
        };
        // FIXED: Select All
        window.toggleSelectAll = (source) => {
            const dataset = State.currentTab === 'global' ? State.data.global : State.data.roster;
            if (source.checked) { dataset.forEach(p => State.selection.add(p.id)); } 
            else { dataset.forEach(p => State.selection.delete(p.id)); }
            const count = document.getElementById('compare-count');
            if(count) count.innerText = State.selection.size;
            App.renderTableOnly();
        };

        window.showHelp = () => App.ui.showHelp();
        window.openAllianceAnalytics = () => App.ui.showAnalytics();

        window.setTroop = (type, prop, val, updateState = true) => { if (updateState) State.form.troops[type][prop] = val; const cards = document.querySelectorAll(`[data-group="${type}-${prop}"]`); cards.forEach(c => { c.classList.toggle(prop === 'tier' ? 'selected-tier' : 'selected-tg', parseInt(c.dataset.val) === val); }); const t = State.form.troops[type]; const summary = document.getElementById(`display-${type}`); if(summary) summary.innerText = `T${t.tier} ${t.tg > 0 ? '+TG'+t.tg : ''}`; };
        
        // REPLACED: NEW CLEAN HANDLERS
        window.handleEnter = (e) => { if(e.key === 'Enter') e.preventDefault(); };
        window.handleStatChange = (type, prop, el) => {
            let val = parseFloat(el.value);
            if(val < 0) val = 0; // No negatives
            State.form.stats[type][prop] = val;
            el.value = val; // Reflect clean value
        };

        window.setSort = (field) => { if (State.sort.field === field) { State.sort.dir = State.sort.dir === 'asc' ? 'desc' : 'asc'; } else { State.sort.field = field; State.sort.dir = 'desc'; } App.renderTableOnly(); };
        
        let debounceTimer;
        window.handleSearch = (val) => { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { State.filters.ign = val.trim(); State.filters.kingdom = ''; App.actions.loadLeaderboard(); }, 500); };
        window.handleKingdom = (val) => { State.filters.kingdom = val.trim(); State.filters.ign = ''; App.actions.loadLeaderboard(); };

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
