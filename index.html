<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Stat Comparison Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }

        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }

        .table-header th {
            padding: 8px 10px;
            position: sticky;
            top: 0;
            background-color: #1f2937;
            white-space: nowrap;
            cursor: pointer;
        }

        .table-row td {
            padding: 8px 10px;
            white-space: nowrap;
        }
        
        .table-row {
            cursor: pointer;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .input-field {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            padding: 6px 10px;
        }
        
        .stat-delta {
            font-size: 0.7rem;
            margin-left: 4px;
            font-weight: bold;
        }

        .history-entry {
            transition: background-color 0.2s;
        }
        .history-entry:hover {
            background-color: #374151;
        }
    </style>
</head>

<body class="flex flex-col h-screen p-4 md:p-6 space-y-4">

    <!-- Header -->
    <header class="text-center flex-shrink-0">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Alliance Stat Comparison</h1>
        <p id="db-status" class="text-sm text-gray-400 mt-2">Connecting to database...</p>
    </header>

    <!-- Instructions -->
    <div class="card p-3 rounded-lg shadow-md flex-shrink-0">
        <h3 class="text-md font-semibold text-center text-yellow-400 mb-2">Instructions & Info</h3>
        <ul class="text-xs text-gray-300 grid grid-cols-1 md:grid-cols-5 gap-x-4 text-center">
            <li><i class="fas fa-shield-alt mr-1 text-red-500"></i> **Rule 1:** NO BUFFS active.</li>
            <li><i class="fas fa-crosshairs mr-1 text-blue-500"></i> **Rule 2:** Test rally an alt with NO troops.</li>
            <li><i class="fas fa-user-friends mr-1 text-green-500"></i> **Rule 3:** Use 4 Chenkos w/ lvl 5 Stand of Arms.</li>
            <li><i class="fas fa-calendar-check mr-1 text-indigo-500"></i> **Rule 4:** Update at least once a week.</li>
            <li class="hidden md:block"><i class="fas fa-calculator mr-1 text-yellow-500"></i> **True Score Formula:** Lethality x1.2, Health x1.1</li>
        </ul>
    </div>

    <!-- Data Entry -->
    <div id="manual-entry" class="card p-4 rounded-lg shadow-lg flex-shrink-0">
        <form onsubmit="event.preventDefault(); handleSaveOrUpdate();">
            <div class="flex justify-between items-center mb-3">
                 <h2 class="text-lg font-semibold text-white">Manual Data Entry</h2>
                 <p class="text-xs text-gray-400 italic">Tip: Use 'Tab' or 'Enter' to move through inputs in order.</p>
            </div>
            <div class="flex gap-4 items-end mb-3">
                <div class="flex-grow">
                    <label for="playerName" class="block text-sm font-medium text-gray-300 mb-1">Player Name</label>
                    <input type="text" id="playerName" placeholder="Enter player name" required class="w-full rounded-md input-field">
                </div>
                <div class="flex items-end space-x-2 flex-shrink-0">
                    <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md btn">
                        <i class="fas fa-save mr-2"></i>Save Stats
                    </button>
                    <button type="button" id="cancel-edit-btn" onclick="cancelEdit()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md btn hidden">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6">
                <!-- Unit Inputs -->
                <div class="space-y-2">
                    <h3 class="font-bold text-md text-center text-blue-400">Infantry (%)</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.01" id="infAttack" placeholder="Att" required class="w-full rounded-md input-field text-center" title="Infantry Attack">
                        <input type="number" step="0.01" id="infDefense" placeholder="Def" required class="w-full rounded-md input-field text-center" title="Infantry Defense">
                        <input type="number" step="0.01" id="infLethality" placeholder="Let" required class="w-full rounded-md input-field text-center" title="Infantry Lethality">
                        <input type="number" step="0.01" id="infHp" placeholder="HP" required class="w-full rounded-md input-field text-center" title="Infantry Health">
                    </div>
                </div>
                <div class="space-y-2">
                    <h3 class="font-bold text-md text-center text-green-400">Cavalry (%)</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.01" id="cavAttack" placeholder="Att" required class="w-full rounded-md input-field text-center" title="Cavalry Attack">
                        <input type="number" step="0.01" id="cavDefense" placeholder="Def" required class="w-full rounded-md input-field text-center" title="Cavalry Defense">
                        <input type="number" step="0.01" id="cavLethality" placeholder="Let" required class="w-full rounded-md input-field text-center" title="Cavalry Lethality">
                        <input type="number" step="0.01" id="cavHp" placeholder="HP" required class="w-full rounded-md input-field text-center" title="Cavalry Health">
                    </div>
                </div>
                <div class="space-y-2">
                    <h3 class="font-bold text-md text-center text-red-400">Archer (%)</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="number" step="0.01" id="arcAttack" placeholder="Att" required class="w-full rounded-md input-field text-center" title="Archer Attack">
                        <input type="number" step="0.01" id="arcDefense" placeholder="Def" required class="w-full rounded-md input-field text-center" title="Archer Defense">
                        <input type="number" step="0.01" id="arcLethality" placeholder="Let" required class="w-full rounded-md input-field text-center" title="Archer Lethality">
                        <input type="number" step="0.01" id="arcHp" placeholder="HP" required class="w-full rounded-md input-field text-center" title="Archer Health">
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Chart -->
    <div class="card p-4 rounded-lg shadow-lg flex-grow flex flex-col overflow-hidden">
        <div class="flex justify-between items-center mb-3 flex-shrink-0">
            <h2 class="text-xl font-semibold text-white">Alliance Comparison Chart</h2>
            <button id="compare-selected-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md btn" disabled>
                <i class="fas fa-chart-bar mr-2"></i>Compare Selected (0)
            </button>
        </div>
        <div class="overflow-y-auto flex-grow">
            <table class="w-full text-left text-sm">
                <thead class="table-header text-xs text-gray-300 uppercase">
                    <tr>
                        <th class="w-12 text-center" title="Compare Players"><i class="fas fa-search"></i></th>
                        <th class="w-12 text-center" onclick="sortStats('rank')">#</th>
                        <th onclick="sortStats('playerName')">Player</th>
                        <th class="bg-blue-900/50" onclick="sortStats('infAttack')">Inf Att</th>
                        <th class="bg-blue-900/50" onclick="sortStats('infDefense')">Inf Def</th>
                        <th class="bg-blue-900/50" onclick="sortStats('infLethality')">Inf Let</th>
                        <th class="bg-blue-900/50" onclick="sortStats('infHp')">Inf HP</th>
                        <th class="bg-green-900/50" onclick="sortStats('cavAttack')">Cav Att</th>
                        <th class="bg-green-900/50" onclick="sortStats('cavDefense')">Cav Def</th>
                        <th class="bg-green-900/50" onclick="sortStats('cavLethality')">Cav Let</th>
                        <th class="bg-green-900/50" onclick="sortStats('cavHp')">Cav HP</th>
                        <th class="bg-red-900/50" onclick="sortStats('arcAttack')">Arc Att</th>
                        <th class="bg-red-900/50" onclick="sortStats('arcDefense')">Arc Def</th>
                        <th class="bg-red-900/50" onclick="sortStats('arcLethality')">Arc Let</th>
                        <th class="bg-red-900/50" onclick="sortStats('arcHp')">Arc HP</th>
                        <th onclick="sortStats('trueScore')">True Score ▼</th>
                        <th onclick="sortStats('realScore')">Real Score</th>
                        <th onclick="sortStats('date')">Last Update</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stats-table-body">
                    <!-- Rows will be injected by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modals (Confirmation modal is now last to ensure it's on top) -->
    <div id="history-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl border border-gray-700 flex flex-col h-3/4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="history-modal-title" class="text-lg font-bold text-white">Update History</h3>
                <button id="history-modal-close-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="history-modal-body" class="overflow-y-auto space-y-2">
                <!-- History entries will be injected here -->
            </div>
        </div>
    </div>

    <div id="chart-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-6xl border border-gray-700 flex flex-col h-5/6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="chart-modal-title" class="text-lg font-bold text-white">Stat Comparison</h3>
                <button id="chart-modal-close-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="flex-grow relative">
                <canvas id="comparison-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md border border-gray-700">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-4">Confirm Action</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-md text-white font-semibold btn">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-white font-semibold btn">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.appspot.com",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b541ea0"
        };
        
        let db, auth, userId = null, appId = null;
        let allStats = [];
        let latestStats = [];
        let selectedForComparison = [];
        let currentSort = { column: 'trueScore', direction: 'desc' };
        let currentEditId = null;
        let comparisonChart = null;
        
        const dbStatus = document.getElementById('db-status');
        const playerNameInput = document.getElementById('playerName');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const compareBtn = document.getElementById('compare-selected-btn');
        
        const modal = document.getElementById('custom-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        const historyModal = document.getElementById('history-modal');
        const historyModalTitle = document.getElementById('history-modal-title');
        const historyModalBody = document.getElementById('history-modal-body');
        const historyModalCloseBtn = document.getElementById('history-modal-close-btn');

        const chartModal = document.getElementById('chart-modal');
        const chartModalTitle = document.getElementById('chart-modal-title');
        const chartModalCloseBtn = document.getElementById('chart-modal-close-btn');

        const initFirebase = async () => {
            appId = USER_FIREBASE_CONFIG.projectId;
            if (!getApps().length) initializeApp(USER_FIREBASE_CONFIG);
            db = getFirestore();
            auth = getAuth();

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    dbStatus.textContent = `✅ Connected`;
                    dbStatus.className = 'text-sm text-green-400 mt-2';
                    setupRealtimeListener();
                } else {
                    signInAnonymously(auth).catch(error => console.error("Auth Failed:", error));
                }
            });
        };
        
        const setupRealtimeListener = () => {
            const collectionPath = `artifacts/${appId}/public/data/game_stats`;
            onSnapshot(collection(db, collectionPath), querySnapshot => {
                allStats = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    const statEntry = { id: doc.id, ...data, date: data.date ? data.date.toDate() : new Date() };
                    statEntry.trueScore = calculateTrueScore(statEntry);
                    statEntry.realScore = calculateRealScore(statEntry);
                    return statEntry;
                });
                processAndRender();
            });
        };

        const getFormData = () => ({
            playerName: playerNameInput.value.trim().toLowerCase(),
            infAttack: parseFloat(document.getElementById('infAttack').value) || 0,
            infDefense: parseFloat(document.getElementById('infDefense').value) || 0,
            infLethality: parseFloat(document.getElementById('infLethality').value) || 0,
            infHp: parseFloat(document.getElementById('infHp').value) || 0,
            cavAttack: parseFloat(document.getElementById('cavAttack').value) || 0,
            cavDefense: parseFloat(document.getElementById('cavDefense').value) || 0,
            cavLethality: parseFloat(document.getElementById('cavLethality').value) || 0,
            cavHp: parseFloat(document.getElementById('cavHp').value) || 0,
            arcAttack: parseFloat(document.getElementById('arcAttack').value) || 0,
            arcDefense: parseFloat(document.getElementById('arcDefense').value) || 0,
            arcLethality: parseFloat(document.getElementById('arcLethality').value) || 0,
            arcHp: parseFloat(document.getElementById('arcHp').value) || 0,
        });
        
        const processAndRender = () => {
            const playerGroups = {};
            allStats.forEach(stat => {
                const name = stat.playerName.toLowerCase();
                if (!playerGroups[name]) playerGroups[name] = [];
                playerGroups[name].push(stat);
            });

            latestStats = Object.values(playerGroups).map(group => {
                group.sort((a, b) => b.date - a.date);
                return group[0];
            });
            sortAndRender();
        };

        const renderTable = () => {
            const tableBody = document.getElementById('stats-table-body');
            const rankedStats = latestStats.map((stat, index) => ({ ...stat, rank: index + 1 }));
            const disableCheckboxes = selectedForComparison.length >= 5;

            tableBody.innerHTML = rankedStats.map(stat => {
                const playerHistory = allStats.filter(s => s.playerName === stat.playerName).sort((a, b) => b.date - a.date);
                const previousStat = playerHistory.length > 1 ? playerHistory[1] : null;
                const statKeys = ['infAttack', 'infDefense', 'infLethality', 'infHp', 'cavAttack', 'cavDefense', 'cavLethality', 'cavHp', 'arcAttack', 'arcDefense', 'arcLethality', 'arcHp'];
                
                const statCells = statKeys.map(key => {
                    let deltaHtml = '';
                    if (previousStat) {
                        const delta = (stat[key] - previousStat[key]).toFixed(1);
                        if (delta > 0) deltaHtml = `<span class="stat-delta text-green-400">(+${delta})</span>`;
                        else if (delta < 0) deltaHtml = `<span class="stat-delta text-red-400">(${delta})</span>`;
                    }
                    return `<td>${stat[key]}% ${deltaHtml}</td>`;
                }).join('');

                const isChecked = selectedForComparison.includes(stat.playerName);
                const isDisabled = disableCheckboxes && !isChecked;

                const formattedDate = stat.date.toLocaleString([], { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '');
                return `
                    <tr class="table-row odd:bg-[#2d3748] even:bg-[#1f2937] hover:bg-gray-700" ondblclick="showSinglePlayerChart('${stat.playerName}')">
                        <td class="text-center"><input type="checkbox" class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600" value="${stat.playerName}" onchange="handleCompareSelect(this)" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}></td>
                        <td class="font-bold text-center">${stat.rank}</td>
                        <td class="font-semibold text-white">${stat.playerName}</td>
                        ${statCells}
                        <td class="font-bold text-yellow-400">${stat.trueScore.toLocaleString()}</td>
                        <td class="font-bold text-gray-300">${stat.realScore.toLocaleString()}</td>
                        <td class="text-xs text-gray-400">${formattedDate}</td>
                        <td>
                             <button onclick="showHistory('${stat.playerName}')" class="text-indigo-400 hover:text-indigo-300 mr-2"><i class="fas fa-history"></i></button>
                             <button onclick="enterEditMode('${stat.id}')" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fas fa-pencil-alt"></i></button>
                             <button onclick="deleteStat('${stat.id}', '${stat.playerName}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        };
        
        const sortAndRender = () => {
             latestStats.sort((a, b) => {
                const valA = a[currentSort.column];
                const valB = b[currentSort.column];
                let comparison = (typeof valA === 'string') ? valA.localeCompare(valB) : valA - valB;
                return currentSort.direction === 'asc' ? comparison : -comparison;
            });
            renderTable();
        };

        const calculateTrueScore = (stats) => {
            const weights = { lethality: 1.2, hp: 1.1, attack: 1.0, defense: 1.0 };
            let total = 0;
            total += (stats.infAttack + stats.cavAttack + stats.arcAttack) * weights.attack;
            total += (stats.infDefense + stats.cavDefense + stats.arcDefense) * weights.defense;
            total += (stats.infLethality + stats.cavLethality + stats.arcLethality) * weights.lethality;
            total += (stats.infHp + stats.cavHp + stats.arcHp) * weights.hp;
            return Math.round(total);
        };

        const calculateRealScore = (stats) => {
            let total = 0;
            const statKeys = ['infAttack', 'infDefense', 'infLethality', 'infHp', 'cavAttack', 'cavDefense', 'cavLethality', 'cavHp', 'arcAttack', 'arcDefense', 'arcLethality', 'arcHp'];
            statKeys.forEach(key => total += (stats[key] || 0));
            return Math.round(total);
        };
        
        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            return new Promise(resolve => {
                modalConfirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                modalCancelBtn.onclick = () => { modal.classList.add('hidden'); resolve(false); };
            });
        };

        window.handleSaveOrUpdate = async () => {
            const statData = getFormData();
            if (!statData.playerName) return;
            try {
                const collectionPath = `artifacts/${appId}/public/data/game_stats`;
                if (currentEditId) {
                    await setDoc(doc(db, collectionPath, currentEditId), { ...statData, date: serverTimestamp() });
                } else {
                    await addDoc(collection(db, collectionPath), { ...statData, date: serverTimestamp() });
                }
                resetForm();
            } catch (error) { showModal('Error', `Failed to save data: ${error.message}`); }
        };

        window.enterEditMode = (docId) => {
            const statToEdit = allStats.find(s => s.id === docId);
            if (!statToEdit) return;
            currentEditId = docId;
            playerNameInput.value = statToEdit.playerName;
            ['infAttack', 'infDefense', 'infLethality', 'infHp', 'cavAttack', 'cavDefense', 'cavLethality', 'cavHp', 'arcAttack', 'arcDefense', 'arcLethality', 'arcHp'].forEach(id => {
                document.getElementById(id).value = statToEdit[id];
            });
            submitBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Update Stats';
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo(0, 0);
        };

        window.resetForm = () => {
            document.querySelector('form').reset();
            currentEditId = null;
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Stats';
            cancelEditBtn.classList.add('hidden');
        };
        window.cancelEdit = resetForm;


        window.deleteStat = async (docId, playerName) => {
            const confirmed = await showModal('Confirm Deletion', `This will delete ALL entries for ${playerName}. This action cannot be undone. Are you sure?`);
            if (confirmed) {
                const playerHistory = allStats.filter(s => s.playerName === playerName.toLowerCase());
                for(const stat of playerHistory) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/game_stats`, stat.id));
                    } catch (error) {
                        console.error(`Failed to delete doc ${stat.id}`, error);
                    }
                }
            }
        };

        window.showHistory = (playerName) => {
            const playerHistory = allStats.filter(s => s.playerName === playerName.toLowerCase()).sort((a,b) => b.date - a.date);
            historyModalTitle.textContent = `Update History for ${playerName}`;
            historyModalBody.innerHTML = '';
            
            playerHistory.forEach((stat, index) => {
                const prevStat = playerHistory[index + 1];
                let growthHtml = '';
                if(prevStat) {
                    const growth = stat.realScore - prevStat.realScore;
                    const growthColor = growth >= 0 ? 'text-green-400' : 'text-red-400';
                    growthHtml = `<span class="font-bold ${growthColor}">(${growth >= 0 ? '+' : ''}${growth})</span>`;
                }

                const formattedDate = stat.date.toLocaleString();
                const entryDiv = document.createElement('div');
                entryDiv.className = 'p-3 rounded-md border border-gray-700 history-entry';
                entryDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-semibold">${formattedDate}</span>
                            <div>
                                <span class="text-gray-400">Real Score:</span>
                                <span class="font-bold text-white">${stat.realScore.toLocaleString()}</span>
                                ${growthHtml}
                            </div>
                        </div>
                        <button class="text-sm text-yellow-400 hover:text-yellow-300 ml-4 btn" onclick="revertToStat('${stat.id}', '${stat.playerName}')"><i class="fas fa-undo"></i> Revert</button>
                    </div>
                    <div class="text-xs text-gray-400 grid grid-cols-3 gap-x-4 mt-2 hidden cursor-pointer"></div>
                `;
                
                const mainInfo = entryDiv.querySelector('.flex');
                mainInfo.onclick = (e) => {
                     if (e.target.closest('button')) return; // Don't toggle if button was clicked
                    const detailsDiv = entryDiv.querySelector('.grid');
                    if(detailsDiv.classList.contains('hidden')) {
                        detailsDiv.classList.remove('hidden');
                        detailsDiv.innerHTML = `
                            <div><strong>Inf:</strong> ${stat.infAttack}/${stat.infDefense}/${stat.infLethality}/${stat.infHp}</div>
                            <div><strong>Cav:</strong> ${stat.cavAttack}/${stat.cavDefense}/${stat.cavLethality}/${stat.cavHp}</div>
                            <div><strong>Arc:</strong> ${stat.arcAttack}/${stat.arcDefense}/${stat.arcLethality}/${stat.arcHp}</div>
                        `;
                    } else {
                        detailsDiv.classList.add('hidden');
                    }
                };
                historyModalBody.appendChild(entryDiv);
            });

            historyModal.classList.remove('hidden');
        };
        
        historyModalCloseBtn.onclick = () => historyModal.classList.add('hidden');

        window.revertToStat = async (docId, playerName) => {
            const confirmed = await showModal('Confirm Revert', `This will copy the stats from this historical entry and save it as the new latest entry for ${playerName}. This is non-destructive. Are you sure?`);
            if (confirmed) {
                const statToRevert = allStats.find(s => s.id === docId);
                if (!statToRevert) {
                    showModal('Error', 'Could not find the historical data to revert.');
                    return;
                }

                const { id, date, trueScore, realScore, ...newStatData } = statToRevert;
                
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/game_stats`), { ...newStatData, date: serverTimestamp() });
                    historyModal.classList.add('hidden');
                } catch (error) {
                    showModal('Error', `Failed to revert stats: ${error.message}`);
                }
            }
        };

        const calculateAllianceAverages = () => {
            const statKeys = ['infAttack', 'infDefense', 'infLethality', 'infHp', 'cavAttack', 'cavDefense', 'cavLethality', 'cavHp', 'arcAttack', 'arcDefense', 'arcLethality', 'arcHp'];
            const averages = {};
            statKeys.forEach(k => averages[k] = 0);
            if (latestStats.length === 0) return averages;
            latestStats.forEach(player => statKeys.forEach(key => averages[key] += player[key] || 0));
            statKeys.forEach(key => averages[key] = parseFloat((averages[key] / latestStats.length).toFixed(1)));
            return averages;
        };

        window.showSinglePlayerChart = (playerName) => {
            const playerStat = latestStats.find(s => s.playerName === playerName.toLowerCase());
            if (!playerStat) return;

            const allianceAverages = calculateAllianceAverages();
            chartModalTitle.textContent = `Stat Comparison for ${playerName}`;
            
            const statKeys = ['infAttack', 'infDefense', 'infLethality', 'infHp', 'cavAttack', 'cavDefense', 'cavLethality', 'cavHp', 'arcAttack', 'arcDefense', 'arcLethality', 'arcHp'];
            const labels = ['Inf Atk', 'Inf Def', 'Inf Let', 'Inf HP', 'Cav Atk', 'Cav Def', 'Cav Let', 'Cav HP', 'Arc Atk', 'Arc Def', 'Arc Let', 'Arc HP'];
            
            const datasets = [{
                label: playerName,
                data: statKeys.map(key => playerStat[key]),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }, {
                label: 'Alliance Average',
                data: statKeys.map(key => allianceAverages[key]),
                backgroundColor: 'rgba(107, 114, 128, 0.7)',
                borderColor: 'rgba(107, 114, 128, 1)',
                borderWidth: 1
            }];
            
            const ctx = document.getElementById('comparison-chart-canvas').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#e5e7eb' } } }
                }
            });
            chartModal.classList.remove('hidden');
        };
        
        const showComparisonChart = () => {
            if (selectedForComparison.length === 0) return;
            
            const allianceAverages = calculateAllianceAverages();
            chartModalTitle.textContent = `Comparing ${selectedForComparison.length} players`;
            
            const statKeys = ['infAttack', 'infDefense', 'infLethality', 'infHp', 'cavAttack', 'cavDefense', 'cavLethality', 'cavHp', 'arcAttack', 'arcDefense', 'arcLethality', 'arcHp'];
            const labels = ['Inf Atk', 'Inf Def', 'Inf Let', 'Inf HP', 'Cav Atk', 'Cav Def', 'Cav Let', 'Cav HP', 'Arc Atk', 'Arc Def', 'Arc Let', 'Arc HP'];
            
            const playerColors = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(139, 92, 246, 0.7)'];
            const borderColors = ['rgba(59, 130, 246, 1)', 'rgba(239, 68, 68, 1)', 'rgba(245, 158, 11, 1)', 'rgba(16, 185, 129, 1)', 'rgba(139, 92, 246, 1)'];
            
            const datasets = selectedForComparison.map((playerName, index) => {
                const playerStat = latestStats.find(s => s.playerName === playerName);
                return {
                    label: playerName,
                    data: playerStat ? statKeys.map(key => playerStat[key]) : [],
                    backgroundColor: playerColors[index % playerColors.length],
                    borderColor: borderColors[index % borderColors.length],
                    borderWidth: 1
                };
            });

            datasets.push({
                label: 'Alliance Average',
                data: statKeys.map(key => allianceAverages[key]),
                backgroundColor: 'rgba(107, 114, 128, 0.7)',
                borderColor: 'rgba(107, 114, 128, 1)',
                borderWidth: 1
            });
            
            const ctx = document.getElementById('comparison-chart-canvas').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } }
                    },
                    plugins: { legend: { labels: { color: '#e5e7eb' } } }
                }
            });

            chartModal.classList.remove('hidden');
        };
        
        compareBtn.onclick = showComparisonChart;
        chartModalCloseBtn.onclick = () => chartModal.classList.add('hidden');

        window.handleCompareSelect = (checkbox) => {
            const playerName = checkbox.value;
            if (checkbox.checked) {
                if(selectedForComparison.length < 5) selectedForComparison.push(playerName);
            } else {
                selectedForComparison = selectedForComparison.filter(p => p !== playerName);
            }
            
            compareBtn.textContent = `Compare Selected (${selectedForComparison.length})`;
            compareBtn.disabled = selectedForComparison.length === 0;
            
            // Re-render to update checkbox disabled states
            renderTable();
        };
        
        window.sortStats = (column) => {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = (['playerName', 'rank'].includes(column)) ? 'asc' : 'desc';
            }
            sortAndRender();
        };

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
"
we should make the title shorter

