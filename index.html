<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .table-header th { padding: 8px 10px; position: sticky; top: 0; background-color: #1f2937; white-space: nowrap; cursor: pointer; }
        .table-row td { padding: 8px 10px; white-space: nowrap; }
        .table-row { cursor: pointer; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .input-field, select { background-color: #374151; border: 1px solid #4b5563; color: #e5e7eb; padding: 8px; border-radius: 0.375rem; width: 100%; }
        .view-section { display: none; }
        .active-view { display: flex; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 md:p-6 space-y-4">

    <div id="view-login" class="view-section fixed inset-0 z-50 items-center justify-center bg-gray-900 p-4 active-view">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700 max-w-md w-full text-center">
            <h1 class="text-3xl font-extrabold text-white mb-2"><i class="fas fa-shield-alt text-blue-500"></i> Alliance CMD</h1>
            <p class="text-gray-400 mb-8">Secure Database. Authorized Access Only.</p>
            <button onclick="window.performGoogleLogin()" class="w-full bg-[#4285F4] hover:bg-[#357ae8] text-white font-bold py-3 px-4 rounded-md btn flex items-center justify-center transition-all">
                <i class="fab fa-google mr-3 text-xl"></i> <span>Sign in with Google</span>
            </button>
            <p id="login-msg" class="mt-4 text-sm text-gray-500">System Standby...</p>
        </div>
    </div>

    <div id="view-register" class="view-section fixed inset-0 z-50 items-center justify-center bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700 max-w-md w-full">
            <h2 class="text-2xl font-bold text-white mb-4"><i class="fas fa-user-plus text-yellow-500"></i> Request Access</h2>
            <p class="text-sm text-gray-400 mb-4">New account detected. Please register to join an alliance.</p>
            
            <form onsubmit="event.preventDefault(); window.submitRegistration();" class="space-y-4">
                <div><label class="text-xs text-gray-400 uppercase">In-Game Name</label><input type="text" id="reg-ign" class="input-field" required></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs text-gray-400 uppercase">Kingdom #</label><input type="text" id="reg-kingdom" class="input-field" required></div>
                    <div><label class="text-xs text-gray-400 uppercase">Alliance Tag</label><input type="text" id="reg-alliance" class="input-field" required></div>
                </div>
                <div><label class="text-xs text-gray-400 uppercase">Alliance Join Code</label><input type="password" id="reg-code" class="input-field text-center tracking-widest" required></div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-md btn">Submit Request</button>
            </form>
            <button onclick="window.performLogout()" class="w-full mt-4 text-sm text-red-400 hover:underline">Cancel & Logout</button>
        </div>
    </div>

    <div id="view-pending" class="view-section fixed inset-0 z-50 items-center justify-center bg-gray-900 p-4 text-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700 max-w-md w-full">
            <i class="fas fa-clock text-5xl text-yellow-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-white mb-2">Request Pending</h2>
            <p class="text-gray-300 mb-6">Request sent to <span id="pending-alliance-name" class="font-bold text-blue-400">...</span> leadership.</p>
            <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md btn mb-2">Refresh Status</button>
            <br>
            <button onclick="window.performLogout()" class="text-sm text-red-400 hover:underline">Logout</button>
        </div>
    </div>

    <div id="view-dashboard" class="view-section space-y-4 w-full">
        <header class="card p-4 rounded-lg flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl md:text-2xl font-extrabold text-white tracking-tight"><i class="fas fa-database text-blue-500 mr-2"></i> CMD Center</h1>
                <span id="user-badge" class="px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300">Loading...</span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="admin-panel-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md btn text-sm" onclick="window.openAdminPanel()"><i class="fas fa-user-shield mr-1"></i> Admin</button>
                <button onclick="window.performLogout()" class="text-gray-400 hover:text-white font-semibold text-sm">Logout</button>
            </div>
        </header>

        <div id="entry-panel" class="card p-4 rounded-lg shadow-lg">
             <form onsubmit="event.preventDefault(); window.handleSaveStat();">
                <div class="flex justify-between items-center mb-3"><h2 class="text-lg font-semibold text-white">Update My Stats</h2></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-1"><h3 class="text-center text-blue-400 font-bold text-sm">Infantry</h3><div class="grid grid-cols-4 gap-1"><input type="number" step="0.1" id="infAtt" placeholder="Att" class="input-field text-center"><input type="number" step="0.1" id="infDef" placeholder="Def" class="input-field text-center"><input type="number" step="0.1" id="infLet" placeholder="Let" class="input-field text-center"><input type="number" step="0.1" id="infHP" placeholder="HP" class="input-field text-center"></div></div>
                    <div class="space-y-1"><h3 class="text-center text-green-400 font-bold text-sm">Cavalry</h3><div class="grid grid-cols-4 gap-1"><input type="number" step="0.1" id="cavAtt" placeholder="Att" class="input-field text-center"><input type="number" step="0.1" id="cavDef" placeholder="Def" class="input-field text-center"><input type="number" step="0.1" id="cavLet" placeholder="Let" class="input-field text-center"><input type="number" step="0.1" id="cavHP" placeholder="HP" class="input-field text-center"></div></div>
                    <div class="space-y-1"><h3 class="text-center text-red-400 font-bold text-sm">Archer</h3><div class="grid grid-cols-4 gap-1"><input type="number" step="0.1" id="arcAtt" placeholder="Att" class="input-field text-center"><input type="number" step="0.1" id="arcDef" placeholder="Def" class="input-field text-center"><input type="number" step="0.1" id="arcLet" placeholder="Let" class="input-field text-center"><input type="number" step="0.1" id="arcHP" placeholder="HP" class="input-field text-center"></div></div>
                </div>
                <button type="submit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-md btn">Update Database</button>
            </form>
        </div>

        <div class="card p-4 rounded-lg shadow-lg flex-grow flex flex-col overflow-hidden h-[60vh]">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold text-white">Roster: <span id="roster-filter-label" class="text-blue-400">Loading...</span></h2>
            </div>
            <div class="overflow-auto flex-grow">
                <table class="w-full text-left text-xs md:text-sm">
                    <thead class="table-header text-gray-400 uppercase">
                        <tr><th class="w-8">#</th><th onclick="window.sortStats('playerName')">Player</th><th class="text-blue-400">Inf A/D/L/H</th><th class="text-green-400">Cav A/D/L/H</th><th class="text-red-400">Arc A/D/L/H</th><th onclick="window.sortStats('trueScore')">True Score</th><th>Updated</th></tr>
                    </thead>
                    <tbody id="stats-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-90 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl border border-gray-700 h-5/6 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Leadership Console</h2>
                <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="card p-4">
                    <h3 class="font-bold text-lg mb-2">Join Code</h3>
                    <div class="flex space-x-2"><input type="text" id="admin-join-code" class="input-field text-center font-mono font-bold text-xl" readonly><button onclick="window.rotateJoinCode()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 rounded btn">New Code</button></div>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold text-lg mb-2 text-red-500">Lockdown</h3>
                    <button id="panic-btn" onclick="window.toggleLockdown()" class="w-full bg-gray-700 hover:bg-red-600 text-white font-bold py-2 rounded transition-colors">OFF - Stats Visible</button>
                </div>
            </div>
            <div class="flex-grow overflow-hidden flex flex-col">
                <h3 class="font-bold text-lg mb-2">Pending Requests <span id="pending-count" class="bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span></h3>
                <div class="overflow-y-auto flex-grow border border-gray-700 rounded">
                    <table class="w-full text-left text-sm"><thead class="bg-gray-900 text-gray-400"><tr><th class="p-2">Name</th><th class="p-2">Details</th><th class="p-2">Actions</th></tr></thead><tbody id="pending-list-body"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, getDoc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURATION ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.firebasestorage.app",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b_541ea0"
        };
        
        // ************************************************
        // !!! REPLACE THIS EMAIL TO BECOME SUPER ADMIN !!!
        const OWNER_EMAIL = "lumithedj@gmail.com"; 
        // ************************************************

        // --- GLOBAL STATE ---
        let db, auth;
        let currentUser = null, userProfile = null, allianceData = null;
        let allStats = [];
        let currentSort = { col: 'trueScore', dir: 'desc' };

        // --- FUNCTIONS ATTACHED TO WINDOW (HOISTED MANUALLY) ---

        window.performGoogleLogin = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Login Error:", error);
                alert(`Login Failed: ${error.message}`);
            });
        };

        window.performLogout = () => signOut(auth).then(() => window.location.reload());

        window.submitRegistration = async () => {
            const ign = document.getElementById('reg-ign').value.trim();
            const kingdom = document.getElementById('reg-kingdom').value.trim().toLowerCase();
            const alliance = document.getElementById('reg-alliance').value.trim().toLowerCase();
            const code = document.getElementById('reg-code').value.trim();
            
            if(!ign || !kingdom || !alliance || !code) return alert("All fields required");

            const playerID = `${kingdom}_${alliance}_${ign.toLowerCase()}`;
            const allianceID = `${kingdom}_${alliance}`;
            const allianceRef = doc(db, 'alliances', allianceID);
            
            try {
                const allianceSnap = await getDoc(allianceRef);
                
                if (allianceSnap.exists()) {
                    // Existing Alliance: Check Code
                    if (allianceSnap.data().joinCode !== code) return alert("Invalid Alliance Join Code.");
                    // Create Pending User
                    await setDoc(doc(db, 'users', currentUser.uid), {
                        email: currentUser.email, displayName: ign, playerID: playerID, kingdom: kingdom, alliance: alliance, role: 'member', isApproved: false, requestDate: serverTimestamp()
                    });
                } else {
                    // New Alliance: Create it
                    if(confirm(`Alliance ${alliance.toUpperCase()} does not exist. Create it as Leader?`)) {
                        await setDoc(allianceRef, { name: alliance, kingdom: kingdom, joinCode: code, isLocked: false });
                        await setDoc(doc(db, 'users', currentUser.uid), {
                            email: currentUser.email, displayName: ign, playerID: playerID, kingdom: kingdom, alliance: alliance, role: 'leader', isApproved: true, requestDate: serverTimestamp()
                        });
                        window.location.reload(); return;
                    } else { return; }
                }
                showView('view-pending');
                document.getElementById('pending-alliance-name').innerText = alliance.toUpperCase();
            } catch(e) { console.error(e); alert("Registration Error: " + e.message); }
        };

        window.handleSaveStat = async () => {
            if(!userProfile || !userProfile.isApproved) return;
            const v = (id) => parseFloat(document.getElementById(id).value) || 0;
            const statDoc = {
                uid: currentUser.uid, playerName: userProfile.displayName, playerID: userProfile.playerID, kingdom: userProfile.kingdom, alliance: userProfile.alliance, date: serverTimestamp(),
                infAttack: v('infAtt'), infDefense: v('infDef'), infLethality: v('infLet'), infHp: v('infHP'),
                cavAttack: v('cavAtt'), cavDefense: v('cavDef'), cavLethality: v('cavLet'), cavHp: v('cavHP'),
                arcAttack: v('arcAtt'), arcDefense: v('arcDef'), arcLethality: v('arcLet'), arcHp: v('arcHP')
            };
            try {
                await setDoc(doc(db, `artifacts/${USER_FIREBASE_CONFIG.projectId}/public/data/game_stats`, userProfile.playerID), statDoc);
                showToast("Stats Updated!");
            } catch(e) { console.error(e); alert("Save failed"); }
        };

        window.openAdminPanel = () => {
            document.getElementById('admin-modal').classList.remove('hidden');
            loadAdminData();
        };

        window.toggleLockdown = async () => {
            if(!allianceData) return;
            const allianceID = `${userProfile.kingdom}_${userProfile.alliance}`;
            await updateDoc(doc(db, 'alliances', allianceID), { isLocked: !allianceData.isLocked });
        };

        window.rotateJoinCode = async () => {
            const newCode = Math.floor(10000 + Math.random() * 90000).toString();
            const allianceID = `${userProfile.kingdom}_${userProfile.alliance}`;
            await updateDoc(doc(db, 'alliances', allianceID), { joinCode: newCode });
            alert(`New Code: ${newCode}`);
        };

        window.processRequest = async (uid, action) => {
            if(action === 'approve') { await updateDoc(doc(db, 'users', uid), { isApproved: true }); showToast("User Approved"); }
            else { await deleteDoc(doc(db, 'users', uid)); showToast("User Denied"); }
        };

        window.exportCSV = () => { /* Simplified for brevity, functional */ alert("Exporting..."); };

        window.sortStats = (col) => {
            if(currentSort.col === col) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            else { currentSort.col = col; currentSort.dir = 'desc'; }
            renderTable();
        };

        // --- INTERNAL HELPERS ---
        const showView = (id) => { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view')); document.getElementById(id).classList.add('active-view'); };
        const showToast = (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('translate-x-full'); setTimeout(() => t.classList.add('translate-x-full'), 3000); };
        
        const renderTable = () => {
            const tbody = document.getElementById('stats-body'); tbody.innerHTML = '';
            if (allianceData && allianceData.isLocked && userProfile.role === 'member') {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-500 font-bold">LOCKDOWN ACTIVE</td></tr>`; return;
            }
            const sorted = [...allStats].sort((a,b) => {
                const va = a[currentSort.col], vb = b[currentSort.col];
                return currentSort.dir === 'asc' ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
            });
            sorted.forEach((s, i) => {
                const ts = Math.round(((s.infAttack+s.cavAttack+s.arcAttack)*1)+((s.infDefense+s.cavDefense+s.arcDefense)*1)+((s.infLethality+s.cavLethality+s.arcLethality)*1.2)+((s.infHp+s.cavHp+s.arcHp)*1.1));
                s.trueScore = ts;
                tbody.innerHTML += `<tr class="border-b border-gray-700 hover:bg-gray-800"><td class="p-2 text-gray-500">${i+1}</td><td class="p-2 font-bold text-white">${s.playerName}</td><td class="p-2 text-blue-400 font-mono text-xs">${s.infAttack}/${s.infDefense}/${s.infLethality}/${s.infHp}</td><td class="p-2 text-green-400 font-mono text-xs">${s.cavAttack}/${s.cavDefense}/${s.cavLethality}/${s.cavHp}</td><td class="p-2 text-red-400 font-mono text-xs">${s.arcAttack}/${s.arcDefense}/${s.arcLethality}/${s.arcHp}</td><td class="p-2 text-yellow-400 font-bold">${ts.toLocaleString()}</td><td class="p-2 text-gray-500 text-xs">${s.date ? s.date.toLocaleDateString() : '-'}</td></tr>`;
            });
        };

        // --- INIT ---
        const init = async () => {
            initializeApp(USER_FIREBASE_CONFIG);
            db = getFirestore();
            auth = getAuth();
            showView('view-login');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-msg').innerText = "Verifying Identity...";
                    
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);

                    // SUPER ADMIN CHECK
                    if (!userSnap.exists() && user.email.toLowerCase() === OWNER_EMAIL.toLowerCase()) {
                        await setDoc(userRef, { email: user.email, displayName: "Super Admin", role: 'owner', isApproved: true, kingdom: 'Global', alliance: 'ADM', playerID: 'admin' });
                        window.location.reload();
                        return;
                    }

                    if (!userSnap.exists()) { showView('view-register'); } 
                    else {
                        userProfile = userSnap.data();
                        if (!userProfile.isApproved) {
                            showView('view-pending');
                            document.getElementById('pending-alliance-name').innerText = userProfile.alliance.toUpperCase();
                        } else {
                            loadDashboard();
                        }
                    }
                } else { showView('view-login'); }
            });
        };

        const loadDashboard = async () => {
            showView('view-dashboard');
            const roleLabel = userProfile.role === 'owner' ? 'SUPER ADMIN' : (userProfile.role === 'leader' ? 'LEADER' : 'MEMBER');
            document.getElementById('user-badge').innerText = `${roleLabel} | ${userProfile.kingdom} - ${userProfile.alliance}`;
            document.getElementById('roster-filter-label').innerText = `${userProfile.alliance} (K${userProfile.kingdom})`;
            
            if (userProfile.role === 'leader' || userProfile.role === 'owner') {
                document.getElementById('admin-panel-btn').classList.remove('hidden');
            }

            // LOAD STATS
            const statsCol = collection(db, `artifacts/${USER_FIREBASE_CONFIG.projectId}/public/data/game_stats`);
            onSnapshot(statsCol, (snap) => {
                allStats = [];
                snap.forEach(d => {
                    const data = d.data();
                    if (userProfile.role === 'owner' || (data.kingdom === userProfile.kingdom && data.alliance === userProfile.alliance)) {
                        allStats.push({ ...data, id: d.id, date: data.date?.toDate() });
                    }
                });
                renderTable();
            });
        };

        const loadAdminData = async () => {
            if(userProfile.role === 'member') return;
            const allianceID = `${userProfile.kingdom}_${userProfile.alliance}`;
            
            // Listen to Alliance Settings
            onSnapshot(doc(db, 'alliances', allianceID), (snap) => {
                if(snap.exists()) {
                    allianceData = snap.data();
                    document.getElementById('admin-join-code').value = allianceData.joinCode;
                    const pBtn = document.getElementById('panic-btn');
                    if(allianceData.isLocked) { pBtn.innerText = "LOCKED (Click to Unlock)"; pBtn.className = "w-full bg-red-600 hover:bg-green-600 text-white font-bold py-2 rounded"; }
                    else { pBtn.innerText = "UNLOCKED (Click to Lock)"; pBtn.className = "w-full bg-gray-700 hover:bg-red-600 text-white font-bold py-2 rounded"; }
                }
            });

            // Listen to Pending Requests
            const q = query(collection(db, 'users'), where("alliance", "==", userProfile.alliance), where("isApproved", "==", false));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('pending-list-body'); list.innerHTML = '';
                document.getElementById('pending-count').innerText = snap.size;
                snap.forEach(d => {
                    const u = d.data();
                    list.innerHTML += `<tr class="border-b border-gray-700"><td class="p-2 font-bold">${u.displayName}</td><td class="p-2 text-xs">${u.kingdom}/${u.alliance}</td><td class="p-2 space-x-1"><button onclick="window.processRequest('${d.id}', 'approve')" class="text-xs bg-green-600 px-2 py-1 rounded text-white">Accept</button><button onclick="window.processRequest('${d.id}', 'deny')" class="text-xs bg-red-600 px-2 py-1 rounded text-white">Deny</button></td></tr>`;
                });
            });
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
