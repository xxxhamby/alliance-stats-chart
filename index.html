<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 0.3rem; width: 100%; transition: border-color 0.2s; font-size: 0.875rem; }
        .input-field:focus { border-color: #3b82f6; outline: none; }
        .tier-card { cursor: pointer; background: #1e293b; border: 1px solid #334155; padding: 6px 2px; text-align: center; border-radius: 4px; font-size: 10px; font-weight: bold; transition: all 0.1s; user-select: none; }
        .tier-card:hover { border-color: #64748b; }
        .tier-card.selected-tier { background: #1e3a8a; border-color: #60a5fa; color: white; }
        .tier-card.selected-tg { background: #422006; border-color: #eab308; color: #facc15; }
        .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: bold; font-size: 0.875rem; transition: all 0.2s; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { border-color: #eab308; color: #eab308; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="app-root" class="min-h-screen flex flex-col"></div>
    <div id="modal-root" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit, where, startAt, endAt, getCountFromServer, addDoc, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ... CONFIG ...

        const State = {
            // ... (Same State Object) ...
            // NEW: Track last rendered view to prevent redraws
            lastView: null 
        };

        const App = {
            // ... (Init & HandleAuth same) ...

            // OPTIMIZED RENDERER
            render: () => {
                // 1. If View Changed, Full Re-Draw
                if (State.current !== State.lastView) {
                    const views = { /* ... (Same Views) ... */ };
                    
                    // Add IDs to table bodies for targeted updates
                    views.dashboard = views.dashboard.replace('<tbody class="divide-y divide-slate-700">', '<tbody id="leaderboard-body" class="divide-y divide-slate-700">');
                    views.allianceManager = views.allianceManager.replace('<tbody class="divide-y divide-slate-700">', '<tbody id="roster-body" class="divide-y divide-slate-700">');
                    
                    document.getElementById('app-root').innerHTML = views[State.current];
                    State.lastView = State.current;
                    
                    // Init logic
                    if (State.current === 'register' || State.current === 'editor') App.ui.initEditor();
                    if (State.current === 'owner') App.actions.initOwnerView();
                    if (State.current === 'allianceManager') {
                        if (State.managerTab === 'roster') App.actions.loadRoster();
                        if (State.managerTab === 'recruit') App.actions.loadFreelancers();
                    }
                } 
                // 2. If View Same, Partial Update handled by specific functions
            },

            // NEW: Targeted Table Update (No Flicker)
            renderTableOnly: () => {
                let tbody = null;
                let html = '';

                if (State.current === 'dashboard') {
                    tbody = document.getElementById('leaderboard-body');
                    html = App.ui.renderRows();
                } else if (State.current === 'allianceManager') {
                    if (State.managerTab === 'roster') {
                        tbody = document.getElementById('roster-body');
                        // Re-use logic for roster rows...
                        html = State.roster.map(m => `<tr class="hover:bg-slate-700 cursor-pointer" onclick="window.viewProfile('${m.id}')"><td class="p-3 font-bold text-white">${m.ign} <span class="text-slate-500 text-xs font-mono">#${m.pid}</span></td><td class="p-3 text-slate-300">${m.kingdom}</td><td class="p-3 text-right">${m.id === State.user.uid ? '<span class="text-xs text-green-500 font-bold">LEADER</span>' : `<button onclick="event.stopPropagation(); window.kickMember('${m.id}', '${m.ign}')" class="text-red-400 hover:text-red-300 text-xs font-bold border border-red-900 bg-red-900/20 px-2 py-1 rounded">KICK</button>`}</td></tr>`).join('');
                    } else if (State.managerTab === 'recruit') {
                        const tbl = document.querySelector('tbody'); // Recruit table
                        if(tbl) {
                            tbl.innerHTML = State.freelancers.length === 0 ? '<tr><td colspan="3" class="p-4 text-center text-slate-500">No freelancers found.</td></tr>' : State.freelancers.map(m => { const t = m.troops; return `<tr class="hover:bg-slate-700 cursor-pointer" onclick="window.viewProfile('${m.id}')"><td class="p-3 font-bold text-white">${m.ign} <span class="text-slate-500 text-xs font-mono">#${m.pid}</span></td><td class="p-3 text-slate-300">${m.kingdom}</td><td class="p-3 text-xs"><span class="text-blue-400">I:${t?.inf?.tier}</span> <span class="text-green-400">C:${t?.cav?.tier}</span></td></tr>` }).join('');
                            return;
                        }
                    }
                }

                if (tbody) tbody.innerHTML = html;
            },

            // ... (UI Helpers same) ...

            actions: {
                loadLeaderboard: async () => {
                    try {
                        let q = collection(App.db, 'profiles');
                        // ... (Query Logic) ...
                        
                        const snap = await getDocs(q);
                        State.leaderboard = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        
                        // FIX: Call Partial Update instead of Render
                        App.renderTableOnly(); 
                        
                    } catch (e) { console.error("Load Error", e); }
                },
                
                // ... (Other actions update similarly) ...
            }
        };
        // ...
    
</body>
</html>
