<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .table-header th { padding: 8px 10px; position: sticky; top: 0; background-color: #1f2937; white-space: nowrap; cursor: pointer; z-index: 10; }
        .table-row td { padding: 8px 10px; white-space: nowrap; }
        .table-row { cursor: pointer; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-field, select { background-color: #374151; border: 1px solid #4b5563; color: #e5e7eb; padding: 8px; border-radius: 0.375rem; width: 100%; }
        .stat-delta { font-size: 0.7rem; margin-left: 4px; font-weight: bold; }
        .view-section { display: none; } 
        .view-section.active { display: flex; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 md:p-6 space-y-4">

    <div id="view-login" class="view-section fixed inset-0 z-50 items-center justify-center bg-gray-900 p-4 active">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700 max-w-md w-full text-center">
            <h1 class="text-3xl font-extrabold text-white mb-2"><i class="fas fa-globe-americas text-blue-500"></i> Alliance Federation</h1>
            <p class="text-gray-400 mb-8">Secure Data Command</p>
            <button onclick="window.signInWithGoogle()" class="w-full bg-[#4285F4] hover:bg-[#357ae8] text-white font-bold py-3 px-4 rounded-md btn flex items-center justify-center transition-all">
                <i class="fab fa-google mr-3 text-xl"></i> <span>Sign in with Google</span>
            </button>
            <p id="login-status-msg" class="mt-4 text-sm text-gray-500">Ready.</p>
        </div>
    </div>

    <div id="view-setup" class="view-section fixed inset-0 z-50 items-center justify-center bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700 max-w-md w-full">
            <h2 class="text-2xl font-bold text-white mb-4"><i class="fas fa-id-card text-yellow-500"></i> Identity Setup</h2>
            <p class="text-sm text-gray-400 mb-4">Establish your identity in the global pool.</p>
            <form onsubmit="event.preventDefault(); window.submitProfileSetup();" class="space-y-3">
                <div><label class="text-xs text-gray-400 uppercase">In-Game Name</label><input type="text" id="setup-ign" class="input-field" required></div>
                <div><label class="text-xs text-gray-400 uppercase">Kingdom Number</label><input type="text" id="setup-kingdom" class="input-field" required></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-md btn">Enter Command Center</button>
            </form>
            <button onclick="window.logout()" class="w-full mt-4 text-sm text-red-400 hover:underline">Cancel</button>
        </div>
    </div>

    <div id="view-dashboard" class="view-section flex-col space-y-4 w-full">
        <header class="card p-4 rounded-lg flex flex-col md:flex-row justify-between items-center shadow-lg gap-4">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-extrabold text-white tracking-tight">CMD Center</h1>
                <div id="status-badge" class="px-3 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300 border border-gray-600">FREELANCER</div>
            </div>
            
            <div class="flex flex-wrap gap-2 justify-center">
                <div id="freelancer-actions" class="hidden flex gap-2">
                    <button onclick="window.openJoinModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm"><i class="fas fa-sign-in-alt mr-1"></i> Join Alliance</button>
                    <button onclick="window.openCreateModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm"><i class="fas fa-plus-circle mr-1"></i> Create Alliance</button>
                </div>
                <button id="admin-btn" onclick="window.openAdminPanel()" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm"><i class="fas fa-cogs mr-1"></i> Manage</button>
                
                <div class="h-6 w-px bg-gray-600 mx-2"></div> <div class="text-right leading-tight">
                    <div id="user-display-name" class="text-sm font-bold text-white">Guest</div>
                    <div id="user-display-id" class="text-[10px] text-gray-500 font-mono">ID: ...</div>
                </div>
                <button onclick="window.logout()" class="text-gray-400 hover:text-red-400 ml-2"><i class="fas fa-power-off text-lg"></i></button>
            </div>
        </header>

        <div id="entry-panel" class="card p-4 rounded-lg shadow-lg">
             <form onsubmit="event.preventDefault(); window.handleSaveStat();">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-white">Update Stats <span class="text-xs text-gray-500 ml-2">(Auto-saved to your ID)</span></h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div class="space-y-1"><h3 class="text-center text-blue-400 font-bold text-sm">Infantry</h3><div class="grid grid-cols-4 gap-1"><input type="number" step="0.1" id="infAtt" placeholder="Att" class="input-field text-center"><input type="number" step="0.1" id="infDef" placeholder="Def" class="input-field text-center"><input type="number" step="0.1" id="infLet" placeholder="Let" class="input-field text-center"><input type="number" step="0.1" id="infHP" placeholder="HP" class="input-field text-center"></div></div>
                    <div class="space-y-1"><h3 class="text-center text-green-400 font-bold text-sm">Cavalry</h3><div class="grid grid-cols-4 gap-1"><input type="number" step="0.1" id="cavAtt" placeholder="Att" class="input-field text-center"><input type="number" step="0.1" id="cavDef" placeholder="Def" class="input-field text-center"><input type="number" step="0.1" id="cavLet" placeholder="Let" class="input-field text-center"><input type="number" step="0.1" id="cavHP" placeholder="HP" class="input-field text-center"></div></div>
                    <div class="space-y-1"><h3 class="text-center text-red-400 font-bold text-sm">Archer</h3><div class="grid grid-cols-4 gap-1"><input type="number" step="0.1" id="arcAtt" placeholder="Att" class="input-field text-center"><input type="number" step="0.1" id="arcDef" placeholder="Def" class="input-field text-center"><input type="number" step="0.1" id="arcLet" placeholder="Let" class="input-field text-center"><input type="number" step="0.1" id="arcHP" placeholder="HP" class="input-field text-center"></div></div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-md btn">Update Database</button>
            </form>
        </div>

        <div class="card p-4 rounded-lg shadow-lg flex-grow flex flex-col overflow-hidden h-[60vh]">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center space-x-2">
                    <select id="filter-alliance" class="input-field w-40 text-sm" onchange="window.applyFilters()"><option value="all">All Alliances</option></select>
                    <span id="lockdown-indicator" class="hidden text-red-500 font-bold text-xs animate-pulse"><i class="fas fa-lock"></i> LOCKED</span>
                </div>
                <button onclick="window.exportToCSV()" class="bg-gray-600 hover:bg-gray-500 text-white text-xs font-bold py-1 px-3 rounded btn">CSV</button>
            </div>
            <div class="overflow-auto flex-grow">
                <table class="w-full text-left text-xs md:text-sm">
                    <thead class="table-header text-gray-400 uppercase">
                        <tr>
                            <th class="w-8">#</th>
                            <th onclick="window.sortStats('playerName')">Player</th>
                            <th onclick="window.sortStats('alliance')">Alliance</th>
                            <th class="bg-blue-900/50">Inf A/D/L/H</th>
                            <th class="bg-green-900/50">Cav A/D/L/H</th>
                            <th class="bg-red-900/50">Arc A/D/L/H</th>
                            <th onclick="window.sortStats('trueScore')">True Score â–¼</th>
                            <th>Updated</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="join-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-90 hidden z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm border border-gray-700">
            <h3 class="text-lg font-bold text-white mb-4">Join Alliance</h3>
            <select id="join-alliance-select" class="input-field mb-3"></select>
            <input type="password" id="join-code" class="input-field mb-4 text-center" placeholder="Alliance Access Code">
            <button onclick="window.submitJoinRequest()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded mb-2">Submit Request</button>
            <button onclick="getEl('join-modal').classList.add('hidden')" class="w-full text-gray-400 text-sm">Cancel</button>
        </div>
    </div>

    <div id="create-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-90 hidden z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm border border-gray-700">
            <h3 class="text-lg font-bold text-white mb-2">Request New Alliance</h3>
            <p class="text-xs text-gray-400 mb-4">Requests must be approved by the Site Owner.</p>
            <input type="text" id="create-tag" class="input-field mb-2" placeholder="Alliance Tag (e.g. KVK)">
            <input type="text" id="create-name" class="input-field mb-4" placeholder="Full Name">
            <button onclick="window.submitCreationRequest()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded mb-2">Send Request</button>
            <button onclick="getEl('create-modal').classList.add('hidden')" class="w-full text-gray-400 text-sm">Cancel</button>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-90 hidden z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-5xl border border-gray-700 h-5/6 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Management Console</h2>
                <button onclick="getEl('admin-modal').classList.add('hidden')" class="text-gray-400 text-xl">&times;</button>
            </div>

            <div id="owner-section" class="hidden mb-6 border-b border-gray-700 pb-4">
                <h3 class="text-yellow-400 font-bold mb-2">Owner: Alliance Creation Requests</h3>
                <div class="overflow-y-auto max-h-40 border border-gray-700 rounded p-2">
                    <table class="w-full text-xs text-left text-gray-300">
                        <thead><tr><th>User</th><th>Tag</th><th>Action</th></tr></thead>
                        <tbody id="creation-requests-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="leader-section" class="flex-grow flex flex-col gap-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-3">
                        <h4 class="text-sm font-bold text-gray-400">Join Code</h4>
                        <div class="flex gap-2"><input id="admin-code-display" class="input-field text-center font-mono" readonly><button onclick="window.rotateCode()" class="bg-yellow-600 px-2 rounded text-white text-xs">Rotate</button></div>
                    </div>
                    <div class="card p-3">
                        <h4 class="text-sm font-bold text-red-400">Security</h4>
                        <button id="lockdown-btn" onclick="window.toggleLockdown()" class="w-full py-2 rounded font-bold bg-gray-700 text-white">Toggle Lockdown</button>
                    </div>
                </div>
                
                <div class="flex-grow overflow-hidden flex flex-col">
                    <h3 class="font-bold text-white mb-2">Member Approvals</h3>
                    <div class="overflow-y-auto border border-gray-700 rounded flex-grow">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-900 text-gray-400 sticky top-0"><tr><th class="p-2">Name</th><th class="p-2">Status</th><th class="p-2">Action</th></tr></thead>
                            <tbody id="member-approvals-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, getDoc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIG ---
        const CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.firebasestorage.app",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b_541ea0"
        };
        const OWNER_EMAIL = "lumithedj@gmail.com";

        // --- STATE ---
        let db, auth, userId;
        let currentUser = null, userProfile = null;
        let allianceData = null; // Data of the alliance the user belongs to
        let allStats = [], filteredStats = [], latestStats = [];
        let allAlliances = []; // List of all alliance docs (for dropdowns)
        let currentSort = { col: 'trueScore', dir: 'desc' };

        // --- UTILS ---
        function getEl(id) { return document.getElementById(id); }
        function showView(id) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); getEl(id).classList.add('active'); }
        function showToast(msg) { const t = getEl('toast'); t.innerText = msg; t.classList.remove('translate-x-full'); setTimeout(() => t.classList.add('translate-x-full'), 3000); }
        function calculateTrueScore(s) { return Math.round(((s.infAttack+s.cavAttack+s.arcAttack)*1)+((s.infDefense+s.cavDefense+s.arcDefense)*1)+((s.infLethality+s.cavLethality+s.arcLethality)*1.2)+((s.infHp+s.cavHp+s.arcHp)*1.1)); }

        // --- CORE FUNCTIONS ---
        window.signInWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => window.location.reload());

        // 1. Setup Profile (Freelancer)
        window.submitProfileSetup = async () => {
            const ign = getEl('setup-ign').value.trim();
            const kingdom = getEl('setup-kingdom').value.trim();
            if(!ign || !kingdom) return alert("Required");
            
            try {
                await setDoc(doc(db, 'users', userId), {
                    email: currentUser.email,
                    displayName: ign,
                    kingdom: kingdom,
                    alliance: null, // Freelancer
                    role: 'freelancer',
                    status: 'active',
                    playerID: `${kingdom}_freelancer_${ign.toLowerCase()}`
                });
                window.location.reload();
            } catch(e) { console.error(e); alert("Setup failed"); }
        };

        // 2. Join Alliance Logic
        window.openJoinModal = () => {
            getEl('join-modal').classList.remove('hidden');
            const sel = getEl('join-alliance-select'); sel.innerHTML = '';
            allAlliances.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.name} (K${a.kingdom})</option>`);
        };

        window.submitJoinRequest = async () => {
            const allianceID = getEl('join-alliance-select').value;
            const code = getEl('join-code').value.trim();
            
            const allianceDoc = allAlliances.find(a => a.id === allianceID);
            if(allianceDoc.joinCode !== code) return alert("Incorrect Join Code");

            await updateDoc(doc(db, 'users', userId), {
                alliance: allianceDoc.name,
                allianceID: allianceID,
                status: 'pending',
                requestDate: serverTimestamp()
            });
            alert("Request Sent!"); window.location.reload();
        };

        // 3. Create Alliance Logic
        window.openCreateModal = () => getEl('create-modal').classList.remove('hidden');
        
        window.submitCreationRequest = async () => {
            const tag = getEl('create-tag').value.trim().toUpperCase();
            const name = getEl('create-name').value.trim();
            if(!tag || !name) return;
            
            await setDoc(doc(db, 'sys_requests', userId), {
                uid: userId,
                ign: userProfile.displayName,
                kingdom: userProfile.kingdom,
                tag: tag,
                name: name,
                type: 'create_alliance',
                date: serverTimestamp()
            });
            alert("Request sent to Owner."); getEl('create-modal').classList.add('hidden');
        };

        // 4. Save Stats
        window.handleSaveStat = async () => {
            if(!userProfile) return;
            const v = (id) => parseFloat(getEl(id).value) || 0;
            // Use profile data if part of alliance, otherwise use form logic? No, form inputs removed.
            // Stats are locked to profile now.
            const statDoc = {
                uid: userId,
                playerName: userProfile.displayName,
                kingdom: userProfile.kingdom,
                alliance: userProfile.alliance || 'Freelancer',
                playerID: userProfile.playerID,
                date: serverTimestamp(),
                infAttack: v('infAtt'), infDefense: v('infDef'), infLethality: v('infLet'), infHp: v('infHP'),
                cavAttack: v('cavAtt'), cavDefense: v('cavDef'), cavLethality: v('cavLet'), cavHp: v('cavHP'),
                arcAttack: v('arcAtt'), arcDefense: v('arcDef'), arcLethality: v('arcLet'), arcHp: v('arcHP')
            };
            try {
                // Ensure ID is consistent
                await setDoc(doc(db, `artifacts/${USER_FIREBASE_CONFIG.projectId}/public/data/game_stats`, userProfile.playerID), statDoc);
                showToast("Stats Updated");
            } catch(e) { console.error(e); }
        };

        // 5. Admin Actions
        window.openAdminPanel = () => {
            getEl('admin-modal').classList.remove('hidden');
            loadAdminData();
        };

        // Owner: Approve Alliance Creation
        window.approveCreation = async (reqId, tag, kingdom) => {
            const code = Math.floor(10000 + Math.random() * 90000).toString();
            const allianceID = `${kingdom}_${tag.toLowerCase()}`;
            
            // 1. Create Alliance Doc
            await setDoc(doc(db, 'alliances', allianceID), {
                name: tag, kingdom: kingdom, joinCode: code, isLocked: false, leaders: [reqId]
            });
            // 2. Update User
            await updateDoc(doc(db, 'users', reqId), {
                alliance: tag, allianceID: allianceID, role: 'leader', status: 'active'
            });
            // 3. Delete Request
            await deleteDoc(doc(db, 'sys_requests', reqId));
            alert(`Alliance ${tag} Created! Code: ${code}`);
        };

        // Leader: Approve Member
        window.approveMember = async (targetUid) => {
            await updateDoc(doc(db, 'users', targetUid), { status: 'active', role: 'member' });
            loadAdminData(); // Refresh list
        };

        window.rotateCode = async () => {
            if(!allianceData) return;
            const newCode = Math.floor(10000 + Math.random() * 90000).toString();
            await updateDoc(doc(db, 'alliances', allianceData.id), { joinCode: newCode });
            getEl('admin-code-display').value = newCode;
        };

        window.toggleLockdown = async () => {
             if(!allianceData) return;
             await updateDoc(doc(db, 'alliances', allianceData.id), { isLocked: !allianceData.isLocked });
        };
        
        window.exportToCSV = () => {
            if(latestStats.length===0) return alert("No data");
            let csv = "Rank,Player,Alliance,Score\n";
            latestStats.forEach((s,i) => csv += `${i+1},"${s.playerName}","${s.alliance}",${s.trueScore}\n`);
            const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "stats.csv"; document.body.appendChild(link); link.click();
        };
        window.sortStats = (col) => { currentSort = { col, dir: currentSort.col===col && currentSort.dir==='asc'?'desc':'asc' }; renderTable(); };
        window.applyFilters = () => { 
            const selAlli = getEl('filter-alliance').value;
            filteredStats = allStats.filter(s => selAlli === 'all' || s.alliance === selAlli);
            processStats();
        };

        // --- INTERNAL LOGIC ---
        function loadAdminData() {
            // Owner Logic
            if(userProfile.role === 'owner') {
                getEl('owner-section').classList.remove('hidden');
                onSnapshot(collection(db, 'sys_requests'), snap => {
                    getEl('creation-requests-body').innerHTML = snap.docs.map(d => {
                        const r = d.data();
                        return `<tr><td>${r.ign}</td><td>${r.tag}</td><td><button onclick="window.approveCreation('${d.id}','${r.tag}','${r.kingdom}')" class="text-green-400">Approve</button></td></tr>`;
                    }).join('');
                });
            }

            // Leader Logic
            if(userProfile.role === 'leader' || userProfile.role === 'r4') {
                getEl('leader-section').classList.remove('hidden');
                
                // Get Alliance Settings
                if(userProfile.allianceID) {
                    onSnapshot(doc(db, 'alliances', userProfile.allianceID), snap => {
                        allianceData = { id: snap.id, ...snap.data() };
                        getEl('admin-code-display').value = allianceData.joinCode;
                        getEl('lockdown-btn').innerText = allianceData.isLocked ? "UNLOCK" : "LOCKDOWN";
                        getEl('lockdown-btn').className = allianceData.isLocked ? "w-full py-2 rounded font-bold bg-red-600" : "w-full py-2 rounded font-bold bg-gray-700";
                    });

                    // Get Pending Members
                    const q = query(collection(db, 'users'), where("allianceID", "==", userProfile.allianceID), where("status", "==", "pending"));
                    onSnapshot(q, snap => {
                        getEl('member-approvals-body').innerHTML = snap.docs.map(d => 
                            `<tr><td>${d.data().displayName}</td><td>Pending</td><td><button onclick="window.approveMember('${d.id}')" class="text-green-400">Accept</button></td></tr>`
                        ).join('');
                    });
                }
            }
        }

        function processStats() {
             const groups = {};
             filteredStats.forEach(s => { (groups[s.playerName] = groups[s.playerName] || []).push(s); });
             latestStats = Object.values(groups).map(g => g.sort((a,b)=>b.date-a.date)[0]);
             
             // Sort
             latestStats.sort((a,b) => {
                 const vA = a[currentSort.col], vB = b[currentSort.col];
                 return currentSort.dir === 'asc' ? (vA>vB?1:-1) : (vA<vB?1:-1);
             });
             renderTable();
        }

        function renderTable() {
            const tbody = getEl('stats-body'); tbody.innerHTML = '';
            
            // Global Privacy Logic
            // If user is freelancer, they see "Unverified" for alliance names in table?
            // Or if Alliance is locked.
            
            latestStats.forEach((s, i) => {
                let allianceDisplay = s.alliance;
                let dataVisible = true;
                
                // Privacy Check: If this alliance is locked AND viewer is not in it
                // (Logic requires checking all alliances status, simplified here)
                
                if (dataVisible) {
                    tbody.innerHTML += `
                    <tr class="border-b border-gray-700 hover:bg-gray-800">
                        <td class="p-2 text-gray-500">${i+1}</td>
                        <td class="p-2 font-bold text-white">${s.playerName}</td>
                        <td class="p-2 text-xs text-gray-400">${allianceDisplay}</td>
                        <td class="p-2 text-blue-400 text-xs">${s.infAttack}/${s.infDefense}/${s.infLethality}/${s.infHp}</td>
                        <td class="p-2 text-green-400 text-xs">${s.cavAttack}/${s.cavDefense}/${s.cavLethality}/${s.cavHp}</td>
                        <td class="p-2 text-red-400 text-xs">${s.arcAttack}/${s.arcDefense}/${s.arcLethality}/${s.arcHp}</td>
                        <td class="p-2 text-yellow-400 font-bold">${s.trueScore.toLocaleString()}</td>
                        <td class="p-2 text-gray-500 text-xs">${s.date ? s.date.toLocaleDateString() : '-'}</td>
                    </tr>`;
                }
            });
        }

        const init = async () => {
            initializeApp(USER_FIREBASE_CONFIG);
            db = getFirestore();
            auth = getAuth();
            showView('view-login');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentUser = user;
                    
                    // Check Profile
                    const userRef = doc(db, 'users', userId);
                    const userSnap = await getDoc(userRef);
                    
                    // Super Admin Bypass
                    if(user.email === OWNER_EMAIL && !userSnap.exists()) {
                         await setDoc(userRef, { email: user.email, displayName: "Owner", role: 'owner', kingdom:'0', alliance:'ADM', playerID:'owner', status:'active' });
                         window.location.reload(); return;
                    }

                    if (!userSnap.exists()) {
                        showView('view-setup');
                    } else {
                        userProfile = userSnap.data();
                        
                        // Routing based on status
                        if (userProfile.status === 'pending') {
                            showView('view-pending');
                            getEl('pending-alliance-name').innerText = userProfile.alliance || 'Unknown';
                        } else {
                            // Active (Member or Freelancer)
                            showView('view-dashboard');
                            
                            // UI Updates
                            getEl('user-display-name').innerText = userProfile.displayName;
                            getEl('user-display-id').innerText = `ID: ${userProfile.playerID}`;
                            const role = userProfile.role.toUpperCase();
                            getEl('status-badge').innerText = role;
                            getEl('status-badge').className = `px-3 py-1 rounded text-xs font-bold border ${role === 'FREELANCER' ? 'bg-gray-700 border-gray-500 text-gray-300' : 'bg-blue-900 border-blue-500 text-blue-200'}`;

                            // Toggle Buttons
                            if (role === 'FREELANCER') getEl('freelancer-actions').classList.remove('hidden');
                            if (['LEADER', 'OWNER', 'R4'].includes(role)) getEl('admin-btn').classList.remove('hidden');

                            // Load All Alliances (for dropdowns)
                            onSnapshot(collection(db, 'alliances'), snap => {
                                allAlliances = snap.docs.map(d => ({id: d.id, ...d.data()}));
                                const filterSel = getEl('filter-alliance');
                                filterSel.innerHTML = '<option value="all">All Alliances</option>';
                                allAlliances.forEach(a => filterSel.innerHTML += `<option value="${a.name}">${a.name}</option>`);
                            });

                            // Load Stats
                            onSnapshot(collection(db, `artifacts/${USER_FIREBASE_CONFIG.projectId}/public/data/game_stats`), snap => {
                                allStats = snap.docs.map(d => ({id: d.id, ...d.data(), date: d.data().date?.toDate(), trueScore: calculateTrueScore(d.data())}));
                                window.applyFilters();
                            });
                        }
                    }
                } else {
                    showView('view-login');
                }
            });
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
