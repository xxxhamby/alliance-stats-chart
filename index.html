<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 0.3rem; width: 100%; font-size: 0.875rem; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; outline: none; }
        .tier-card { cursor: pointer; background: #1e293b; border: 1px solid #334155; padding: 4px; text-align: center; border-radius: 4px; font-size: 10px; font-weight: bold; transition: all 0.1s; user-select: none; }
        .tier-card:hover { border-color: #64748b; }
        .tier-card.selected-tier { background: #1e3a8a; border-color: #60a5fa; color: white; }
        .tier-card.selected-tg { background: #422006; border-color: #eab308; color: #facc15; }
        .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: bold; font-size: 0.875rem; transition: all 0.2s; cursor: pointer; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { border-color: #eab308; color: #eab308; }
        .nav-link { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; color: #94a3b8; transition: all 0.2s; }
        .nav-link:hover { color: white; background: #1e293b; }
        .nav-link.active { color: white; background: #3b82f6; }
        .stat-delta { font-size: 0.65rem; margin-left: 2px; font-weight: bold; }
        .stat-table th { white-space: nowrap; padding: 8px; background: #1e293b; position: sticky; top: 0; z-index: 10; cursor: pointer; user-select: none; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #334155; }
        .stat-table td { white-space: nowrap; padding: 6px 8px; border-bottom: 1px solid #1e293b; font-size: 0.75rem; text-align: center; }
        .stat-table tr:hover { background-color: #1e293b; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="app-root" class="min-h-screen flex flex-col"></div>
    <div id="modal-root" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit, where, startAt, endAt, getCountFromServer, addDoc, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.firebasestorage.app",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b_541ea0"
        };

        const State = {
            user: null, dbUser: null,
            profile: null, alliance: null,
            data: { global: [], alliance: [], roster: [], freelancers: [], history: [] },
            stats: { totalProfiles: 0 },
            selection: new Set(),
            current: 'loading',
            lastView: null,
            previousView: 'view_global', // Default fallback
            viewMode: 'global', // 'alliance' or 'global' - SYNCED WITH VIEW
            managerTab: 'roster',
            filters: { ign: '', kingdom: '' },
            sort: { field: 'trueScore', dir: 'desc' }, 
            config: { lockdown: false, accessCode: '' },
            listeners: { security: null },
            form: {
                ign: '', kingdom: '', pid: '',
                privacy: { hideName: false, hideStats: false },
                troops: { inf: { tier: 10, tg: 0 }, cav: { tier: 10, tg: 0 }, arc: { tier: 10, tg: 0 } },
                stats: { inf: { att:0,def:0,let:0,hp:0 }, cav: { att:0,def:0,let:0,hp:0 }, arc: { att:0,def:0,let:0,hp:0 } }
            }
        };

        const App = {
            db: null, auth: null, chartInstance: null,

            init: () => {
                const app = initializeApp(CONFIG);
                App.db = getFirestore(app);
                App.auth = getAuth(app);
                onAuthStateChanged(App.auth, App.handleAuth);
            },

            handleAuth: async (user) => {
                State.user = user;
                if (!user) {
                    State.current = localStorage.getItem('acc_gate_token') ? 'login' : 'gate';
                } else {
                    try {
                        const userSnap = await getDoc(doc(App.db, 'users', user.uid));
                        if (userSnap.exists()) State.dbUser = userSnap.data();
                        else await setDoc(doc(App.db, 'users', user.uid), { email: user.email, role: 'member', createdAt: serverTimestamp() });

                        const profileSnap = await getDoc(doc(App.db, 'profiles', user.uid));
                        
                        // Listen for config changes (Lockdown)
                        if (!State.listeners.security) {
                            State.listeners.security = onSnapshot(doc(App.db, 'metadata', 'security'), (snap) => {
                                if(snap.exists()) {
                                    State.config = snap.data();
                                    App.render();
                                }
                            });
                        }

                        if (!profileSnap.exists()) {
                            State.current = 'register';
                            State.form = { ign: '', kingdom: '', pid: '', privacy: {hideName: false, hideStats: false}, troops: { inf: {tier:10, tg:0}, cav: {tier:10, tg:0}, arc: {tier:10, tg:0} }, stats: { inf: { att:0,def:0,let:0,hp:0 }, cav: { att:0,def:0,let:0,hp:0 }, arc: { att:0,def:0,let:0,hp:0 } } };
                        } else {
                            State.profile = profileSnap.data();
                            if (State.profile.allianceID) {
                                const allySnap = await getDoc(doc(App.db, 'alliances', State.profile.allianceID));
                                if (allySnap.exists()) State.alliance = { id: allySnap.id, ...allySnap.data() };
                            }
                            
                            // DEFAULT ROUTING
                            if (State.profile.allianceID) {
                                State.current = 'view_alliance';
                                State.viewMode = 'alliance';
                                State.previousView = 'view_alliance';
                                await App.actions.loadRoster();
                            } else {
                                State.current = 'view_global';
                                State.viewMode = 'global';
                                State.previousView = 'view_global';
                                await App.actions.loadLeaderboard();
                            }
                            App.actions.loadPersonalHistory();
                        }
                    } catch (e) { console.error("Boot Error", e); }
                }
                App.render();
            },

            render: () => {
                if (State.current === State.lastView && !['view_global', 'view_alliance'].includes(State.current)) return;

                const allianceBtnText = State.profile?.allianceID ? 'My Alliance' : 'Join Alliance';
                
                // LOCKDOWN BANNER
                const lockdownBanner = State.config.lockdown 
                    ? `<div class="bg-red-600 text-white text-center text-xs font-bold py-1 tracking-widest"><i class="fas fa-lock mr-2"></i>GLOBAL LOCKDOWN ACTIVE - EDITS DISABLED</div>` 
                    : '';

                const navBar = `
                    ${lockdownBanner}
                    <nav class="bg-slate-800 border-b border-slate-700 p-3 sticky top-0 z-20 shadow-md">
                        <div class="max-w-7xl mx-auto flex justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="window.navTo('view_global')" class="nav-link ${State.current === 'view_global' ? 'active' : ''}"><i class="fas fa-globe mr-2"></i>Global</button>
                                <button onclick="window.navTo('view_alliance')" class="nav-link ${State.current === 'view_alliance' ? 'active' : ''}"><i class="fas fa-users mr-2"></i>${allianceBtnText}</button>
                            </div>
                            <div class="flex gap-3 items-center">
                                ${State.dbUser?.role === 'owner' ? `<button onclick="window.openOwner()" class="text-red-500 hover:text-white" title="God Mode"><i class="fas fa-shield-alt"></i></button>` : ''}
                                <button onclick="window.showHelp()" class="text-yellow-400 hover:text-white" title="Help"><i class="fas fa-question-circle"></i></button>
                                <div class="flex items-center gap-2 border-l border-slate-600 pl-3">
                                    <img src="${State.user?.photoURL || ''}" class="w-6 h-6 rounded-full border border-slate-500">
                                    <span class="text-sm font-bold text-white hidden md:block">${State.profile?.ign}</span>
                                </div>
                                <button onclick="window.openEditor()" class="text-blue-400 hover:text-white" title="Edit Profile"><i class="fas fa-cog"></i></button>
                                <button onclick="window.triggerLogout()" class="text-red-500 hover:text-white ml-2" title="Logout"><i class="fas fa-power-off"></i></button>
                            </div>
                        </div>
                    </nav>`;

                const views = {
                    loading: `<div class="flex flex-col items-center justify-center h-screen bg-slate-900 text-white"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i><h2 class="font-bold tracking-widest">LOADING...</h2></div>`,
                    
                    gate: `<div class="flex flex-col items-center justify-center h-screen bg-slate-900 p-6"><div class="bg-slate-800 p-8 rounded-lg border-t-4 border-red-500 max-w-md w-full text-center shadow-2xl"><i class="fas fa-dungeon text-5xl text-red-500 mb-4"></i><h1 class="text-2xl font-bold text-white mb-2">Restricted Access</h1><p class="text-slate-400 text-xs mb-4">This system is protected. Enter the global access code.</p><form onsubmit="event.preventDefault(); window.submitGate()"><input type="password" id="gate-input" name="gate-code" class="input-field text-center text-xl tracking-[0.5em] font-mono mb-4" placeholder="•••••"><button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow-lg">AUTHORIZE</button></form></div></div>`,
                    
                    login: `<div class="flex flex-col items-center justify-center h-screen bg-slate-900 p-4"><div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-sm w-full text-center border-t-4 border-blue-500"><h1 class="text-2xl font-bold text-white mb-2">Alliance Command</h1><button onclick="window.triggerLogin()" class="w-full bg-white hover:bg-gray-100 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-2 mt-6"><i class="fab fa-google text-red-500"></i> Sign in</button></div></div>`,
                    
                    register: `<div class="min-h-screen bg-slate-900 p-4 flex justify-center"><div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-lg w-full h-fit border-t-4 border-yellow-500"><h2 class="text-xl font-bold text-white mb-4">Initial Setup</h2>${App.ui.editorForm('Register')}</div></div>`,
                    
                    editor: `
                        <div class="min-h-screen bg-slate-900 p-4 flex justify-center">
                            <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-lg w-full h-fit border-t-4 border-blue-500">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-white">Update Profile</h2>
                                    <button onclick="window.cancelEdit()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
                                </div>
                                ${App.ui.editorForm('Save Changes')}
                                <div class="mt-4 border-t border-slate-700 pt-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-bold text-white text-sm"><i class="fas fa-chart-line text-green-500 mr-2"></i>Growth History</h3>
                                        <button onclick="window.openHistory()" class="text-xs text-slate-400 hover:text-white">Full Log</button>
                                    </div>
                                    <div class="h-40"><canvas id="growth-chart"></canvas></div>
                                </div>
                            </div>
                        </div>`,
                    
                    owner: `<div class="min-h-screen bg-slate-900 p-6"><header class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold text-red-500 uppercase tracking-widest"><i class="fas fa-crown mr-3"></i>God Mode</h1><button onclick="window.cancelEdit()" class="text-slate-400 hover:text-white">Exit</button></header><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-slate-800 p-6 rounded border-l-4 border-red-500"><h3 class="text-xl font-bold text-white mb-4">Security Override</h3><div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Current Gate Code</label><div id="owner-global-code" class="text-3xl font-mono text-yellow-400 tracking-widest mt-1">${State.config.accessCode || '...'}</div></div><button onclick="window.ownerRotateCode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded mb-6"><i class="fas fa-random mr-2"></i>Generate Random Code</button><div class="border-t border-slate-700 pt-4"><label class="text-xs text-slate-400 uppercase font-bold mb-2 block">Emergency Protocol</label><button onclick="window.ownerToggleLockdown()" class="w-full py-3 rounded font-bold transition ${State.config.lockdown ? 'bg-red-600 animate-pulse text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">${State.config.lockdown ? '⚠️ LOCKDOWN ACTIVE (UNLOCK)' : 'ACTIVATE LOCKDOWN'}</button></div></div><div class="bg-slate-800 p-6 rounded border-l-4 border-blue-500"><h3 class="text-xl font-bold text-white mb-4">Database Intelligence</h3><div class="text-4xl font-bold text-white" id="stat-count">${State.stats.totalProfiles}</div><div class="text-sm text-slate-400 mb-4">Active Profiles</div></div></div></div>`,
                    
                    allianceManager: `<div class="min-h-screen bg-slate-900 p-6"><header class="flex justify-between items-center mb-6"><div><h1 class="text-2xl font-bold text-yellow-500 uppercase tracking-widest"><i class="fas fa-users-cog mr-3"></i>Alliance Manager</h1><p class="text-sm text-slate-400">Managing: <span class="text-white font-bold">[${State.alliance?.tag}]</span> ${State.alliance?.name}</p></div><div class="flex gap-2">${State.dbUser?.role === 'owner' ? `<button onclick="window.openOwner()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded font-bold text-sm shadow-lg animate-pulse" title="Admin Panel"><i class="fas fa-user-shield"></i></button>` : ''}<button onclick="window.cancelEdit()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-arrow-left mr-2"></i>Back</button></div></header><div class="flex border-b border-slate-700 mb-6"><button onclick="window.switchManagerTab('roster')" class="tab-btn ${State.managerTab === 'roster' ? 'active' : ''}">Roster</button><button onclick="window.switchManagerTab('settings')" class="tab-btn ${State.managerTab === 'settings' ? 'active' : ''}">Settings</button><button onclick="window.switchManagerTab('recruit')" class="tab-btn ${State.managerTab === 'recruit' ? 'active' : ''}">Recruit</button></div><div id="manager-content">${State.managerTab === 'roster' ? App.ui.managerRoster() : (State.managerTab === 'settings' ? App.ui.managerSettings() : App.ui.managerRecruit())}</div></div>`,

                    view_global: `
                        <div class="min-h-screen bg-slate-900 text-slate-200">
                            ${navBar}
                            <div class="p-4 max-w-7xl mx-auto">
                                <div class="bg-slate-800 rounded shadow border border-slate-700">
                                    <div class="p-4 border-b border-slate-700 bg-slate-900 flex flex-col md:flex-row gap-4 items-center">
                                        <div class="text-white font-bold text-lg"><i class="fas fa-globe-americas text-blue-500 mr-2"></i>Global Rankings</div>
                                        <div class="flex-grow w-full md:w-auto relative"><i class="fas fa-search absolute left-3 top-3 text-slate-500"></i><input type="text" name="search-ign" oninput="window.handleSearch(this.value)" placeholder="Search Commander..." class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full pl-10 p-2.5 outline-none focus:border-blue-500"></div>
                                        <div class="flex gap-2 w-full md:w-auto"><div class="relative w-24"><input type="text" name="search-kingdom" id="filter-kingdom" oninput="window.handleKingdom(this.value)" placeholder="K#" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5 outline-none focus:border-blue-500 text-center"><button onclick="window.clearKingdom()" class="absolute right-2 top-2 text-slate-500 hover:text-white">&times;</button></div><button onclick="window.refreshData()" class="text-blue-400 hover:text-white px-3"><i class="fas fa-sync"></i></button></div>
                                        <button onclick="window.compareSelected()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-chart-bar mr-1"></i> Compare (<span id="compare-count">0</span>)</button>
                                    </div>
                                    <div class="overflow-x-auto"><table class="w-full stat-table"><thead class="bg-slate-900 text-slate-400"><tr><th class="pl-2 w-8"><input type="checkbox" onchange="window.toggleSelectAll(this)"></th><th onclick="window.setSort('ign')" class="text-left pl-3">Commander</th><th onclick="window.setSort('kingdom')">K#</th><th onclick="window.setSort('allianceID')">Alli</th><th class="text-blue-400" onclick="window.setSort('stats.inf.att')">I.Att</th><th class="text-blue-400" onclick="window.setSort('stats.inf.def')">I.Def</th><th class="text-blue-400" onclick="window.setSort('stats.inf.let')">I.Let</th><th class="text-blue-400" onclick="window.setSort('stats.inf.hp')">I.HP</th><th class="text-green-400" onclick="window.setSort('stats.cav.att')">C.Att</th><th class="text-green-400" onclick="window.setSort('stats.cav.def')">C.Def</th><th class="text-green-400" onclick="window.setSort('stats.cav.let')">C.Let</th><th class="text-green-400" onclick="window.setSort('stats.cav.hp')">C.HP</th><th class="text-red-400" onclick="window.setSort('stats.arc.att')">A.Att</th><th class="text-red-400" onclick="window.setSort('stats.arc.def')">A.Def</th><th class="text-red-400" onclick="window.setSort('stats.arc.let')">A.Let</th><th class="text-red-400" onclick="window.setSort('stats.arc.hp')">A.HP</th><th class="text-yellow-400" onclick="window.setSort('trueScore')">Score ▼</th><th>Updated</th></tr></thead><tbody id="global-body" class="divide-y divide-slate-800">${App.ui.renderRows(State.data.global)}</tbody></table></div>
                                </div>
                            </div>
                        </div>`,

                    view_alliance: `
                        <div class="min-h-screen bg-slate-900 text-slate-200">
                            ${navBar}
                            <div class="p-4 max-w-7xl mx-auto">
                                ${App.ui.allianceCard()}
                                ${State.profile?.allianceID ? `
                                <div class="bg-slate-800 rounded shadow border border-slate-700 mt-6">
                                    <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-center">
                                        <div class="text-white font-bold text-lg flex items-center gap-2"><i class="fas fa-users text-yellow-500"></i>Alliance Roster</div>
                                        <div class="flex gap-2">
                                            <button onclick="window.openAllianceAnalytics()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded text-xs font-bold"><i class="fas fa-chart-pie mr-1"></i> Analytics</button>
                                            <button onclick="window.compareSelected()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap"><i class="fas fa-chart-bar mr-1"></i> Compare (<span id="compare-count">0</span>)</button>
                                            <button onclick="window.refreshData()" class="text-blue-400 hover:text-white px-3"><i class="fas fa-sync"></i></button>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto"><table class="w-full stat-table"><thead class="bg-slate-900 text-slate-400"><tr><th class="pl-2 w-8"><input type="checkbox" onchange="window.toggleSelectAll(this)"></th><th onclick="window.setSort('ign')" class="text-left pl-3">Commander</th><th onclick="window.setSort('kingdom')">K#</th><th class="text-blue-400" onclick="window.setSort('stats.inf.att')">I.Att</th><th class="text-blue-400" onclick="window.setSort('stats.inf.def')">I.Def</th><th class="text-blue-400" onclick="window.setSort('stats.inf.let')">I.Let</th><th class="text-blue-400" onclick="window.setSort('stats.inf.hp')">I.HP</th><th class="text-green-400" onclick="window.setSort('stats.cav.att')">C.Att</th><th class="text-green-400" onclick="window.setSort('stats.cav.def')">C.Def</th><th class="text-green-400" onclick="window.setSort('stats.cav.let')">C.Let</th><th class="text-green-400" onclick="window.setSort('stats.cav.hp')">C.HP</th><th class="text-red-400" onclick="window.setSort('stats.arc.att')">A.Att</th><th class="text-red-400" onclick="window.setSort('stats.arc.def')">A.Def</th><th class="text-red-400" onclick="window.setSort('stats.arc.let')">A.Let</th><th class="text-red-400" onclick="window.setSort('stats.arc.hp')">A.HP</th><th class="text-yellow-400" onclick="window.setSort('trueScore')">Score ▼</th><th>Updated</th></tr></thead><tbody id="alliance-body" class="divide-y divide-slate-800">${App.ui.renderRows(State.data.roster)}</tbody></table></div>
                                </div>` : ''}
                            </div>
                        </div>`
                };
                document.getElementById('app-root').innerHTML = views[State.current];
                State.lastView = State.current;

                if (State.current === 'register' || State.current === 'editor') App.ui.initEditor();
                if (State.current === 'editor') App.ui.renderGrowthChart();
                if (State.current === 'owner') App.actions.initOwnerView();
            },

            renderTableOnly: () => {
                if (State.current === 'view_global') {
                    const tbody = document.getElementById('global-body');
                    if(tbody) tbody.innerHTML = App.ui.renderRows(State.data.global);
                } else if (State.current === 'view_alliance') {
                    const tbody = document.getElementById('alliance-body');
                    if(tbody) tbody.innerHTML = App.ui.renderRows(State.data.roster);
                } else if (State.current === 'allianceManager') {
                    if (State.managerTab === 'roster') {
                        const tbody = document.getElementById('roster-body');
                        if(tbody) tbody.innerHTML = App.ui.generateManagerRosterRows(State.data.roster);
                    } else if (State.managerTab === 'recruit') {
                        const tbody = document.getElementById('recruit-body');
                        if(tbody) tbody.innerHTML = App.ui.generateRecruitRows(State.data.freelancers);
                    }
                }
            },

            ui: {
                toast: (msg, type = 'info') => {
                    const el = document.createElement('div');
                    el.className = `bg-slate-800 text-white py-2 px-4 rounded shadow-lg border-l-4 ${type === 'error' ? 'border-red-500' : 'border-green-500'} animate-fade-in`;
                    el.innerText = msg;
                    document.getElementById('toast-container').appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                },

                generateManagerRosterRows: (rosterData) => {
                    return rosterData.map(m => {
                        const isLeader = m.id === State.user.uid;
                        const escapedIgn = m.ign.replace(/'/g, "\\'");
                        const actionBtn = isLeader 
                            ? '<span class="text-xs text-green-500 font-bold">LEADER</span>' 
                            : `<button onclick="event.stopPropagation(); window.kickMember('${m.id}', '${escapedIgn}')" class="text-red-400 hover:text-red-300 text-xs font-bold border border-red-900 bg-red-900/20 px-2 py-1 rounded">KICK</button>`;
                        
                        return `
                        <tr class="hover:bg-slate-700 cursor-pointer" onclick="window.viewProfile('${m.id}')">
                            <td class="p-3 font-bold text-white">${m.ign} <span class="text-slate-500 text-xs font-mono">#${m.pid}</span></td>
                            <td class="p-3 text-slate-300">${m.kingdom}</td>
                            <td class="p-3 text-yellow-400 font-bold">${Math.round(m.trueScore||0).toLocaleString()}</td>
                            <td class="p-3 text-right">${actionBtn}</td>
                        </tr>`;
                    }).join('');
                },

                generateRecruitRows: (freelancersData) => {
                    if (freelancersData.length === 0) return '<tr><td colspan="4" class="p-4 text-center text-slate-500">No freelancers found.</td></tr>';
                    return freelancersData.map(m => { 
                        const t = m.troops || {inf:{tier:10},cav:{tier:10}}; 
                        return `
                        <tr class="hover:bg-slate-700 cursor-pointer" onclick="window.viewProfile('${m.id}')">
                            <td class="p-3 font-bold text-white">${m.ign} <span class="text-slate-500 text-xs font-mono">#${m.pid}</span></td>
                            <td class="p-3 text-slate-300">${m.kingdom}</td>
                            <td class="p-3 text-yellow-400 font-bold">${Math.round(m.trueScore||0).toLocaleString()}</td>
                            <td class="p-3 text-xs"><span class="text-blue-400">I:T${t?.inf?.tier}</span> <span class="text-green-400">C:T${t?.cav?.tier}</span></td>
                        </tr>`;
                    }).join('');
                },

                managerRoster: () => {
                    return `
                    <div class="bg-slate-800 rounded shadow overflow-hidden">
                        <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-center">
                            <h3 class="font-bold text-white">Active Roster (${State.data.roster.length})</h3>
                            <span class="text-xs text-slate-500">Limit: 100</span>
                        </div>
                        <div class="overflow-x-auto h-96 overflow-y-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900 text-slate-400 uppercase text-[10px] sticky top-0">
                                    <tr>
                                        <th class="p-3">Commander</th>
                                        <th class="p-3">Kingdom</th>
                                        <th class="p-3">True Score</th>
                                        <th class="p-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="roster-body" class="divide-y divide-slate-700">
                                    ${App.ui.generateManagerRosterRows(State.data.roster)}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                },

                managerSettings: () => {
                    return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-800 p-6 rounded border-l-4 border-yellow-500">
                            <h3 class="font-bold text-white mb-4">General Settings</h3>
                            <div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Alliance Name</label><input type="text" name="set-name" id="set-name" class="input-field" value="${State.alliance.name}"></div>
                            <div class="mb-4"><label class="text-xs text-slate-400 uppercase font-bold">Public Description (MOTD)</label><textarea name="set-desc" id="set-desc" class="input-field h-24" placeholder="Alliance manifesto, rules, or discord link...">${State.alliance.description || ''}</textarea></div>
                            <button onclick="window.updateAlliance()" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded w-full">Save Changes</button>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-slate-800 p-6 rounded border-l-4 border-blue-500">
                                <h3 class="font-bold text-white mb-2">Access Control</h3>
                                <div class="mb-4"><label class="text-xs text-slate-400 uppercase font-
