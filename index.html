<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-field { background: #1e293b; border: 1px solid #334155; color: white; padding: 0.8rem; border-radius: 0.5rem; width: 100%; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; outline: none; }
        .tier-card { cursor: pointer; background: #1e293b; border: 1px solid #334155; padding: 6px 2px; text-align: center; border-radius: 4px; font-size: 10px; font-weight: bold; transition: all 0.1s; user-select: none; }
        .tier-card:hover { border-color: #64748b; }
        .tier-card.selected-tier { background: #1e3a8a; border-color: #60a5fa; color: white; }
        .tier-card.selected-tg { background: #422006; border-color: #eab308; color: #facc15; }
        .nav-link { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; color: #94a3b8; transition: all 0.2s; }
        .nav-link:hover { color: white; background: #1e293b; }
        .nav-link.active { color: white; background: #3b82f6; }
        .tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: bold; font-size: 0.875rem; transition: all 0.2s; cursor: pointer; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { border-color: #eab308; color: #eab308; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        th { cursor: pointer; user-select: none; padding: 0.75rem; text-align: center; font-size: 11px; white-space: nowrap; }
        th:hover { background: #1e293b; }
        td { padding: 0.5rem; text-align: center; font-size: 13px; }
    </style>
</head>
<body>

    <div id="app-root"></div>
    <div id="modal-root" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, serverTimestamp, query, orderBy, limit, where, startAt, endAt, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.firebasestorage.app",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b_541ea0"
        };

        const State = {
            user: null, dbUser: null, profile: null, alliance: null,
            data: { global: [], alliance: [], roster: [], freelancers: [] },
            view: 'loading',
            sort: { field: 'trueScore', dir: 'desc' },
            filters: { ign: '', kingdom: '' },
            form: { ign: '', kingdom: '', pid: '', privacy: { hideName: false, hideStats: false }, troops: { inf: { tier: 10, tg: 0 }, cav: { tier: 10, tg: 0 }, arc: { tier: 10, tg: 0 } }, stats: { inf: { att:0,def:0,let:0,hp:0 }, cav: { att:0,def:0,let:0,hp:0 }, arc: { att:0,def:0,let:0,hp:0 } } }
        };

        const App = {
            db: null, auth: null,

            init: () => {
                const app = initializeApp(CONFIG);
                App.db = getFirestore(app);
                App.auth = getAuth(app);
                onAuthStateChanged(App.auth, App.handleAuth);
            },

            handleAuth: async (user) => {
                State.user = user;
                if (!user) {
                    State.view = localStorage.getItem('acc_gate_token') ? 'login' : 'gate';
                    App.render();
                    return;
                }
                
                try {
                    const userSnap = await getDoc(doc(App.db, 'users', user.uid));
                    State.dbUser = userSnap.exists() ? userSnap.data() : await App.createUser();

                    const profileSnap = await getDoc(doc(App.db, 'profiles', user.uid));
                    if (!profileSnap.exists()) {
                        State.view = 'register';
                        App.render();
                        return;
                    }

                    State.profile = profileSnap.data();
                    if (State.profile.allianceID) {
                        const allySnap = await getDoc(doc(App.db, 'alliances', State.profile.allianceID));
                        if (allySnap.exists()) State.alliance = { id: allySnap.id, ...allySnap.data() };
                    }

                    State.view = 'dashboard';
                    App.render();
                    await App.loadData('global');
                } catch (e) { console.error("Boot Error", e); }
            },

            createUser: async () => {
                await setDoc(doc(App.db, 'users', State.user.uid), { email: State.user.email, role: 'member', createdAt: serverTimestamp() });
                return { role: 'member' };
            },

            render: () => {
                const root = document.getElementById('app-root');
                const views = {
                    loading: `<div class="flex items-center justify-center h-screen bg-slate-900"><i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i></div>`,
                    gate: `<div class="flex items-center justify-center h-screen bg-slate-900 p-6"><div class="bg-slate-800 p-8 rounded-lg border-t-4 border-red-500 max-w-md w-full text-center"><i class="fas fa-dungeon text-5xl text-red-500 mb-4"></i><h1 class="text-2xl font-bold text-white mb-2">Restricted Access</h1><form onsubmit="event.preventDefault(); App.submitGate()"><input type="password" id="gate-input" class="input-field text-center text-xl tracking-[0.5em] font-mono mb-4" placeholder="•••••"><button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded">AUTHORIZE</button></form></div></div>`,
                    login: `<div class="flex items-center justify-center h-screen bg-slate-900 p-4"><div class="bg-slate-800 p-8 rounded-lg max-w-sm w-full text-center border-t-4 border-blue-500"><h1 class="text-2xl font-bold text-white mb-6">Alliance Command</h1><button onclick="App.login()" class="w-full bg-white hover:bg-gray-100 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-2"><i class="fab fa-google text-red-500"></i> Sign in</button></div></div>`,
                    register: `<div class="min-h-screen bg-slate-900 p-4 flex justify-center"><div class="bg-slate-800 p-6 rounded-lg max-w-lg w-full border-t-4 border-yellow-500"><h2 class="text-xl font-bold text-white mb-4">Initial Setup</h2>${App.ui.editorForm('Register')}</div></div>`,
                    editor: `<div class="min-h-screen bg-slate-900 p-4 flex justify-center"><div class="bg-slate-800 p-6 rounded-lg max-w-lg w-full border-t-4 border-blue-500"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">Update Profile</h2><button onclick="App.closeEditor()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div>${App.ui.editorForm('Save')}</div></div>`,
                    dashboard: App.ui.dashboard()
                };
                root.innerHTML = views[State.view];
                if (State.view === 'register' || State.view === 'editor') App.ui.initEditor();
            },

            loadData: async (tab) => {
                try {
                    let q;
                    if (tab === 'global') {
                        if (State.filters.kingdom) q = query(collection(App.db, 'profiles'), where('kingdom', '==', State.filters.kingdom), limit(100));
                        else q = query(collection(App.db, 'profiles'), limit(100));
                    } else if (tab === 'alliance' && State.alliance) {
                        q = query(collection(App.db, 'profiles'), where('allianceID', '==', State.alliance.id), limit(100));
                    } else return;

                    const snap = await getDocs(q);
                    State.data[tab] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    App.updateTable(tab);
                } catch (e) { console.error(e); }
            },

            updateTable: (tab) => {
                const tbody = document.getElementById(`tbody-${tab}`);
                if (!tbody) return;
                tbody.innerHTML = App.ui.renderRows(State.data[tab]);
            },

            submitGate: async () => {
                const code = document.getElementById('gate-input').value.trim();
                try {
                    const snap = await getDoc(doc(App.db, 'metadata', 'security'));
                    if (snap.exists() && snap.data().accessCode === code) {
                        localStorage.setItem('acc_gate_token', 'valid');
                        State.view = 'login';
                        App.render();
                    } else App.ui.toast("Access Denied", "error");
                } catch(e) { App.ui.toast("Error", "error"); }
            },

            login: () => signInWithPopup(App.auth, new GoogleAuthProvider()),
            logout: () => signOut(App.auth).then(() => window.location.reload()),
            
            openEditor: () => {
                const p = State.profile;
                State.form = { 
                    ign: p.ign, kingdom: p.kingdom, pid: p.pid,
                    privacy: p.privacy || {hideName:false, hideStats:false},
                    troops: p.troops || { inf:{tier:10,tg:0}, cav:{tier:10,tg:0}, arc:{tier:10,tg:0} },
                    stats: p.stats || { inf:{att:0,def:0,let:0,hp:0}, cav:{att:0,def:0,let:0,hp:0}, arc:{att:0,def:0,let:0,hp:0} }
                };
                State.view = 'editor';
                App.render();
            },

            closeEditor: () => {
                State.view = 'dashboard';
                App.render();
            },

            saveProfile: async () => {
                const ign = document.getElementById('frm-ign').value.trim();
                const kingdom = document.getElementById('frm-kingdom').value.trim();
                const pid = document.getElementById('frm-pid').value.trim();
                if(!ign || !kingdom || !pid) return App.ui.toast("Missing fields", "error");

                const s = State.form.stats;
                const sum = (p) => parseFloat(s.inf[p]||0) + parseFloat(s.cav[p]||0) + parseFloat(s.arc[p]||0);
                const trueScore = Math.round((sum('att') + sum('def')) * 1.0 + sum('let') * 1.2 + sum('hp') * 1.1);

                try {
                    await setDoc(doc(App.db, 'profiles', State.user.uid), {
                        ign, kingdom, pid,
                        privacy: { 
                            hideName: document.getElementById('frm-hideName').checked,
                            hideStats: document.getElementById('frm-hideStats').checked
                        },
                        troops: State.form.troops,
                        stats: State.form.stats,
                        trueScore,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                    window.location.reload();
                } catch(e) { App.ui.toast("Save failed", "error"); }
            },

            switchTab: (tab) => {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                document.getElementById('tab-content').innerHTML = App.ui.tabContent(tab);
                if (!State.data[tab].length) App.loadData(tab);
                else App.updateTable(tab);
            },

            setSort: (field) => {
                State.sort = State.sort.field === field && State.sort.dir === 'desc' ? { field, dir: 'asc' } : { field, dir: 'desc' };
                const activeTab = document.querySelector('.nav-link.active')?.dataset.tab || 'global';
                App.updateTable(activeTab);
            },

            ui: {
                toast: (msg, type = 'info') => {
                    const el = document.createElement('div');
                    el.className = `bg-slate-800 text-white py-2 px-4 rounded border-l-4 ${type === 'error' ? 'border-red-500' : 'border-green-500'}`;
                    el.innerText = msg;
                    document.getElementById('toast-container').appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                },

                dashboard: () => `
                    <div class="min-h-screen bg-slate-900">
                        <nav class="bg-slate-800 border-b border-slate-700 p-3 sticky top-0 z-20">
                            <div class="max-w-6xl mx-auto flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button data-tab="global" onclick="App.switchTab('global')" class="nav-link active"><i class="fas fa-globe mr-2"></i>Global</button>
                                    <button data-tab="alliance" onclick="App.switchTab('alliance')" class="nav-link"><i class="fas fa-users mr-2"></i>${State.alliance ? 'Alliance' : 'Join Alliance'}</button>
                                </div>
                                <div class="flex gap-3 items-center">
                                    <span class="text-sm font-bold text-white">${State.profile?.ign}</span>
                                    <button onclick="App.openEditor()" class="text-blue-400 hover:text-white"><i class="fas fa-cog"></i></button>
                                    <button onclick="App.logout()" class="text-red-400 hover:text-white"><i class="fas fa-power-off"></i></button>
                                </div>
                            </div>
                        </nav>
                        <div class="p-4 max-w-7xl mx-auto">
                            <div id="tab-content">${App.ui.tabContent('global')}</div>
                        </div>
                    </div>
                `,

                tabContent: (tab) => {
                    if (tab === 'global') {
                        return `
                            <div class="bg-slate-800 rounded border border-slate-700">
                                <div class="p-4 border-b border-slate-700 bg-slate-900 flex gap-4 items-center">
                                    <h3 class="font-bold text-white text-lg"><i class="fas fa-globe text-blue-500 mr-2"></i>Global Rankings</h3>
                                    <input type="text" id="filter-kingdom" oninput="App.filterKingdom(this.value)" placeholder="Filter by Kingdom #" class="input-field py-2 w-48">
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-slate-900 text-slate-400">
                                            <tr>
                                                <th onclick="App.setSort('ign')" class="text-left">Commander</th>
                                                <th onclick="App.setSort('kingdom')">K#</th>
                                                <th onclick="App.setSort('trueScore')" class="text-yellow-400">Score ▼</th>
                                                <th class="text-blue-400" onclick="App.setSort('stats.inf.att')">I.Att</th>
                                                <th class="text-blue-400" onclick="App.setSort('stats.inf.def')">I.Def</th>
                                                <th class="text-green-400" onclick="App.setSort('stats.cav.att')">C.Att</th>
                                                <th class="text-green-400" onclick="App.setSort('stats.cav.def')">C.Def</th>
                                                <th class="text-red-400" onclick="App.setSort('stats.arc.att')">A.Att</th>
                                                <th class="text-red-400" onclick="App.setSort('stats.arc.def')">A.Def</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-global" class="divide-y divide-slate-700">${App.ui.renderRows(State.data.global)}</tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    } else if (tab === 'alliance') {
                        if (!State.alliance) {
                            return `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-slate-800 p-6 rounded border-l-4 border-blue-500">
                                        <h3 class="font-bold text-white mb-3">Join Alliance</h3>
                                        <div class="space-y-2">
                                            <input type="text" id="join-tag" placeholder="Alliance Tag" class="input-field">
                                            <input type="text" id="join-code" placeholder="Access Code" class="input-field">
                                            <button onclick="App.joinAlliance()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">Join</button>
                                        </div>
                                    </div>
                                    <div class="bg-slate-800 p-6 rounded border-l-4 border-green-500">
                                        <h3 class="font-bold text-white mb-3">Create Alliance</h3>
                                        <div class="space-y-2">
                                            <input type="text" id="create-tag" placeholder="TAG (4 chars)" class="input-field">
                                            <input type="text" id="create-name" placeholder="Full Name" class="input-field">
                                            <button onclick="App.createAlliance()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">Create</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        return `
                            <div class="bg-slate-800 p-4 rounded border-l-4 border-yellow-500 mb-6">
                                <div class="text-2xl font-bold text-white">[${State.alliance.tag}] ${State.alliance.name}</div>
                                <div class="text-sm text-slate-400">Kingdom ${State.alliance.kingdom}</div>
                            </div>
                            <div class="bg-slate-800 rounded border border-slate-700">
                                <div class="p-4 border-b border-slate-700 bg-slate-900">
                                    <h3 class="font-bold text-white text-lg"><i class="fas fa-users text-yellow-500 mr-2"></i>Alliance Roster</h3>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-slate-900 text-slate-400">
                                            <tr>
                                                <th onclick="App.setSort('ign')" class="text-left">Commander</th>
                                                <th onclick="App.setSort('kingdom')">K#</th>
                                                <th onclick="App.setSort('trueScore')" class="text-yellow-400">Score ▼</th>
                                                <th class="text-blue-400">I.Att</th>
                                                <th class="text-green-400">C.Att</th>
                                                <th class="text-red-400">A.Att</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-alliance" class="divide-y divide-slate-700">${App.ui.renderRows(State.data.alliance)}</tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                },

                renderRows: (dataset) => {
                    if (!dataset?.length) return '<tr><td colspan="10" class="p-6 text-center text-slate-500">No data</td></tr>';
                    
                    const sorted = [...dataset].sort((a,b) => {
                        const getVal = (obj, path) => path.split('.').reduce((o, i) => o?.[i], obj) || 0;
                        const valA = getVal(a, State.sort.field);
                        const valB = getVal(b, State.sort.field);
                        return State.sort.dir === 'asc' ? valA - valB : valB - valA;
                    });

                    return sorted.map(p => {
                        const s = p.stats || {inf:{att:0,def:0},cav:{att:0,def:0},arc:{att:0,def:0}};
                        return `
                            <tr class="hover:bg-slate-700 cursor-pointer" onclick="App.viewProfile('${p.id}')">
                                <td class="text-white font-bold text-left pl-3">${p.ign}</td>
                                <td class="text-slate-300">${p.kingdom}</td>
                                <td class="text-yellow-400 font-bold">${Math.round(p.trueScore||0).toLocaleString()}</td>
                                <td class="text-blue-300">${s.inf.att}%</td>
                                <td class="text-blue-300">${s.inf.def}%</td>
                                <td class="text-green-300">${s.cav.att}%</td>
                                <td class="text-green-300">${s.cav.def}%</td>
                                <td class="text-red-300">${s.arc.att}%</td>
                                <td class="text-red-300">${s.arc.def}%</td>
                            </tr>
                        `;
                    }).join('');
                },

                editorForm: (btn) => `
                    <form onsubmit="event.preventDefault(); App.saveProfile()">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="col-span-2"><label class="text-xs text-slate-400 uppercase font-bold">In-Game Name</label><input type="text" id="frm-ign" class="input-field" value="${State.form.ign}" required></div>
                            <div><label class="text-xs text-slate-400 uppercase font-bold">Kingdom</label><input type="number" id="frm-kingdom" class="input-field" value="${State.form.kingdom}" required></div>
                            <div><label class="text-xs text-slate-400 uppercase font-bold">Player ID</label><input type="number" id="frm-pid" class="input-field" value="${State.form.pid}" required></div>
                        </div>
                        <div class="bg-slate-900 p-3 rounded mb-4 flex gap-4">
                            <label class="flex items-center gap-2"><input type="checkbox" id="frm-hideName" ${State.form.privacy?.hideName ? 'checked' : ''}><span class="text-xs">Hide Name</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="frm-hideStats" ${State.form.privacy?.hideStats ? 'checked' : ''}><span class="text-xs">Hide Stats</span></label>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${App.ui.statBlock('inf','I','text-blue-400')}
                            ${App.ui.statBlock('cav','C','text-green-400')}
                            ${App.ui.statBlock('arc','A','text-red-400')}
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded">${btn}</button>
                    </form>
                `,

                statBlock: (type, label, color) => `
                    <div class="bg-slate-900 p-2 rounded">
                        <div class="text-xs font-bold ${color} mb-1 text-center">${label}</div>
                        <input type="number" step="0.1" onchange="State.form.stats.${type}.att=this.value" placeholder="Att%" class="input-field text-xs p-1 text-center mb-1" value="${State.form.stats[type].att||''}">
                        <input type="number" step="0.1" onchange="State.form.stats.${type}.def=this.value" placeholder="Def%" class="input-field text-xs p-1 text-center mb-1" value="${State.form.stats[type].def||''}">
                        <input type="number" step="0.1" onchange="State.form.stats.${type}.let=this.value" placeholder="Let%" class="input-field text-xs p-1 text-center mb-1" value="${State.form.stats[type].let||''}">
                        <input type="number" step="0.1" onchange="State.form.stats.${type}.hp=this.value" placeholder="HP%" class="input-field text-xs p-1 text-center" value="${State.form.stats[type].hp||''}">
                    </div>
                `,

                initEditor: () => {}
            },

            filterKingdom: (val) => {
                State.filters.kingdom = val.trim();
                App.loadData('global');
            },

            createAlliance: async () => {
                const tag = document.getElementById('create-tag').value.trim().toUpperCase();
                const name = document.getElementById('create-name').value.trim();
                if(!tag || !name) return App.ui.toast("Missing fields", "error");
                
                try {
                    const code = Math.floor(10000 + Math.random() * 90000).toString();
                    const ref = await setDoc(doc(collection(App.db, 'alliances')), { tag, name, kingdom: State.profile.kingdom, accessCode: code, leader: State.user.uid, createdAt: serverTimestamp() });
                    await updateDoc(doc(App.db, 'profiles', State.user.uid), { allianceID: ref.id });
                    window.location.reload();
                } catch(e) { App.ui.toast("Error: " + e.message, "error"); }
            },

            joinAlliance: async () => {
                const tag = document.getElementById('join-tag').value.trim().toUpperCase();
                const code = document.getElementById('join-code').value.trim();
                
                try {
                    const q = query(collection(App.db, 'alliances'), where('tag', '==', tag));
                    const snap = await getDocs(q);
                    if(snap.empty) return App
