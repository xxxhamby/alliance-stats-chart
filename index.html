<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alliance Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-field { background: #334155; border: 1px solid #475569; color: white; padding: 0.8rem; border-radius: 0.5rem; width: 100%; margin-bottom: 0.5rem; }
        /* Scrollbar styling for the table container */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="app-root" class="min-h-screen flex flex-col"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const CONFIG = {
            apiKey: "AIzaSyCmFXqV1rp1G3xbfCE368R9rw5G7ZPjPeQ",
            authDomain: "alliance-stats-96973.firebaseapp.com",
            projectId: "alliance-stats-96973",
            storageBucket: "alliance-stats-96973.firebasestorage.app",
            messagingSenderId: "866174182881",
            appId: "1:866174182881:web:aef54fc8da562d8b_541ea0"
        };

        // --- STATE ---
        const State = {
            current: 'loading',
            user: null,    // Auth Object
            dbUser: null,  // Firestore User Doc (Role)
            profile: null, // Public Profile
            leaderboard: [],
            // UPDATED: Nested structure for Tier + True Gold
            survey: { 
                inf: { tier: 10, tg: 0 }, 
                cav: { tier: 10, tg: 0 }, 
                arc: { tier: 10, tg: 0 } 
            }
        };

        // --- APP ENGINE ---
        const App = {
            db: null,
            auth: null,

            init: () => {
                const app = initializeApp(CONFIG);
                App.db = getFirestore(app);
                App.auth = getAuth(app);
                onAuthStateChanged(App.auth, App.handleAuth);
            },

            handleAuth: async (user) => {
                State.user = user;
                if (!user) {
                    State.current = 'login';
                } else {
                    try {
                        // 1. Fetch User Role
                        const userSnap = await getDoc(doc(App.db, 'users', user.uid));
                        if (userSnap.exists()) {
                            State.dbUser = userSnap.data();
                        } else {
                            // First time login - Create User Doc
                            await setDoc(doc(App.db, 'users', user.uid), {
                                email: user.email,
                                role: 'member', // Default role
                                createdAt: serverTimestamp()
                            });
                            State.dbUser = { role: 'member' };
                        }

                        // 2. Fetch Public Profile
                        const profileSnap = await getDoc(doc(App.db, 'profiles', user.uid));
                        if (!profileSnap.exists()) {
                            State.current = 'register';
                        } else {
                            State.profile = profileSnap.data();
                            await App.actions.loadLeaderboard();
                            State.current = 'dashboard';
                        }
                    } catch (e) {
                        console.error("Boot Error", e);
                        App.ui.toast("Failed to load profile", "error");
                    }
                }
                App.render();
            },

            // --- UI RENDERER (Template Literals) ---
            render: () => {
                const views = {
                    loading: `
                        <div class="flex flex-col items-center justify-center h-screen bg-slate-900 text-white">
                            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                            <h2 class="font-bold tracking-widest">LOADING COMMAND...</h2>
                        </div>`,

                    login: `
                        <div class="flex flex-col items-center justify-center h-screen bg-slate-900 p-4">
                            <div class="bg-slate-800 p-8 rounded-lg shadow-xl max-w-sm w-full text-center border-t-4 border-blue-500">
                                <h1 class="text-2xl font-bold text-white mb-2">Alliance Command</h1>
                                <p class="text-slate-400 mb-6 text-sm">Secure Data Terminal</p>
                                <button onclick="window.triggerLogin()" class="w-full bg-white hover:bg-gray-100 text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-2 transition">
                                    <i class="fab fa-google text-red-500"></i> Sign in
                                </button>
                            </div>
                        </div>`,

                    register: `
                        <div class="flex flex-col items-center justify-center min-h-screen bg-slate-900 p-4">
                            <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-lg w-full border-t-4 border-yellow-500">
                                <h2 class="text-xl font-bold text-white mb-4">Commander Registration</h2>
                                <form onsubmit="event.preventDefault(); window.triggerRegister()">
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div class="col-span-2">
                                            <label class="text-xs text-slate-400 uppercase font-bold">In-Game Name</label>
                                            <input type="text" id="reg-ign" class="input-field" required>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-400 uppercase font-bold">Kingdom #</label>
                                            <input type="number" id="reg-kingdom" class="input-field" required>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-400 uppercase font-bold">Player ID</label>
                                            <input type="number" id="reg-pid" class="input-field" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-6 p-4 bg-slate-900 rounded border border-slate-700">
                                        <h3 class="text-sm font-bold text-white mb-3">Troop Capability</h3>
                                        <div class="grid grid-cols-3 gap-2 text-xs">
                                            <div class="text-center">
                                                <div class="mb-1 text-blue-400 font-bold">Infantry</div>
                                                ${App.ui.tierSelect('inf')}
                                            </div>
                                            <div class="text-center">
                                                <div class="mb-1 text-green-400 font-bold">Cavalry</div>
                                                ${App.ui.tierSelect('cav')}
                                            </div>
                                            <div class="text-center">
                                                <div class="mb-1 text-red-400 font-bold">Archer</div>
                                                ${App.ui.tierSelect('arc')}
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded">Confirm Profile</button>
                                </form>
                            </div>
                        </div>`,

                    dashboard: `
                        <div class="min-h-screen bg-slate-900 text-slate-200">
                            <nav class="bg-slate-800 border-b border-slate-700 p-4 flex justify-between items-center sticky top-0 z-10">
                                <div>
                                    <h1 class="font-bold text-white"><i class="fas fa-chess-rook text-blue-500 mr-2"></i>COMMAND</h1>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right hidden md:block">
                                        <div class="text-xs text-slate-400 uppercase">Commander</div>
                                        <div class="font-bold text-white text-sm">${State.profile?.ign || 'Unknown'}</div>
                                    </div>
                                    <button onclick="window.triggerLogout()" class="text-slate-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
                                </div>
                            </nav>

                            <div class="p-4 max-w-6xl mx-auto">
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="bg-slate-800 p-4 rounded border-l-4 border-blue-500">
                                        <div class="text-xs text-slate-400 uppercase">Your Kingdom</div>
                                        <div class="text-2xl font-bold text-white">#${State.profile?.kingdom}</div>
                                    </div>
                                    <div class="bg-slate-800 p-4 rounded border-l-4 border-purple-500">
                                        <div class="text-xs text-slate-400 uppercase">Troop Focus</div>
                                        

[Image of troops formation]

                                        <div class="text-white text-sm mt-1 flex flex-col gap-1">
                                            <span class="bg-blue-900 text-blue-200 px-2 py-1 rounded text-xs w-full text-center">INF: T${State.profile?.troops?.inf.tier} ${State.profile?.troops?.inf.tg > 0 ? '+TG'+State.profile?.troops?.inf.tg : ''}</span>
                                            <span class="bg-green-900 text-green-200 px-2 py-1 rounded text-xs w-full text-center">CAV: T${State.profile?.troops?.cav.tier} ${State.profile?.troops?.cav.tg > 0 ? '+TG'+State.profile?.troops?.cav.tg : ''}</span>
                                        </div>
                                    </div>
                                    <div class="bg-slate-800 p-4 rounded border-l-4 border-yellow-500 flex items-center justify-between">
                                        <div>
                                            <div class="text-xs text-slate-400 uppercase">Role</div>
                                            <div class="font-bold text-yellow-400">${State.dbUser?.role.toUpperCase()}</div>
                                        </div>
                                        ${State.dbUser?.role === 'owner' ? `<button class="bg-red-600 text-white text-xs px-3 py-1 rounded opacity-50 cursor-not-allowed">ADMIN (WIP)</button>` : ''}
                                    </div>
                                </div>

                                <div class="bg-slate-800 rounded shadow overflow-hidden">
                                    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                                        <h3 class="font-bold text-white">Global Commander Index</h3>
                                        <button onclick="App.actions.loadLeaderboard()" class="text-xs text-blue-400 hover:text-white"><i class="fas fa-sync"></i> Refresh</button>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-sm">
                                            <thead class="bg-slate-700 text-slate-400 uppercase text-xs">
                                                <tr>
                                                    <th class="p-3">Player</th>
                                                    <th class="p-3">Kingdom</th>
                                                    <th class="p-3">Troop Tech</th>
                                                    <th class="p-3">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-700">
                                                ${App.ui.renderRows()}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`
                };

                document.getElementById('app-root').innerHTML = views[State.current];
            },

            // --- UI HELPERS ---
            ui: {
                toast: (msg, type = 'info') => {
                    const el = document.createElement('div');
                    el.className = `bg-slate-800 text-white py-2 px-4 rounded shadow-lg mb-2 border-l-4 ${type === 'error' ? 'border-red-500' : 'border-green-500'} animate-bounce`;
                    el.innerText = msg;
                    document.getElementById('toast-container').appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                },

                // NEW: Generates the Tier + TG selectors
                tierSelect: (type) => `
                    <div class="flex gap-2 mt-1">
                        <div class="w-1/2">
                            <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Tier</label>
                            <select onchange="window.setTroopData('${type}', 'tier', this.value)" 
                                    class="w-full bg-slate-800 border border-slate-600 text-white text-xs rounded p-2 outline-none focus:border-blue-500">
                                <option value="11">T11</option>
                                <option value="10" selected>T10</option>
                                <option value="9">T9</option>
                                <option value="8">T8</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="text-[10px] text-yellow-500 uppercase font-bold block mb-1">True Gold</label>
                            <select onchange="window.setTroopData('${type}', 'tg', this.value)" 
                                    class="w-full bg-slate-800 border border-slate-600 text-yellow-400 text-xs rounded p-2 outline-none focus:border-yellow-500">
                                <option value="0" selected>None</option>
                                <option value="1">TG 1</option>
                                <option value="2">TG 2</option>
                                <option value="3">TG 3</option>
                                <option value="4">TG 4</option>
                                <option value="5">TG 5</option>
                            </select>
                        </div>
                    </div>
                `,

                renderRows: () => {
                    if (State.leaderboard.length === 0) return `<tr><td colspan="4" class="p-4 text-center text-slate-500">No Data Found</td></tr>`;
                    return State.leaderboard.map(p => {
                        // Safe check in case old data exists
                        const t = p.troops || { inf: {tier:10, tg:0}, cav: {tier:10, tg:0}, arc: {tier:10, tg:0} };
                        return `
                        <tr class="hover:bg-slate-700 transition border-b border-slate-700 last:border-0">
                            <td class="p-3">
                                <div class="font-bold text-white text-sm">${p.ign}</div>
                                <div class="text-[10px] text-slate-500 font-mono">ID: ${p.pid}</div>
                            </td>
                            <td class="p-3 text-slate-300 text-sm">${p.kingdom}</td>
                            <td class="p-3">
                                <div class="grid grid-cols-1 gap-1">
                                    <div class="flex justify-between text-xs bg-slate-900/50 p-1 rounded border border-slate-700">
                                        <span class="text-blue-400 font-bold">INF</span>
                                        <span>T${t.inf.tier} <span class="text-yellow-500 text-[10px]">${t.inf.tg > 0 ? 'TG'+t.inf.tg : ''}</span></span>
                                    </div>
                                    <div class="flex justify-between text-xs bg-slate-900/50 p-1 rounded border border-slate-700">
                                        <span class="text-green-400 font-bold">CAV</span>
                                        <span>T${t.cav.tier} <span class="text-yellow-500 text-[10px]">${t.cav.tg > 0 ? 'TG'+t.cav.tg : ''}</span></span>
                                    </div>
                                    <div class="flex justify-between text-xs bg-slate-900/50 p-1 rounded border border-slate-700">
                                        <span class="text-red-400 font-bold">ARC</span>
                                        <span>T${t.arc.tier} <span class="text-yellow-500 text-[10px]">${t.arc.tg > 0 ? 'TG'+t.arc.tg : ''}</span></span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-3"><span class="bg-green-900 text-green-300 px-2 py-1 rounded text-[10px] font-bold">ACTIVE</span></td>
                        </tr>
                    `}).join('');
                }
            },

            // --- ACTIONS ---
            actions: {
                loadLeaderboard: async () => {
                    try {
                        // Added sorting by Kingdom to group neighbors together
                        const q = query(collection(App.db, 'profiles'), orderBy('kingdom', 'asc'), limit(50)); 
                        const snap = await getDocs(q);
                        State.leaderboard = snap.docs.map(d => d.data());
                    } catch (e) { console.error("Leaderboard Error", e); }
                },

                register: async (data) => {
                    try {
                        // Create Profile
                        await setDoc(doc(App.db, 'profiles', State.user.uid), {
                            ign: data.ign,
                            kingdom: data.kingdom,
                            pid: data.pid,
                            troops: State.survey,
                            allianceID: null,
                            updatedAt: serverTimestamp()
                        });
                        
                        // Update Local State
                        State.profile = { ign: data.ign, kingdom: data.kingdom, pid: data.pid, troops: State.survey };
                        await App.actions.loadLeaderboard();
                        State.current = 'dashboard';
                        App.render();
                        App.ui.toast("Profile Created");
                    } catch (e) {
                        console.error(e);
                        App.ui.toast("Registration Failed: " + e.message, "error");
                    }
                }
            }
        };

        // --- GLOBAL EXPORTS (For HTML Events) ---
        window.triggerLogin = () => signInWithPopup(App.auth, new GoogleAuthProvider());
        window.triggerLogout = () => signOut(App.auth).then(() => window.location.reload());
        
        // NEW DATA HANDLER
        window.setTroopData = (type, field, val) => {
            // type = 'inf', field = 'tier' or 'tg', val = '10'
            State.survey[type][field] = parseInt(val);
            // No render needed, native select handles visual state
        };

        window.triggerRegister = () => {
            const ign = document.getElementById('reg-ign').value;
            const kingdom = document.getElementById('reg-kingdom').value;
            const pid = document.getElementById('reg-pid').value;
            if(!ign || !kingdom || !pid) return alert("Fill all fields");
            App.actions.register({ ign, kingdom, pid });
        };

        // START
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
